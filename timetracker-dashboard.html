<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Time Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: #3b82f6;
            outline: none;
        }

        .mono-font {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center">

    <!-- Main Container -->
    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column: Info & Timer -->
        <div class="space-y-6 lg:col-span-1">
            
            <!-- Date & Weather Widget -->
            <div class="glass rounded-2xl p-6 shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-50 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="fetchWeather()">
                    <i data-lucide="refresh-cw" class="w-4 h-4 text-white"></i>
                </div>
                
                <div class="flex flex-col">
                    <h2 class="text-gray-400 text-sm font-semibold uppercase tracking-wider mb-1">Today</h2>
                    <div id="clock-time" class="text-5xl font-bold text-white tracking-tight mono-font mb-2">00:00</div>
                    <div id="clock-date" class="text-lg text-blue-300 font-medium">Loading...</div>
                </div>

                <div class="mt-6 pt-6 border-t border-white/10 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div id="weather-icon" class="text-yellow-400">
                            <i data-lucide="cloud" class="w-8 h-8"></i>
                        </div>
                        <div>
                            <div id="weather-temp" class="text-2xl font-bold">--Â°C</div>
                            <div id="weather-desc" class="text-xs text-gray-400">Locating...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Day Timeline Widget -->
            <div class="glass rounded-2xl p-6 shadow-xl">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Day Progress</h3>
                    <span id="timeline-status" class="text-xs font-medium text-blue-300">Loading...</span>
                </div>
                
                <div class="relative h-4 bg-gray-900/50 rounded-full w-full overflow-hidden flex border border-white/5">
                    <!-- Pre-work (00:00 - 09:00) -->
                    <div class="h-full bg-slate-700/30 w-[37.5%]" title="Before Work"></div>
                    <!-- Work (09:00 - 17:00) -->
                    <div class="h-full bg-gradient-to-r from-blue-600/40 to-purple-600/40 w-[33.33%] border-x border-white/10 relative" title="Work Hours"></div>
                    <!-- Post-work (17:00 - 24:00) -->
                    <div class="h-full bg-slate-700/30 flex-1" title="After Work"></div>
                </div>
                
                <!-- Marker Layer (Separate container to match width perfectly) -->
                <div class="relative w-full h-0">
                    <div id="timeline-marker" class="absolute -top-4 w-0.5 h-4 bg-yellow-400 shadow-[0_0_8px_rgba(250,204,21,0.8)] transition-all duration-1000 z-10">
                        <div class="absolute -bottom-1 -left-[3px] w-2 h-2 bg-yellow-400 rounded-full"></div>
                    </div>
                </div>

                <!-- Labels -->
                <div class="relative w-full h-4 mt-2 text-[10px] text-gray-500 font-mono flex justify-between select-none">
                    <span>00:00</span>
                    <span class="absolute left-[37.5%] -translate-x-1/2">09:00</span>
                    <span class="absolute left-[70.83%] -translate-x-1/2">17:00</span>
                    <span>23:59</span>
                </div>
            </div>

            <!-- Time Tracker Widget -->
            <div class="glass rounded-2xl p-6 shadow-xl border-t-4 border-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="timer" class="w-5 h-5 text-blue-400"></i>
                        Task Timer
                    </h3>
                    <div class="h-2 w-2 rounded-full bg-red-500" id="timer-indicator"></div>
                </div>

                <input type="text" id="task-name" placeholder="What are you working on?" 
                    class="glass-input w-full rounded-lg px-4 py-3 mb-4 text-sm placeholder-gray-500">

                <div class="text-center py-4 bg-black/20 rounded-xl mb-4">
                    <div id="timer-display" class="text-4xl font-mono font-bold text-white">00:00:00</div>
                </div>

                <!-- Timer Controls -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button id="btn-start" onclick="toggleTimer()" 
                        class="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-medium transition flex justify-center items-center gap-2">
                        <i data-lucide="play" class="w-4 h-4"></i> Start
                    </button>
                    <button onclick="saveTimer()" 
                        class="bg-green-600/80 hover:bg-green-500 text-white py-2 rounded-lg font-medium transition flex justify-center items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Save
                    </button>
                    <button onclick="resetTimer()" 
                        class="bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg font-medium transition flex justify-center items-center gap-2">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset
                    </button>
                </div>

                <!-- History Section -->
                <div class="pt-4 border-t border-white/10 mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">History</h4>
                        <button onclick="clearHistory()" class="text-[10px] text-red-400/60 hover:text-red-400 transition">Clear All</button>
                    </div>
                    <div id="history-list" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                        <!-- History Items Injected Here -->
                        <p class="text-center text-xs text-gray-600 py-2">No saved timers yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Dashboard Links -->
        <div class="lg:col-span-2 space-y-6 flex flex-col h-full">
            
            <!-- Quick Links Section -->
            <div class="glass rounded-2xl p-6 shadow-xl flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Dashboard</h1>
                        <p class="text-sm text-gray-400">Quick access to Jira loggings</p>
                    </div>
                    <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-white/10 transition text-gray-400 hover:text-white">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Links Grid -->
                <div id="links-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Links injected via JS -->
                </div>

                <!-- Empty State (if no links) -->
                <div id="empty-state" class="hidden flex-col items-center justify-center py-12 text-gray-500">
                    <i data-lucide="ghost" class="w-12 h-12 mb-3 opacity-50"></i>
                    <p>No links configured.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal Overlay -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-2xl rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="sliders" class="w-5 h-5 text-purple-400"></i> Settings
                </h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                
                <!-- Base URL Config -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Jira Base URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="setting-base-url" placeholder="https://yourcompany.atlassian.net" 
                            class="glass-input flex-1 rounded-lg px-4 py-2 text-sm">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Used to construct full paths from partial links.</p>
                </div>

                <!-- Link Editor -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-sm font-medium text-gray-300">Manage Links</label>
                        <button onclick="addNewLinkInput()" class="text-xs bg-green-600/20 text-green-400 px-2 py-1 rounded hover:bg-green-600/30 transition">
                            + Add New
                        </button>
                    </div>
                    
                    <div id="settings-links-list" class="space-y-3">
                        <!-- Link inputs injected here -->
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="pt-6 border-t border-white/10">
                    <button onclick="restoreDefaults()" class="text-sm text-red-400 hover:text-red-300 underline">
                        Restore Default Links
                    </button>
                </div>
            </div>

            <div class="p-6 bg-black/20 border-t border-white/10 flex justify-end gap-3">
                <button onclick="toggleSettings()" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-white/5 transition">Cancel</button>
                <button onclick="saveSettings()" class="px-6 py-2 rounded-lg text-sm font-medium bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/20 transition">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2"></div>

    <script>
        // --- State Management ---
        const DEFAULT_LINKS = [
            { 
                id: '1', 
                title: 'Recent Issues', 
                desc: 'Assigned to me & updated recently', 
                url: 'https://qover001.atlassian.net/issues?jql=updated%20%3E%3D%20-1w%20AND%20assignee%20%3D%20currentUser()%20ORDER%20BY%20updated%20DESC', 
                icon: 'clock', 
                color: 'text-blue-400' 
            },
            { 
                id: '2', 
                title: 'Log Holiday', 
                desc: 'Log time to General Holiday code (PRJ-859)', 
                url: 'https://qover001.atlassian.net/browse/PRJ-859', 
                icon: 'palmtree', 
                color: 'text-green-400' 
            },
            { 
                id: '3', 
                title: 'Admin Tasks', 
                desc: 'Meetings, emails, overhead (PRJ-861)', 
                url: 'https://qover001.atlassian.net/browse/PRJ-861', 
                icon: 'briefcase', 
                color: 'text-purple-400' 
            },
            { 
                id: '4', 
                title: 'Create Ticket', 
                desc: 'Start a new issue', 
                url: 'https://qover001.atlassian.net/secure/CreateIssue!default.jspa', 
                icon: 'plus-circle', 
                color: 'text-pink-400' 
            }
        ];

        let state = {
            baseUrl: localStorage.getItem('jira_dash_base_url') || '',
            links: JSON.parse(localStorage.getItem('jira_dash_links')) || DEFAULT_LINKS,
            timer: {
                running: false,
                startTime: 0,
                accumulated: 0,
                intervalId: null
            },
            history: JSON.parse(localStorage.getItem('jira_dash_history')) || []
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            renderLinks();
            renderHistory();
            fetchWeather();
            lucide.createIcons();
        });

        // --- Clock & Weather & Timeline ---
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            document.getElementById('clock-time').textContent = timeStr;
            document.getElementById('clock-date').textContent = dateStr;

            updateTimeline(now);
        }

        function updateTimeline(now) {
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const totalMinutes = (hours * 60) + minutes;
            // 1440 minutes in a day
            const percentage = (totalMinutes / 1440) * 100;
            
            const marker = document.getElementById('timeline-marker');
            const statusEl = document.getElementById('timeline-status');
            
            if(marker) marker.style.left = `${percentage}%`;

            if(statusEl) {
                if (hours >= 9 && hours < 17) {
                    statusEl.textContent = "Work Time ðŸ’¼";
                    statusEl.className = "text-xs font-medium text-green-400";
                } else if (hours < 9) {
                    statusEl.textContent = "Morning ðŸŒ…";
                    statusEl.className = "text-xs font-medium text-blue-300";
                } else {
                    statusEl.textContent = "Personal Time ðŸŒ™";
                    statusEl.className = "text-xs font-medium text-purple-300";
                }
            }
        }

        async function fetchWeather() {
            const descEl = document.getElementById('weather-desc');
            const tempEl = document.getElementById('weather-temp');
            
            descEl.textContent = 'Locating...';

            if (!navigator.geolocation) {
                descEl.textContent = 'Geo not supported';
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                try {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const data = await response.json();
                    
                    if(data.current_weather) {
                        const temp = Math.round(data.current_weather.temperature);
                        const code = data.current_weather.weathercode;
                        
                        tempEl.textContent = `${temp}Â°C`;
                        descEl.textContent = getWeatherDescription(code);
                    }
                } catch (e) {
                    descEl.textContent = 'Weather Error';
                }
            }, () => {
                descEl.textContent = 'Location Denied';
            });
        }

        function getWeatherDescription(code) {
            // Simple mapping for WMO codes
            if(code === 0) return 'Clear Sky';
            if(code >= 1 && code <= 3) return 'Partly Cloudy';
            if(code >= 45 && code <= 48) return 'Foggy';
            if(code >= 51 && code <= 67) return 'Raining';
            if(code >= 71) return 'Snowing';
            return 'Weather';
        }

        // --- Link Logic ---
        function getFullUrl(url) {
            if (url.startsWith('http')) return url;
            const base = state.baseUrl.replace(/\/$/, '');
            const path = url.replace(/^\//, '');
            return base ? `${base}/${path}` : url;
        }

        function renderLinks() {
            const container = document.getElementById('links-grid');
            container.innerHTML = '';

            if (state.links.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('flex');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('flex');
            }

            state.links.forEach(link => {
                const fullUrl = getFullUrl(link.url);
                const card = document.createElement('a');
                card.href = fullUrl;
                card.target = "_blank";
                card.className = "glass-panel p-5 rounded-xl hover:bg-white/5 transition group flex flex-col justify-between h-32 border-l-4 border-transparent hover:border-blue-500 relative overflow-hidden";
                
                card.innerHTML = `
                    <div class="absolute top-0 right-0 p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="external-link" class="w-4 h-4 text-gray-500"></i>
                    </div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="${link.color}">
                            <i data-lucide="${link.icon || 'link'}" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-100 truncate">${link.title}</h3>
                    </div>
                    <p class="text-sm text-gray-400 line-clamp-2">${link.desc}</p>
                `;
                container.appendChild(card);
            });

            lucide.createIcons();
        }

        // --- Timer Logic ---
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        }

        function toggleTimer() {
            const btn = document.getElementById('btn-start');
            const indicator = document.getElementById('timer-indicator');
            const display = document.getElementById('timer-display');

            if (state.timer.running) {
                // Stop
                clearInterval(state.timer.intervalId);
                state.timer.running = false;
                state.timer.accumulated += Date.now() - state.timer.startTime;
                
                document.title = `${formatTime(state.timer.accumulated)} (Paused)`; // Update title on pause

                btn.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i> Resume`;
                btn.className = "bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-medium transition flex justify-center items-center gap-2";
                indicator.className = "h-2 w-2 rounded-full bg-red-500";
                
            } else {
                // Start
                state.timer.startTime = Date.now();
                state.timer.running = true;
                
                state.timer.intervalId = setInterval(() => {
                    const currentDelta = Date.now() - state.timer.startTime;
                    const total = state.timer.accumulated + currentDelta;
                    const formatted = formatTime(total);
                    display.textContent = formatted;
                    document.title = `${formatted} â–¶ Jira Timer`; // Update title while running
                }, 1000);

                btn.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i> Pause`;
                btn.className = "bg-yellow-600 hover:bg-yellow-500 text-white py-2 rounded-lg font-medium transition flex justify-center items-center gap-2";
                indicator.className = "h-2 w-2 rounded-full bg-green-500 animate-pulse";
            }
            lucide.createIcons();
        }

        function resetTimer() {
            if(state.timer.running) toggleTimer(); // stop first
            state.timer.accumulated = 0;
            document.getElementById('timer-display').textContent = "00:00:00";
            document.title = "Jira Time Dashboard"; // Reset title to default
            document.getElementById('btn-start').innerHTML = `<i data-lucide="play" class="w-4 h-4"></i> Start`;
            // Keep task name usually, but user can clear it manually if they want
            lucide.createIcons();
        }

        function saveTimer() {
            // Calculate current total
            let total = state.timer.accumulated;
            if (state.timer.running) {
                total += Date.now() - state.timer.startTime;
            }

            if (total < 1000) {
                showToast("Timer is empty", true);
                return;
            }

            const task = document.getElementById('task-name').value || "Untitled Task";
            const timeStr = formatTime(total);
            const rawTime = total;
            
            // Format nice string: "1h 30m"
            const parts = timeStr.split(':');
            const h = parseInt(parts[0]);
            const m = parseInt(parts[1]);
            const shortTime = `${h > 0 ? h+'h ' : ''}${m}m`;

            const entry = {
                id: Date.now(),
                task,
                timeStr,
                shortTime,
                rawTime,
                date: new Date().toLocaleDateString()
            };

            state.history.unshift(entry); // Add to top
            localStorage.setItem('jira_dash_history', JSON.stringify(state.history));
            
            resetTimer(); // Stop and reset
            document.getElementById('task-name').value = ''; // Clear task name
            
            renderHistory();
            showToast("Timer saved to history");
        }

        function deleteHistoryItem(id) {
            state.history = state.history.filter(item => item.id !== id);
            localStorage.setItem('jira_dash_history', JSON.stringify(state.history));
            renderHistory();
        }

        function clearHistory() {
            if(confirm("Clear all history?")) {
                state.history = [];
                localStorage.setItem('jira_dash_history', JSON.stringify(state.history));
                renderHistory();
            }
        }

        function copyHistoryItem(text) {
             const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(`Copied!`);
            } catch (err) {
                showToast("Failed to copy", true);
            }
            document.body.removeChild(textArea);
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            if (state.history.length === 0) {
                list.innerHTML = `<p class="text-center text-xs text-gray-500 py-4 italic">No saved timers</p>`;
                return;
            }

            state.history.forEach(item => {
                const copyText = `${item.shortTime} - ${item.task}`;
                
                const div = document.createElement('div');
                div.className = "bg-white/5 p-3 rounded-lg flex items-center justify-between group hover:bg-white/10 transition border border-white/5";
                div.innerHTML = `
                    <div class="overflow-hidden mr-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-mono font-bold text-blue-300 bg-blue-500/10 px-1.5 rounded">${item.timeStr}</span>
                            <span class="text-[10px] text-gray-500">${item.date}</span>
                        </div>
                        <div class="text-sm font-medium text-gray-200 truncate" title="${item.task}">${item.task}</div>
                    </div>
                    <div class="flex items-center gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                        <button onclick="copyHistoryItem('${copyText}')" class="p-1.5 hover:bg-white/10 rounded text-gray-300 hover:text-white" title="Copy for Jira">
                            <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                        </button>
                        <button onclick="deleteHistoryItem(${item.id})" class="p-1.5 hover:bg-red-500/20 rounded text-gray-400 hover:text-red-400" title="Delete">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- Settings Logic ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isOpen = !modal.classList.contains('hidden');
            
            if (isOpen) {
                modal.classList.add('hidden');
            } else {
                // Load values into inputs
                document.getElementById('setting-base-url').value = state.baseUrl;
                renderSettingsLinks();
                modal.classList.remove('hidden');
            }
        }

        function renderSettingsLinks() {
            const container = document.getElementById('settings-links-list');
            container.innerHTML = '';
            
            state.links.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = "bg-white/5 p-3 rounded-lg border border-white/10 flex flex-col gap-2";
                div.innerHTML = `
                    <div class="flex gap-2">
                        <input type="text" placeholder="Title" value="${link.title}" class="glass-input w-1/3 p-1 rounded text-sm link-title-input">
                        <input type="text" placeholder="URL (/browse/KEY-123)" value="${link.url}" class="glass-input flex-1 p-1 rounded text-sm link-url-input">
                        <button onclick="removeLink(${index})" class="text-red-400 hover:bg-white/10 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <input type="text" placeholder="Description" value="${link.desc}" class="glass-input w-full p-1 rounded text-xs text-gray-400 link-desc-input">
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function addNewLinkInput() {
            state.links.push({ title: 'New Link', desc: 'Description', url: '', icon: 'link', color: 'text-gray-400' });
            renderSettingsLinks();
        }

        function removeLink(index) {
            state.links.splice(index, 1);
            renderSettingsLinks();
        }

        function restoreDefaults() {
            if(confirm("Reset all links to default? This cannot be undone.")) {
                state.links = JSON.parse(JSON.stringify(DEFAULT_LINKS));
                renderSettingsLinks();
                showToast("Defaults restored");
            }
        }

        function saveSettings() {
            // Base URL
            state.baseUrl = document.getElementById('setting-base-url').value;
            
            // Gather Links from DOM inputs
            const linkContainers = document.getElementById('settings-links-list').children;
            const newLinks = [];
            
            Array.from(linkContainers).forEach((div, idx) => {
                const title = div.querySelector('.link-title-input').value;
                const url = div.querySelector('.link-url-input').value;
                const desc = div.querySelector('.link-desc-input').value;
                // Preserve icon/color if exists, else default
                const existing = state.links[idx] || {};
                
                if (title && url) {
                    newLinks.push({
                        id: Date.now().toString() + Math.random(),
                        title,
                        url,
                        desc,
                        icon: existing.icon || 'link',
                        color: existing.color || 'text-gray-400'
                    });
                }
            });

            state.links = newLinks;

            // Persist
            localStorage.setItem('jira_dash_base_url', state.baseUrl);
            localStorage.setItem('jira_dash_links', JSON.stringify(state.links));

            renderLinks();
            toggleSettings();
            showToast("Settings saved successfully");
        }

        // --- Toast Notification ---
        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast-enter glass-panel px-4 py-3 rounded-lg border-l-4 ${isError ? 'border-red-500' : 'border-green-500'} flex items-center gap-3 shadow-lg`;
            el.innerHTML = `
                <i data-lucide="${isError ? 'alert-circle' : 'check-circle'}" class="w-4 h-4 ${isError ? 'text-red-400' : 'text-green-400'}"></i>
                <span class="text-sm font-medium">${message}</span>
            `;
            container.appendChild(el);
            lucide.createIcons();

            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(10px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

    </script>
</body>
</html>