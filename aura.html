<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura - Your Personal Mind Garden</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body and Font Styling */
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden; /* Prevents scrollbars from appearing */
        }

        /* 3D Garden Container */
        #garden-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        canvas {
            display: block; /* Removes default canvas margin */
        }

        /* UI Panel Styling for Planting */
        .ui-panel {
            position: fixed;
            top: 150%; /* Start hidden way below */
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 21; /* Higher than other modals */
            transition: top 0.5s ease-in-out;
        }

        .ui-panel.visible {
            top: 50%; /* Center it on screen */
        }
        
        .ui-panel.visible + #toggle-panel-btn {
            opacity: 0;
            pointer-events: none;
        }

        .ui-panel h2 {
            margin-top: 0;
            font-weight: 700;
            text-align: center;
            color: #eee;
        }

        .ui-panel input, .ui-panel textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        .ui-panel input::placeholder, .ui-panel textarea::placeholder {
            color: #aaa;
        }

        .ui-panel button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ui-panel button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Toggle Button for UI Panel */
        #toggle-panel-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #2575fc, #6a11cb);
            color: #fff;
            font-size: 36px;
            line-height: 60px;
            text-align: center;
            cursor: pointer;
            z-index: 11;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #toggle-panel-btn.rotated {
            transform: translateX(-50%) rotate(135deg);
        }

        /* Modal Styling */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .modal-content {
            background: rgba(20, 20, 20, 0.8);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: fadeIn 0.3s ease;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-content .close-btn:hover {
            color: #fff;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #fff;
        }

        .modal-content p {
            color: #ccc;
            line-height: 1.6;
        }
        
        #modal-details-textarea, #api-key-input {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            resize: vertical;
        }
        #api-key-input { min-height: auto; }

        #modal-status {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 5px;
        }

        #modal-status.pending {
            background-color: #ffc107;
            color: #333;
        }

        #modal-status.completed {
            background-color: #28a745;
            color: #fff;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #complete-task-btn { background: #28a745; }
        #complete-task-btn:hover { background-color: #218838; }
        #complete-task-btn:disabled { background-color: #555; cursor: not-allowed; }

        #connect-task-btn { background: #007bff; }
        #connect-task-btn:hover { background-color: #0056b3; }
        #connect-task-btn:disabled { background-color: #555; cursor: not-allowed; }

        #nurture-task-btn { background: #17a2b8; }
        #nurture-task-btn:hover { background-color: #117a8b; }
        
        #save-nurture-btn { background: #17a2b8; }
        #save-nurture-btn:hover { background-color: #117a8b; }
        
        #ai-assist-btn { background: linear-gradient(45deg, #ff6b6b, #feca57); }
        #ai-assist-btn:hover { opacity: 0.9; }
        #ai-assist-btn:disabled { background: #555; cursor: not-allowed; }
        
        #save-api-key-btn { background: #007bff; }
        
        .api-help {
            font-size: 12px;
            color: #aaa;
            text-align: center;
            margin-top: 5px;
            min-height: auto !important;
        }
        .api-help a {
            color: #00aaff;
            text-decoration: none;
        }
        .api-help a:hover {
            text-decoration: underline;
        }
        
        .settings-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #time-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        #reset-time-btn {
            width: 100%;
            background: #6c757d;
        }
        
        #task-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        #task-list li {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #task-list li:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        #task-list li.completed {
            text-decoration: line-through;
            color: #888;
        }


        /* Location and Time Info */
        .location-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 5;
            text-align: left;
        }

        .location-info p {
            margin: 0;
            font-size: 14px;
        }
        
        /* Top Right Buttons */
        .top-right-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 12;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
        }
        
        #settings-btn:hover {
            transform: rotate(45deg);
        }
        #list-btn:hover {
            transform: scale(1.1);
        }
        
        /* Saving/Connecting Indicator */
        .indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 8px;
            z-index: 5;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        
        .indicator.visible {
            opacity: 1;
        }
        
        #cancel-connection-btn {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: #dc3545;
            color: white;
            z-index: 12;
            cursor: pointer;
            display: none; /* Hidden by default */
        }


        /* Loader Styling */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.5s ease;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #6a11cb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .loader-container p {
            margin-top: 20px;
            font-size: 16px;
            color: #aaa;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- The 3D canvas will be injected here by Three.js -->
    <div id="garden-container"></div>

    <!-- Loading Spinner -->
    <div id="loader" class="loader-container">
        <div class="spinner"></div>
        <p>Tending to your garden...</p>
    </div>

    <!-- UI Panel for adding new tasks -->
    <div id="ui-panel" class="ui-panel">
        <span class="close-btn">&times;</span>
        <h2>Plant a New Thought</h2>
        <input type="text" id="task-title" placeholder="What's on your mind?">
        <textarea id="task-details" placeholder="Add more details... (longer details grow bigger plants)"></textarea>
        <button id="add-task-btn">Plant Seed</button>
    </div>
    <button id="toggle-panel-btn">+</button>

    <!-- Modal for displaying task details -->
    <div id="task-modal" class="modal-container hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title">Task Title</h2>
            <p id="modal-details">Task details will appear here.</p>
            <textarea id="modal-details-textarea" class="hidden"></textarea>
            <p><strong>Status:</strong> <span id="modal-status">Pending</span></p>
            <div id="view-mode-buttons" class="modal-buttons">
                <button id="nurture-task-btn">Nurture</button>
                <button id="connect-task-btn">Connect</button>
                <button id="complete-task-btn">Mark as Complete</button>
            </div>
            <div id="edit-mode-buttons" class="modal-buttons hidden">
                <button id="ai-assist-btn">✨ AI Assist</button>
                <button id="save-nurture-btn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-container hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Settings</h2>
            <p>Enter your Gemini API Key to enable AI features.</p>
            <input type="password" id="api-key-input" placeholder="Your Gemini API Key">
            <p class="api-help">Get your key from <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.</p>
            <div class="modal-buttons">
                 <button id="save-api-key-btn">Save Key</button>
            </div>
            
            <div class="settings-section">
                <h2>Appearance</h2>
                <label for="time-slider">Manual Time of Day: <span id="time-slider-value">Auto</span></label>
                <input type="range" id="time-slider" min="0" max="23" step="1">
                <div class="modal-buttons">
                    <button id="reset-time-btn">Use Automatic Time</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task List Modal -->
    <div id="list-modal" class="modal-container hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>All Thoughts</h2>
            <ul id="task-list">
                <!-- Task items will be injected here -->
            </ul>
        </div>
    </div>
    
    <!-- Time and Location Display -->
    <div class="location-info">
        <p>Schaerbeek, Brussels</p>
        <p id="current-time">Loading time...</p>
    </div>
    
    <!-- Top Right Controls -->
    <div class="top-right-controls">
        <button id="list-btn" class="control-btn">📋</button>
        <button id="settings-btn" class="control-btn">⚙️</button>
    </div>
    
    <!-- Saving Indicator -->
    <div id="saving-indicator" class="indicator">
        <p>Saved.</p>
    </div>

    <!-- Connecting Indicator -->
    <div id="connecting-indicator" class="indicator">
        <p>Select another plant to connect...</p>
    </div>
    <button id="cancel-connection-btn">Cancel Connection</button>


    <!-- Three.js and Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/objects/Sky.js"></script>
    
    <!-- Main Application Logic -->
    <script>
        // =============================================================================
        // GLOBAL VARIABLES
        // =============================================================================
        let scene, camera, renderer, controls;
        let sky, sun;
        const taskObjects = []; // To hold the 3D objects
        const connectionLines = []; // To hold the vine meshes
        let gardenData = { tasks: [], connections: [] }; // All data for local storage
        let gardenSettings = { apiKey: "", timeOverride: null }; // All settings
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let selectedTaskObject = null;

        // Connection state
        let isConnecting = false;
        let firstConnectionObject = null;

        // DOM Elements
        const loader = document.getElementById('loader');
        const uiPanel = document.getElementById('ui-panel');
        const togglePanelBtn = document.getElementById('toggle-panel-btn');
        const addTaskBtn = document.getElementById('add-task-btn');
        const taskTitleInput = document.getElementById('task-title');
        const taskDetailsInput = document.getElementById('task-details');
        
        const taskModal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDetails = document.getElementById('modal-details');
        const modalDetailsTextarea = document.getElementById('modal-details-textarea');
        const modalStatus = document.getElementById('modal-status');
        const viewModeButtons = document.getElementById('view-mode-buttons');
        const editModeButtons = document.getElementById('edit-mode-buttons');
        const completeTaskBtn = document.getElementById('complete-task-btn');
        const connectTaskBtn = document.getElementById('connect-task-btn');
        const nurtureTaskBtn = document.getElementById('nurture-task-btn');
        const saveNurtureBtn = document.getElementById('save-nurture-btn');
        const aiAssistBtn = document.getElementById('ai-assist-btn');
        
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const timeSlider = document.getElementById('time-slider');
        const timeSliderValue = document.getElementById('time-slider-value');
        const resetTimeBtn = document.getElementById('reset-time-btn');
        
        const listBtn = document.getElementById('list-btn');
        const listModal = document.getElementById('list-modal');
        const taskList = document.getElementById('task-list');
        
        const timeDisplay = document.getElementById('current-time');
        const savingIndicator = document.getElementById('saving-indicator');
        const connectingIndicator = document.getElementById('connecting-indicator');
        const cancelConnectionBtn = document.getElementById('cancel-connection-btn');

        // =============================================================================
        // INITIALIZATION
        // =============================================================================

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 20, 50);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.getElementById('garden-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 200;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
            scene.add(ambientLight);

            const groundGeometry = new THREE.PlaneGeometry(500, 500);
            const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x1a2a1a, roughness: 0.9, metalness: 0.1 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);
            
            // Setup all event listeners
            setupEventListeners();

            loadDataFromLocalStorage();
            loadSettingsFromLocalStorage();
            
            initSky();
            updateTime();
            setInterval(updateTime, 1000 * 60);
            
            animate();
        }
        
        function setupEventListeners() {
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('click', onDocumentMouseClick);
            togglePanelBtn.addEventListener('click', toggleUIPanel);
            addTaskBtn.addEventListener('click', handleAddTask);
            uiPanel.querySelector('.close-btn').addEventListener('click', () => uiPanel.classList.remove('visible'));
            
            // Task Modal Listeners
            taskModal.querySelector('.close-btn').addEventListener('click', () => taskModal.classList.add('hidden'));
            completeTaskBtn.addEventListener('click', handleCompleteTask);
            connectTaskBtn.addEventListener('click', handleStartConnection);
            nurtureTaskBtn.addEventListener('click', handleNurtureTask);
            saveNurtureBtn.addEventListener('click', handleSaveNurture);
            aiAssistBtn.addEventListener('click', handleAiAssist);
            cancelConnectionBtn.addEventListener('click', cancelConnection);
            
            // Settings Modal Listeners
            settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            settingsModal.querySelector('.close-btn').addEventListener('click', () => settingsModal.classList.add('hidden'));
            saveApiKeyBtn.addEventListener('click', handleSaveApiKey);
            timeSlider.addEventListener('input', handleTimeSliderChange);
            resetTimeBtn.addEventListener('click', handleResetTime);

            // List Modal Listeners
            listBtn.addEventListener('click', handleShowList);
            listModal.querySelector('.close-btn').addEventListener('click', () => listModal.classList.add('hidden'));
            taskList.addEventListener('click', handleListNavigation);
        }

        // =============================================================================
        // 3D SCENE & ANIMATION
        // =============================================================================

        function initSky() {
            if(sky) scene.remove(sky);
            sky = new THREE.Sky();
            sky.scale.setScalar(450000);
            scene.add(sky);
            sun = new THREE.Vector3();

            const hour = gardenSettings.timeOverride !== null 
                ? gardenSettings.timeOverride 
                : new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Brussels"})).getHours();

            const effectController = {
                turbidity: 10, rayleigh: 3, mieCoefficient: 0.005,
                mieDirectionalG: 0.7, elevation: 2, azimuth: 180,
                exposure: renderer.toneMappingExposure
            };
            if (hour > 5 && hour < 8) { effectController.elevation = 2; effectController.rayleigh = 2; }
            else if (hour >= 8 && hour < 18) { effectController.elevation = 15; effectController.rayleigh = 0.5; }
            else if (hour >= 18 && hour < 21) { effectController.elevation = 2; effectController.rayleigh = 3; effectController.turbidity = 20; }
            else { effectController.elevation = -2; effectController.rayleigh = 0.1; addStars(); }
            const uniforms = sky.material.uniforms;
            uniforms['turbidity'].value = effectController.turbidity;
            uniforms['rayleigh'].value = effectController.rayleigh;
            uniforms['mieCoefficient'].value = effectController.mieCoefficient;
            uniforms['mieDirectionalG'].value = effectController.mieDirectionalG;
            const phi = THREE.MathUtils.degToRad(90 - effectController.elevation);
            const theta = THREE.MathUtils.degToRad(effectController.azimuth);
            sun.setFromSphericalCoords(1, phi, theta);
            uniforms['sunPosition'].value.copy(sun);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(sun.x, sun.y, sun.z);
            scene.add(directionalLight);
        }

        function addStars() {
            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            for (let i = 0; i < 10000; i++) {
                starVertices.push((Math.random() - 0.5) * 2000, Math.random() * 500 + 100, (Math.random() - 0.5) * 2000);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            scene.add(new THREE.Points(starGeometry, new THREE.PointsMaterial({ color: 0xffffff, size: 0.5, transparent: true })));
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            const time = Date.now() * 0.0005;
            taskObjects.forEach(obj => {
                if (obj.userData.status !== 'completed') {
                     obj.position.y = obj.userData.originalY + Math.sin(time * obj.userData.bobSpeed) * obj.userData.bobHeight;
                }
            });
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // =============================================================================
        // TASK & CONNECTION MANAGEMENT
        // =============================================================================

        function createTaskObject(task) {
            const plantGroup = new THREE.Group();
            if (task.status === 'completed') {
                const fruit = new THREE.Mesh(new THREE.SphereGeometry(2, 32, 32), new THREE.MeshStandardMaterial({ color: 0x28a745, emissive: 0x28a745, emissiveIntensity: 0.5, roughness: 0.4 }));
                plantGroup.add(fruit);
                plantGroup.position.set(task.x, 2, task.z);
            } else {
                if (task.details.length < 50) { // Flower
                    const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 2, 8), new THREE.MeshStandardMaterial({ color: 0x006400 }));
                    const head = new THREE.Mesh(new THREE.SphereGeometry(0.7, 16, 16), new THREE.MeshStandardMaterial({ color: 0xffd700 }));
                    head.position.y = 1;
                    plantGroup.add(stem, head);
                } else { // Tree
                    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 4, 12), new THREE.MeshStandardMaterial({ color: 0x8B4513 }));
                    const canopy = new THREE.Mesh(new THREE.IcosahedronGeometry(2.5, 0), new THREE.MeshStandardMaterial({ color: 0x228B22 }));
                    canopy.position.y = 3;
                    plantGroup.add(trunk, canopy);
                }
                plantGroup.position.set(task.x, 2, task.z);
            }
            plantGroup.userData = { ...task, originalY: plantGroup.position.y, bobSpeed: Math.random() * 0.5 + 0.5, bobHeight: Math.random() * 0.2 + 0.1 };
            plantGroup.children.forEach(c => c.userData.id = task.id);
            scene.add(plantGroup);
            taskObjects.push(plantGroup);
            return plantGroup;
        }
        
        function drawVine(obj1, obj2) {
            const pos1 = obj1.position;
            const pos2 = obj2.position;
            const controlPoint = new THREE.Vector3((pos1.x + pos2.x) / 2, Math.max(pos1.y, pos2.y) + pos1.distanceTo(pos2) * 0.3, (pos1.z + pos2.z) / 2);
            const curve = new THREE.QuadraticBezierCurve3(pos1, controlPoint, pos2);
            const vine = new THREE.Mesh(new THREE.TubeGeometry(curve, 20, 0.1, 8, false), new THREE.MeshStandardMaterial({ color: 0x00ff00, roughness: 0.8 }));
            scene.add(vine);
            connectionLines.push(vine);
        }

        function onDocumentMouseClick(event) {
            if (event.target.closest('.ui-panel, .modal-container, #toggle-panel-btn, #cancel-connection-btn, .top-right-controls')) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            if (intersects.length > 0) {
                let clickedObject = intersects[0].object;
                while (clickedObject.parent && !clickedObject.userData.id) clickedObject = clickedObject.parent;
                if (clickedObject.userData.id) {
                     if (isConnecting) handleFinalizeConnection(clickedObject);
                     else {
                        selectedTaskObject = clickedObject;
                        showTaskModal(selectedTaskObject.userData);
                     }
                }
            }
        }

        function showTaskModal(taskData) {
            modalTitle.textContent = taskData.title;
            modalDetails.textContent = taskData.details || "No details provided.";
            modalStatus.textContent = taskData.status;
            modalStatus.className = taskData.status;
            const isCompleted = taskData.status === 'completed';
            [completeTaskBtn, connectTaskBtn, nurtureTaskBtn].forEach(btn => btn.disabled = isCompleted);
            
            modalDetails.classList.remove('hidden');
            modalDetailsTextarea.classList.add('hidden');
            viewModeButtons.classList.remove('hidden');
            editModeButtons.classList.add('hidden');
            
            taskModal.classList.remove('hidden');
        }

        function redrawAllConnections() {
            connectionLines.forEach(line => scene.remove(line));
            connectionLines.length = 0;
            gardenData.connections.forEach(conn => {
                const obj1 = taskObjects.find(o => o.userData.id === conn.from);
                const obj2 = taskObjects.find(o => o.userData.id === conn.to);
                if (obj1 && obj2) drawVine(obj1, obj2);
            });
        }

        // =============================================================================
        // UI & LOGIC
        // =============================================================================
        function toggleUIPanel() { uiPanel.classList.toggle('visible'); }
        function updateTime() { timeDisplay.textContent = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Brussels"})).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        function showSavingIndicator() { savingIndicator.classList.add('visible'); setTimeout(() => savingIndicator.classList.remove('visible'), 1500); }

        function handleStartConnection() {
            isConnecting = true;
            firstConnectionObject = selectedTaskObject;
            taskModal.classList.add('hidden');
            connectingIndicator.classList.add('visible');
            cancelConnectionBtn.style.display = 'block';
            firstConnectionObject.children.forEach(child => { if (child.material) child.material.emissive = new THREE.Color(0x007bff); });
        }

        function handleFinalizeConnection(secondObject) {
            if (firstConnectionObject.userData.id === secondObject.userData.id) { alert("You can't connect a plant to itself."); return; }
            const exists = gardenData.connections.some(conn => (conn.from === firstConnectionObject.userData.id && conn.to === secondObject.userData.id) || (conn.from === secondObject.userData.id && conn.to === firstConnectionObject.userData.id));
            if (exists) { alert("These plants are already connected."); cancelConnection(); return; }
            gardenData.connections.push({ from: firstConnectionObject.userData.id, to: secondObject.userData.id });
            drawVine(firstConnectionObject, secondObject);
            saveDataToLocalStorage();
            cancelConnection();
        }
        
        function cancelConnection() {
            isConnecting = false;
            connectingIndicator.classList.remove('visible');
            cancelConnectionBtn.style.display = 'none';
            if (firstConnectionObject) {
                 firstConnectionObject.children.forEach(child => { if (child.material) child.material.emissive = new THREE.Color(0x000000); });
            }
            firstConnectionObject = null;
        }
        
        function handleNurtureTask() {
            modalDetails.classList.add('hidden');
            modalDetailsTextarea.classList.remove('hidden');
            modalDetailsTextarea.value = selectedTaskObject.userData.details;
            viewModeButtons.classList.add('hidden');
            editModeButtons.classList.remove('hidden');
        }
        
        function handleSaveNurture() {
            const taskId = selectedTaskObject.userData.id;
            const taskIndex = gardenData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            const oldDetails = gardenData.tasks[taskIndex].details;
            const newDetails = modalDetailsTextarea.value;
            gardenData.tasks[taskIndex].details = newDetails;
            const wasSimple = oldDetails.length < 50;
            const isSimple = newDetails.length < 50;
            if (wasSimple !== isSimple) {
                const oldObject = taskObjects.find(o => o.userData.id === taskId);
                const position = oldObject.position.clone();
                const objIndex = taskObjects.findIndex(o => o.userData.id === taskId);
                if(objIndex > -1) taskObjects.splice(objIndex, 1);
                scene.remove(oldObject);
                const newObject = createTaskObject(gardenData.tasks[taskIndex]);
                newObject.position.copy(position);
                redrawAllConnections();
            } else {
                selectedTaskObject.userData.details = newDetails;
            }
            saveDataToLocalStorage();
            taskModal.classList.add('hidden');
        }
        
        async function handleAiAssist() {
            if (!gardenSettings.apiKey) {
                alert("Please set your Gemini API key in the settings first.");
                settingsModal.classList.remove('hidden');
                return;
            }
            const task = selectedTaskObject.userData;
            const prompt = `Based on the following task, break it down into a clear list of sub-tasks or brainstorm related ideas. Task Title: "${task.title}". Current Details: "${modalDetailsTextarea.value}". Provide the response as a simple list.`;
            aiAssistBtn.disabled = true;
            aiAssistBtn.textContent = "Thinking...";
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${gardenSettings.apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    const currentText = modalDetailsTextarea.value;
                    modalDetailsTextarea.value = (currentText ? currentText + "\n\n" : "") + "✨ AI Suggestions:\n" + generatedText;
                } else { throw new Error("Invalid response structure from API."); }
            } catch (error) {
                console.error("Error with Gemini API:", error);
                alert("Sorry, the AI assistant is currently unavailable. Please check your API key or try again later.");
            } finally {
                aiAssistBtn.disabled = false;
                aiAssistBtn.textContent = "✨ AI Assist";
            }
        }
        
        function handleTimeSliderChange(event) {
            const hour = parseInt(event.target.value, 10);
            gardenSettings.timeOverride = hour;
            timeSliderValue.textContent = `${hour}:00`;
            initSky();
            saveSettingsToLocalStorage();
        }

        function handleResetTime() {
            gardenSettings.timeOverride = null;
            timeSliderValue.textContent = "Auto";
            timeSlider.value = new Date().getHours(); // Reset slider position
            initSky();
            saveSettingsToLocalStorage();
        }
        
        function handleShowList() {
            populateTaskList();
            listModal.classList.remove('hidden');
        }
        
        function populateTaskList() {
            taskList.innerHTML = ''; // Clear existing list
            if (gardenData.tasks.length === 0) {
                taskList.innerHTML = '<li>Your garden is empty. Plant a new thought!</li>';
                return;
            }
            gardenData.tasks.forEach(task => {
                const li = document.createElement('li');
                li.textContent = task.title;
                li.dataset.id = task.id;
                if (task.status === 'completed') {
                    li.classList.add('completed');
                }
                taskList.appendChild(li);
            });
        }
        
        function handleListNavigation(event) {
            if (event.target.tagName === 'LI') {
                const taskId = event.target.dataset.id;
                const targetObject = taskObjects.find(obj => obj.userData.id === taskId);
                if (targetObject) {
                    // Move camera to the object
                    controls.target.copy(targetObject.position);
                    camera.position.set(targetObject.position.x, targetObject.position.y + 15, targetObject.position.z + 20);
                    listModal.classList.add('hidden');
                }
            }
        }

        // =============================================================================
        // LOCAL STORAGE
        // =============================================================================

        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('auraMindGardenData');
                gardenData = savedData ? JSON.parse(savedData) : { tasks: [], connections: [] };
                taskObjects.forEach(obj => scene.remove(obj));
                taskObjects.length = 0;
                connectionLines.forEach(line => scene.remove(line));
                connectionLines.length = 0;
                gardenData.tasks.forEach(task => createTaskObject(task));
                redrawAllConnections();
            } catch (error) {
                console.error('Could not load data from local storage:', error);
                gardenData = { tasks: [], connections: [] };
            } finally {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        }

        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('auraMindGardenData', JSON.stringify(gardenData));
                showSavingIndicator();
            } catch (error) {
                console.error('Could not save data to local storage:', error);
                alert('There was an error saving your garden.');
            }
        }
        
        function loadSettingsFromLocalStorage() {
            const savedSettings = localStorage.getItem('auraGardenSettings');
            if (savedSettings) {
                gardenSettings = JSON.parse(savedSettings);
                apiKeyInput.value = gardenSettings.apiKey || "";
                if (gardenSettings.timeOverride !== null) {
                    timeSlider.value = gardenSettings.timeOverride;
                    timeSliderValue.textContent = `${gardenSettings.timeOverride}:00`;
                }
            }
        }
        
        function saveSettingsToLocalStorage() {
            localStorage.setItem('auraGardenSettings', JSON.stringify(gardenSettings));
        }
        
        function handleSaveApiKey() {
            const newKey = apiKeyInput.value.trim();
            if (newKey) {
                gardenSettings.apiKey = newKey;
                saveSettingsToLocalStorage();
                alert("API Key saved successfully!");
                settingsModal.classList.add('hidden');
            } else {
                alert("Please enter a valid API key.");
            }
        }

        function handleAddTask() {
            const title = taskTitleInput.value;
            const details = taskDetailsInput.value;
            if (!title) { alert('Please provide a title for your thought.'); return; }
            const newTask = { id: Date.now().toString(), title, details, status: 'pending', x: (Math.random() - 0.5) * 150, z: (Math.random() - 0.5) * 150 };
            gardenData.tasks.push(newTask);
            createTaskObject(newTask);
            saveDataToLocalStorage();
            taskTitleInput.value = '';
            taskDetailsInput.value = '';
            uiPanel.classList.remove('visible');
        }

        function handleCompleteTask() {
            if (!selectedTaskObject) return;
            const taskId = selectedTaskObject.userData.id;
            const taskIndex = gardenData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            gardenData.tasks[taskIndex].status = 'completed';
            const oldObject = taskObjects.find(o => o.userData.id === taskId);
            const position = oldObject.position.clone();
            const objIndex = taskObjects.findIndex(o => o.userData.id === taskId);
            if(objIndex > -1) taskObjects.splice(objIndex, 1);
            scene.remove(oldObject);
            const newObject = createTaskObject(gardenData.tasks[taskIndex]);
            newObject.position.copy(position);
            redrawAllConnections();
            saveDataToLocalStorage();
            taskModal.classList.add('hidden');
        }

        // =============================================================================
        // SCRIPT EXECUTION
        // =============================================================================
        init();
    </script>
</body>
</html>
