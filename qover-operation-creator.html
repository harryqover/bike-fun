<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qover Operation Payload Generator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        /* Custom styles for a polished GAFAM-level feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A very light gray, almost white */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Styles for the generated JSON output container */
        .json-output-container {
            border-radius: 0.5rem;
            white-space: pre;
            word-break: break-all;
            height: 100%;
            overflow: auto;
        }
        .json-output-container code.hljs {
            padding: 1.25rem;
            font-size: 0.875rem;
        }

        .param-editor-container {
            padding-left: 20px;
            border-left: 2px solid #e2e8f0;
        }

        /* Subtle transitions for a smoother experience */
        .transition-all { transition: all 0.2s ease-in-out; }
        .toast {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Spinner animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <!-- Header Section -->
        <header class="mb-6 flex items-center justify-between">
            <div>
                 <h1 class="text-3xl font-bold text-slate-800">Operation Payload Generator</h1>
                 <p class="text-slate-500 mt-1">Visually construct and deploy Qover operations with a live preview.</p>
            </div>
            <button id="settings-btn" title="Settings" class="p-2 rounded-full hover:bg-slate-200 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-slate-600"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </header>
        
        <!-- Main Two-Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            
            <!-- Left Column: Form / Builder -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-8">
                <!-- Template Loader Section -->
                <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                    <label for="template-selector" class="block text-sm font-medium text-slate-700 mb-2 flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2 text-slate-500"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        Load from Template
                    </label>
                    <select id="template-selector" class="w-full p-2.5 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="">-- Start from a blank slate --</option>
                    </select>
                </div>

                <!-- Main Form -->
                <form id="operation-form" class="space-y-6">
                    <!-- Basic Operation Details -->
                     <div class="space-y-2">
                        <h2 class="text-lg font-semibold text-slate-800">Operation Details</h2>
                        <div class="p-4 border border-slate-200 rounded-lg space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="name" class="block text-xs font-medium text-slate-600 mb-1">Name</label>
                                    <input type="text" id="name" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="e.g., Send Welcome Email">
                                </div>
                                <div>
                                    <label for="eventType" class="block text-xs font-medium text-slate-600 mb-1">Event Type</label>
                                    <select id="eventType" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="conditionExpression" class="block text-xs font-medium text-slate-600 mb-1">Condition Expression</label>
                                <textarea id="conditionExpression" rows="6" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm font-mono text-xs focus:ring-indigo-500 focus:border-indigo-500" placeholder="eventName = 'policyCreated'"></textarea>
                            </div>
                            <div>
                                <div class="flex items-center">
                                    <input id="enabled" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300 rounded">
                                    <label for="enabled" class="ml-2 block text-sm font-medium text-slate-700">Enabled</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions Section -->
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-slate-800">Actions</h2>
                            <button type="button" id="add-action-btn" class="flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add Action
                            </button>
                        </div>
                        <div id="actions-container" class="space-y-4 pt-2">
                            <!-- Action forms will be dynamically added here -->
                        </div>
                    </div>
                </form>
            </div>

            <!-- Right Column: JSON Output / Actions -->
            <div class="sticky top-8">
                <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700 flex flex-col" style="height: calc(100vh - 4rem);">
                    <!-- Output Header -->
                    <div class="flex-shrink-0 p-4 flex justify-between items-center border-b border-slate-700">
                        <h3 class="text-lg font-medium text-slate-200">Live Payload Preview</h3>
                        <div class="flex items-center space-x-2">
                             <button type="button" id="copy-payload-btn" title="Copy to Clipboard" class="flex items-center px-3 py-1.5 border border-slate-600 text-sm font-medium rounded-md text-slate-300 bg-slate-700 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-indigo-500 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                             <button type="button" id="create-operation-btn" class="flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-blue-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                Create Operation
                            </button>
                        </div>
                    </div>

                    <!-- Output Content -->
                    <div class="flex-grow min-h-0">
                        <pre class="json-output-container"><code id="payload-output" class="language-json"></code></pre>
                    </div>

                    <!-- Output Footer / API Response -->
                    <div id="api-response-container" class="flex-shrink-0 border-t border-slate-700 p-4 text-sm hidden"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center transition-all">
        <div class="relative p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-slate-900">Settings</h3>
                <button id="close-settings-btn" class="p-1 rounded-full hover:bg-slate-200">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-slate-600"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="google-script-endpoint" class="block text-sm font-medium text-slate-700 mb-1">Google Script Endpoint URL</label>
                    <input type="url" id="google-script-endpoint" class="block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="https://script.google.com/macros/s/...">
                    <p class="text-xs text-slate-500 mt-1">This URL is stored securely in your browser's local storage.</p>
                </div>
            </div>
            <div class="items-center text-right pt-4 mt-4 border-t border-slate-200">
                <button id="save-settings-btn" class="px-5 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    Save
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center transition-all">
        <div class="relative p-6 border w-full max-w-md shadow-xl rounded-xl bg-white">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-yellow-600"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-slate-900 mt-4">Confirm Operation Creation</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-slate-500">Are you sure you want to create this operation in the Qover SBX platform?</p>
                </div>
                <div class="items-center px-4 py-3 space-x-4">
                    <button id="cancel-create-btn" class="px-5 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-all">
                        Cancel
                    </button>
                    <button id="confirm-create-btn" class="px-5 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        Yes, Create It
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-slate-900 text-white py-2 px-4 rounded-lg shadow-lg flex items-center toast">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2 text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span id="toast-message"></span>
    </div>

    <!-- TEMPLATES (HIDDEN) -->
    <template id="action-form-template">
        <div class="action-form p-4 border border-slate-200 rounded-lg bg-white shadow-sm space-y-4">
            <div class="flex justify-between items-start">
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">Action Type</label>
                    <select class="action-type-selector mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    </select>
                </div>
                <button type="button" class="remove-action-btn text-slate-400 hover:text-red-600 p-1 rounded-md transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-600 mb-2">Parameters</label>
                <div class="param-editor-container" data-type="object"></div>
                <button type="button" class="add-param-btn mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                      Add Parameter
                </button>
            </div>
        </div>
    </template>

    <template id="param-row-template">
        <div class="param-row mb-2 p-2 rounded-md bg-slate-50/50 border border-slate-200">
             <div class="grid grid-cols-12 gap-2 items-center">
                <div class="col-span-4 key-container">
                    <input type="text" class="param-key p-2 border border-slate-300 rounded-md w-full text-sm" placeholder="key">
                </div>
                <div class="col-span-4 value-container">
                     <!-- Value input will be placed here -->
                </div>
                <div class="col-span-3">
                    <select class="param-type p-2 border border-slate-300 rounded-md w-full text-sm">
                        <option value="string">String</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="null">Null</option>
                        <option value="object">Object</option>
                        <option value="array">Array</option>
                    </select>
                </div>
                <div class="col-span-1 text-right">
                     <button type="button" class="remove-param-btn text-slate-400 hover:text-red-600 p-1 rounded-md transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            <div class="nested-container mt-2"></div>
        </div>
    </template>
    
    <!-- External libraries moved to the end of the body for correct loading order -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Main application script -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA & CONFIG ---
        let lastGeneratedPayload = null;
        const LS_ENDPOINT_KEY = 'qover_google_script_endpoint';
        
        const generalizedTemplates = [{ name: "Send Email on Risk Item Cancellation", eventType: "EVENT_TYPE_RISK_ITEM", conditionExpression: "(\n  $riskItemCanceled := eventName = \"masterPolicyRiskItemCanceled\";\n  $isCorrectProduct := policy.productConfiguration.id = \"your-product-id\";\n  {\n    \"valid\": $riskItemCanceled and $isCorrectProduct,\n    \"details\": {\n      \"riskItemCanceled\": $riskItemCanceled,\n      \"isCorrectProduct\": $isCorrectProduct\n    }\n  }\n)", enabled: true, actions: [{ type: "ACTION_TYPE_SEND_EMAIL", params: { from: { address: "noreply@qover.com", displayName: "Your Product Name" }, to: [{ address: "<%= riskItem.subject.email %>" }], locale: "<%= riskItem.language %>-<%= riskItem.country %>", template: { id: "your-template-id-cancellation" }, resource: { type: "POLICY", id: "<%= riskItem.id %>" } } }] }, { name: "Start Reminder for Missing Vehicle", eventType: "EVENT_TYPE_POI", conditionExpression: "(\n$poiRiskItemNotFound := eventName = \"poiDmrMasterPolicyRiskItemNotFound\";\n$isCorrectProduct := resource.details.masterPolicy.productConfiguration.id = \"your-product-id\";\n{\n    \"valid\": ($poiRiskItemNotFound and $isCorrectProduct),\n    \"details\": {\n        \"poiRiskItemNotFound\": $poiRiskItemNotFound,\n        \"isCorrectProduct\": $isCorrectProduct\n    }\n}\n)", enabled: true, actions: [{ type: "ACTION_TYPE_SEND_REMINDER", params: { id: "missing-vehicle-reminder-<%= entity.data.mapped.vehicleInformation.vin %>", schedule: { referenceDate: "<%= new Date().toISOString().split('T')[0] %>", timeZone: "Europe/Brussels", time: "09:00:00", dateSpec: "P7D", recurrence: { offsets: { durationBetweenMessages: ["P1W", "P1W"] } } }, email: { from: { address: "noreply@qover.com", displayName: "Qover" }, to: [{ address: "operations-team@example.com" }], template: { id: "your-fleet-mail-template" }, locale: "en-US" } } }] }, { name: "Create Ticket for Document Approval", eventType: "EVENT_TYPE_POLICY_QUOTE_APPROVAL", conditionExpression: "(\n  $approvalCreated := eventName = \"policyQuoteApprovalCreated\";\n  $isCorrectProduct := quote.productConfiguration.id = \"your-product-id\";\n  $claimFreeApproval := approval.id = \"your-approval-id\";\n\n  {\n    \"valid\": $approvalCreated and $isCorrectProduct and $claimFreeApproval,\n    \"details\": {\n      \"approvalCreated\": $approvalCreated,\n      \"isCorrectProduct\": $isCorrectProduct,\n      \"claimFreeApproval\": $claimFreeApproval\n    }\n  }\n)", enabled: true, actions: [{ type: "ACTION_TYPE_CREATE_TICKET", params: { request: { subject: "Document Validation: <%= quote.subject.mainDriver.firstName %> <%= quote.subject.mainDriver.lastName %>", internalNote: "<p>Please validate the uploaded documents for quote <%= data.quote.id %>.</p>", priority: "TICKET_PRIORITY_NORMAL", type: "TICKET_TYPE_TASK", requester: { email: "noreply@qover.com", name: "Qover System" } }, locale: "en" } }] }, { name: "Notify Slack on Payment Failure", eventType: "EVENT_TYPE_PAYMENT", conditionExpression: "eventName = \"instalmentPaymentFailed\"", enabled: true, actions: [{ type: "ACTION_TYPE_NOTIFY_SLACK", params: { channel: "your-slack-channel", message: { text: "Payment Failed!\nProduct: <%= payment.refs.product %>\nPolicy: <%= policy.policyNumber %>", iconEmoji: ":warning:" } } }] }];
        const actionParamSchemas = { 'ACTION_TYPE_SEND_EMAIL': { from: { address: "noreply@qover.com", displayName: "Your Display Name" }, to: [{ address: "<% policy.policyholder.email %>" }], locale: "<%= policy.language %>-<%= policy.country %>", template: { id: "your-template-id" }, attachments: {}, resource: { type: "POLICY", id: "<%= policy.id %>" } }, 'ACTION_TYPE_SEND_REMINDER': { id: "reminder-<%= policy.id %>", schedule: { referenceDate: "<%= new Date().toISOString().split('T')[0] %>", timeZone: "Europe/Brussels", time: "09:00:00", dateSpec: "P7D", recurrence: { offsets: { durationBetweenMessages: ["P1W"] } } }, email: { from: { address: "noreply@qover.com", displayName: "Qover" }, to: [{ address: "<% policy.policyholder.email %>" }], template: { id: "your-reminder-template" }, locale: "en-US" } }, 'ACTION_TYPE_CREATE_TICKET': { request: { subject: "New Ticket Subject", internalNote: "<p>Details about the ticket...</p>", priority: "TICKET_PRIORITY_NORMAL", type: "TICKET_TYPE_TASK", requester: { email: "noreply@qover.com", name: "Qover System" } }, locale: "en" }, 'ACTION_TYPE_NOTIFY_SLACK': { channel: "#your-channel", message: { text: "A new event occurred!", iconEmoji: ":bell:" } }, 'ACTION_TYPE_CANCEL_REMINDER': { reminderId: "reminder-<%= policy.id %>" }, 'ACTION_TYPE_SEND_POSTAL_MAIL': { address: { country: "<%= policy.country %>", city: "<%= policy.policyholder.address.city %>", street: "<%= policy.policyholder.address.street %>", number: "<%= policy.policyholder.address.number %>", postalCode: "<%= policy.policyholder.address.zip %>" }, locale: "en-US", template: { id: "your-postal-mail-template" }, attachments: {}, resource: { type: "POLICY", id: "<%= policy.id %>" } } };
        const allEventTypes = ["EVENT_TYPE_RISK_ITEM", "EVENT_TYPE_POI", "EVENT_TYPE_POLICY", "EVENT_TYPE_PAYMENT", "EVENT_TYPE_POLICY_QUOTE_APPROVAL", "EVENT_TYPE_CONTRACT"];
        const allActionTypes = ["ACTION_TYPE_SEND_EMAIL", "ACTION_TYPE_SEND_REMINDER", "ACTION_TYPE_CREATE_TICKET", "ACTION_TYPE_NOTIFY_SLACK", "ACTION_TYPE_CANCEL_REMINDER", "ACTION_TYPE_SEND_POSTAL_MAIL"];

        // --- DOM ELEMENTS ---
        const dom = {
            templateSelector: document.getElementById('template-selector'),
            form: document.getElementById('operation-form'),
            nameInput: document.getElementById('name'),
            eventTypeSelect: document.getElementById('eventType'),
            conditionExpressionTextarea: document.getElementById('conditionExpression'),
            enabledCheckbox: document.getElementById('enabled'),
            actionsContainer: document.getElementById('actions-container'),
            addActionButton: document.getElementById('add-action-btn'),
            payloadOutput: document.getElementById('payload-output'),
            copyPayloadButton: document.getElementById('copy-payload-btn'),
            actionFormTemplate: document.getElementById('action-form-template'),
            paramRowTemplate: document.getElementById('param-row-template'),
            createOperationBtn: document.getElementById('create-operation-btn'),
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmCreateBtn: document.getElementById('confirm-create-btn'),
            cancelCreateBtn: document.getElementById('cancel-create-btn'),
            apiResponseContainer: document.getElementById('api-response-container'),
            toast: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            endpointInput: document.getElementById('google-script-endpoint'),
        };

        // --- HELPER FUNCTIONS ---
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        
        function showToast(message) {
            dom.toastMessage.textContent = message;
            dom.toast.classList.add('show');
            setTimeout(() => dom.toast.classList.remove('show'), 3000);
        }
        
        function updateCreateButtonState() {
            const endpoint = localStorage.getItem(LS_ENDPOINT_KEY);
            if (endpoint) {
                dom.createOperationBtn.disabled = false;
                dom.createOperationBtn.title = "Deploy this operation via Google Script";
            } else {
                dom.createOperationBtn.disabled = true;
                dom.createOperationBtn.title = "Please set your Google Script endpoint in Settings to enable deployment.";
            }
        }

        // --- API CALL ---
        async function createOperation() {
            const endpoint = localStorage.getItem(LS_ENDPOINT_KEY);
            if (!endpoint) {
                showToast("Error: Google Script endpoint is not set.");
                dom.settingsModal.classList.remove('hidden');
                return;
            }

            dom.confirmCreateBtn.disabled = true;
            dom.confirmCreateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin h-5 w-5 mr-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Creating...`;
            dom.apiResponseContainer.classList.add('hidden');

            try {
                const response = await fetch(endpoint, { method: 'POST', body: lastGeneratedPayload, headers: { 'Content-Type': 'text/plain' } });
                const result = await response.json();
                const { body: responseBody, statusCode } = result;

                dom.apiResponseContainer.classList.remove('hidden');
                if (statusCode >= 200 && statusCode < 300) {
                    dom.apiResponseContainer.className = 'flex-shrink-0 border-t border-slate-700 p-4 text-sm bg-green-500/10 text-green-300';
                    dom.apiResponseContainer.innerHTML = `<strong class="font-semibold flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Success (Status ${statusCode})</strong><pre class="mt-2 text-xs whitespace-pre-wrap">${JSON.stringify(responseBody, null, 2)}</pre>`;
                } else {
                    dom.apiResponseContainer.className = 'flex-shrink-0 border-t border-slate-700 p-4 text-sm bg-red-500/10 text-red-300';
                    dom.apiResponseContainer.innerHTML = `<strong class="font-semibold flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>Error (Status ${statusCode})</strong><pre class="mt-2 text-xs whitespace-pre-wrap">${JSON.stringify(responseBody, null, 2)}</pre>`;
                }
            } catch (error) {
                dom.apiResponseContainer.classList.remove('hidden');
                dom.apiResponseContainer.className = 'flex-shrink-0 border-t border-slate-700 p-4 text-sm bg-red-500/10 text-red-300';
                dom.apiResponseContainer.innerHTML = `<strong class="font-semibold">Network/Script Error:</strong><p class="mt-2 text-xs">${error.message}.</p>`;
            } finally {
                dom.confirmCreateBtn.disabled = false;
                dom.confirmCreateBtn.textContent = 'Yes, Create It';
                dom.confirmationModal.classList.add('hidden');
            }
        }

        // --- UI BUILDER ---
        function createValueInput(type, value = '') {
            let input;
            switch (type) {
                case 'number': input = document.createElement('input'); input.type = 'number'; input.value = value; break;
                case 'boolean': input = document.createElement('select'); ['true', 'false'].forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; if (String(value) === v) o.selected = true; input.appendChild(o); }); break;
                case 'null': input = document.createElement('input'); input.type = 'text'; input.value = 'null'; input.disabled = true; break;
                default: input = document.createElement('input'); input.type = 'text'; input.value = value;
            }
            input.className = 'param-value p-2 border border-slate-300 rounded-md w-full text-sm';
            return input;
        }
        
        function addParamRow(container, key = '', value = '', isArrayItem = false) {
            const rowClone = dom.paramRowTemplate.content.cloneNode(true);
            const elements = {
                row: rowClone.querySelector('.param-row'),
                keyContainer: rowClone.querySelector('.key-container'),
                keyInput: rowClone.querySelector('.param-key'),
                valueContainer: rowClone.querySelector('.value-container'),
                typeSelector: rowClone.querySelector('.param-type'),
                nestedContainer: rowClone.querySelector('.nested-container'),
                removeBtn: rowClone.querySelector('.remove-param-btn'),
            };
            
            elements.keyInput.value = key;
            if (isArrayItem) elements.keyContainer.style.visibility = 'hidden';

            const valueType = Array.isArray(value) ? 'array' : (value === null ? 'null' : typeof value);
            elements.typeSelector.value = valueType;

            if (valueType === 'object' || valueType === 'array') {
                const subContainer = document.createElement('div');
                subContainer.className = 'param-editor-container';
                subContainer.dataset.type = valueType;
                elements.nestedContainer.appendChild(subContainer);
                
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'add-param-btn mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center';
                const addBtnIconType = valueType === 'object' ? 'plus-circle' : 'list-plus';
                addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg> ${valueType === 'object' ? 'Add Parameter' : 'Add Item'}`;
                addBtn.onclick = () => addParamRow(subContainer, '', '', valueType === 'array');
                elements.nestedContainer.appendChild(addBtn);

                if (value) {
                    if (valueType === 'object') Object.entries(value).forEach(([k, v]) => addParamRow(subContainer, k, v));
                    else value.forEach(item => addParamRow(subContainer, '', item, true));
                }
            } else {
                elements.valueContainer.appendChild(createValueInput(valueType, value));
            }

            elements.typeSelector.addEventListener('change', () => {
                const newType = elements.typeSelector.value;
                elements.valueContainer.innerHTML = '';
                elements.nestedContainer.innerHTML = '';
                if (newType === 'object' || newType === 'array') {
                    const subContainer = document.createElement('div');
                    subContainer.className = 'param-editor-container';
                    subContainer.dataset.type = newType;
                    elements.nestedContainer.appendChild(subContainer);
                    
                    const addBtn = document.createElement('button');
                    addBtn.type = 'button';
                    addBtn.className = 'add-param-btn mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center';
                    addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg> ${newType === 'object' ? 'Add Parameter' : 'Add Item'}`;
                    addBtn.onclick = () => addParamRow(subContainer, '', '', newType === 'array');
                    elements.nestedContainer.appendChild(addBtn);
                } else {
                    elements.valueContainer.appendChild(createValueInput(newType));
                }
            });

            elements.removeBtn.onclick = () => elements.row.remove();
            container.appendChild(rowClone);
        }
        
        function addActionForm(action) {
            const clone = dom.actionFormTemplate.content.cloneNode(true);
            const actionFormEl = clone.querySelector('.action-form');
            const typeSelector = clone.querySelector('.action-type-selector');
            const paramEditor = clone.querySelector('.param-editor-container');
            const addParamBtn = clone.querySelector('.add-param-btn');
            const removeButton = clone.querySelector('.remove-action-btn');

            allActionTypes.forEach(type => { const o = document.createElement('option'); o.value = type; o.textContent = type; typeSelector.appendChild(o); });

            const populateParamsForType = type => {
                paramEditor.innerHTML = '';
                const schema = actionParamSchemas[type];
                if (schema) Object.entries(schema).forEach(([k, v]) => addParamRow(paramEditor, k, v));
            };

            typeSelector.addEventListener('change', e => populateParamsForType(e.target.value));
            if (action) {
                typeSelector.value = action.type;
                if (action.params) Object.entries(action.params).forEach(([k, v]) => addParamRow(paramEditor, k, v));
            } else {
                populateParamsForType(typeSelector.value);
            }

            addParamBtn.onclick = () => addParamRow(paramEditor);
            removeButton.onclick = () => actionFormEl.remove();
            dom.actionsContainer.appendChild(clone);
        }

        // --- PAYLOAD GENERATION & FORM PARSING ---
        function buildObjectFromUI(container) {
            const type = container.dataset.type;
            if (type === 'array') {
                const arr = [];
                container.querySelectorAll(':scope > .param-row').forEach(row => {
                    const valueType = row.querySelector('.param-type').value;
                    const nested = row.querySelector('.param-editor-container');
                    if (nested && nested.children.length > 0) arr.push(buildObjectFromUI(nested));
                    else { const valInput = row.querySelector('.param-value'); if (valInput) arr.push(parseValue(valInput.value, valueType)); }
                });
                return arr;
            } else {
                const obj = {};
                container.querySelectorAll(':scope > .param-row').forEach(row => {
                    const key = row.querySelector('.param-key').value;
                    if (!key) return;
                    const valueType = row.querySelector('.param-type').value;
                    const nested = row.querySelector('.param-editor-container');
                    if (nested && nested.children.length > 0) obj[key] = buildObjectFromUI(nested);
                    else { const valInput = row.querySelector('.param-value'); if (valInput) obj[key] = parseValue(valInput.value, valueType); }
                });
                return obj;
            }
        }
        
        function parseValue(value, type) {
            switch (type) {
                case 'number': return Number(value);
                case 'boolean': return value === 'true';
                case 'null': return null;
                default: return value;
            }
        }
        
        const updateLivePayload = debounce(() => {
            const payload = {
                name: dom.nameInput.value,
                eventType: dom.eventTypeSelect.value,
                conditionExpression: dom.conditionExpressionTextarea.value,
                enabled: dom.enabledCheckbox.checked,
                actions: Array.from(dom.actionsContainer.querySelectorAll('.action-form')).map(form => ({
                    type: form.querySelector('.action-type-selector').value,
                    params: buildObjectFromUI(form.querySelector('.param-editor-container'))
                }))
            };
            const payloadString = JSON.stringify(payload, null, 2);
            lastGeneratedPayload = payloadString;
            dom.payloadOutput.textContent = payloadString;
            hljs.highlightElement(dom.payloadOutput);
        }, 300);

        function loadOperationIntoForm(operation) {
            if (!operation) {
                dom.form.reset();
                dom.enabledCheckbox.checked = true;
                dom.actionsContainer.innerHTML = '';
                addActionForm();
            } else {
                dom.nameInput.value = operation.name || '';
                dom.eventTypeSelect.value = operation.eventType || '';
                dom.conditionExpressionTextarea.value = operation.conditionExpression || '';
                dom.enabledCheckbox.checked = operation.enabled;
                dom.actionsContainer.innerHTML = '';
                if (operation.actions) operation.actions.forEach(action => addActionForm(action));
            }
            updateLivePayload();
        }
        
        // --- INITIALIZATION ---
        function initialize() {
            generalizedTemplates.forEach((op, index) => { const o = document.createElement('option'); o.value = index; o.textContent = op.name; dom.templateSelector.appendChild(o); });
            allEventTypes.forEach(type => { const o = document.createElement('option'); o.value = type; o.textContent = type; dom.eventTypeSelect.appendChild(o); });
            
            // Settings
            dom.endpointInput.value = localStorage.getItem(LS_ENDPOINT_KEY) || '';
            updateCreateButtonState();
            
            loadOperationIntoForm(null);

            // --- Event Listeners ---
            dom.templateSelector.addEventListener('change', e => {
                const op = e.target.value ? generalizedTemplates[e.target.value] : null;
                loadOperationIntoForm(op);
            });
            
            dom.addActionButton.addEventListener('click', () => addActionForm());
            
            dom.copyPayloadButton.addEventListener('click', () => {
                if (!lastGeneratedPayload) return;
                navigator.clipboard.writeText(lastGeneratedPayload).then(() => showToast('Payload copied to clipboard!'));
            });

            dom.createOperationBtn.addEventListener('click', () => {
                if (lastGeneratedPayload) dom.confirmationModal.classList.remove('hidden');
            });
            dom.cancelCreateBtn.addEventListener('click', () => dom.confirmationModal.classList.add('hidden'));
            dom.confirmCreateBtn.addEventListener('click', createOperation);
            
            // Settings Modal listeners
            dom.settingsBtn.addEventListener('click', () => dom.settingsModal.classList.remove('hidden'));
            dom.closeSettingsBtn.addEventListener('click', () => dom.settingsModal.classList.add('hidden'));
            dom.saveSettingsBtn.addEventListener('click', () => {
                const endpoint = dom.endpointInput.value.trim();
                localStorage.setItem(LS_ENDPOINT_KEY, endpoint);
                dom.settingsModal.classList.add('hidden');
                showToast("Settings saved successfully!");
                updateCreateButtonState();
            });

            // Live update listener
            dom.form.addEventListener('input', updateLivePayload);
            dom.form.addEventListener('change', updateLivePayload);
            new MutationObserver(updateLivePayload).observe(dom.actionsContainer, { childList: true, subtree: true });
        }

        initialize();
    });
    </script>
</body>
</html>

