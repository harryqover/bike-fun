<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML & EJS Live Previewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- EJS library for full JavaScript template support -->
    <script src="https://cdn.jsdelivr.net/npm/ejs@3.1.9/ejs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling for a cleaner look */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .editor-title {
            @apply text-sm font-medium text-gray-500 uppercase tracking-wider pb-2 border-b border-gray-200 mb-2 flex items-center;
        }
        /* Prevent text selection while dragging resizers */
        .resizing {
            user-select: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm p-4 z-10 flex-shrink-0">
            <h1 class="text-xl font-bold text-gray-900">Live HTML & EJS Previewer</h1>
            <p class="text-sm text-gray-600">Paste your HTML with EJS variables (`<%= ... %>`, `<% ... %>`) and provide JSON data to see a live preview.</p>
        </header>

        <!-- Main Content: Editor and Preview Panes -->
        <main class="flex-grow flex flex-row p-4 overflow-hidden">
            
            <!-- Left Pane: Inputs -->
            <div id="leftPane" class="flex flex-col h-full" style="flex: 0 0 50%; min-width: 200px;">
                <!-- HTML Input -->
                <div id="htmlPane" class="flex flex-col bg-white rounded-lg shadow overflow-hidden" style="flex: 0 0 50%; min-height: 50px;">
                    <h2 class="editor-title px-4 pt-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                        HTML Template
                    </h2>
                    <div class="flex-grow p-1">
                        <textarea id="htmlInput" class="w-full h-full p-3 text-sm font-mono border-0 resize-none focus:ring-0"></textarea>
                    </div>
                </div>

                <!-- Vertical Resizer -->
                <div id="resizerY" class="h-2 my-1 cursor-row-resize bg-gray-200 hover:bg-blue-500 transition-colors rounded-md flex-shrink-0"></div>

                <!-- JSON Input -->
                <div id="jsonPane" class="flex flex-col bg-white rounded-lg shadow overflow-hidden flex-grow" style="min-height: 50px;">
                     <h2 class="editor-title px-4 pt-3 justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 2a10 10 0 1 0 10 10 10 10 0 0 0-10-10z"></path><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                            JSON Data
                        </div>
                        <button id="generateJsonBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Generate from HTML
                        </button>
                    </h2>
                    <div class="flex-grow p-1">
                        <textarea id="jsonInput" class="w-full h-full p-3 text-sm font-mono border-0 resize-none focus:ring-0" placeholder='Click "Generate from HTML" or paste your JSON here.'></textarea>
                    </div>
                </div>
            </div>

            <!-- Horizontal Resizer -->
            <div id="resizerX" class="w-2 mx-1 cursor-col-resize bg-gray-200 hover:bg-blue-500 transition-colors rounded-md flex-shrink-0"></div>

            <!-- Right Pane: Preview -->
            <div id="rightPane" class="flex flex-col bg-white rounded-lg shadow h-full overflow-hidden flex-grow" style="min-width: 200px;">
                 <h2 class="editor-title px-4 pt-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Live Preview
                </h2>
                <div id="errorDisplay" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4 rounded-md whitespace-pre-wrap"></div>
                <iframe id="previewFrame" class="w-full h-full border-0"></iframe>
            </div>
        </main>
    </div>

    <script>
        // DOM element references
        const htmlInput = document.getElementById('htmlInput');
        const jsonInput = document.getElementById('jsonInput');
        const previewFrame = document.getElementById('previewFrame');
        const errorDisplay = document.getElementById('errorDisplay');
        const generateJsonBtn = document.getElementById('generateJsonBtn');

        /**
         * Mock helper functions to simulate server-side functions in the template.
         */
        const mockHelpers = {
            translator: (key = '', vars = {}) => `[TRANSLATED: ${key}]`,
            dateFormat: {
                dateLocaleFormat: (date = '', locale = '', format = '') => `[FORMATTED DATE: ${date || 'undefined'}]`
            },
            JSON: {
                stringify: (obj) => JSON.stringify(obj, null, 2)
            }
        };
        
        /**
         * Helper to set a nested property on an object using a path string.
         * @param {object} obj - The object to modify.
         * @param {string} path - The path string (e.g., "a.b.c").
         * @param {*} value - The value to set.
         */
        function setNestedProperty(obj, path, value) {
            const parts = path.split('.');
            let current = obj;
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                if (i === parts.length - 1) {
                    // If it's the last part, set the value, but don't overwrite a complex object with a simple one
                    if (typeof current[part] !== 'object') {
                       current[part] = value;
                    }
                } else {
                    // If a path segment is not an object, create one.
                    if (typeof current[part] !== 'object' || current[part] === null) {
                        current[part] = {};
                    }
                    current = current[part];
                }
            }
        }

        /**
         * Intelligently scans HTML for data access patterns, including within loops,
         * to generate a more accurate and structured JSON object.
         * @param {string} html - The HTML template string.
         * @returns {object} A generated JSON object.
         */
        function generateJsonFromHtml(html) {
            const root = { data: {} };

            // Pass 1: Find all simple `data.path.to.property` accesses
            const simplePathRegex = /data\.([a-zA-Z0-9_.]+)/g;
            for (const match of html.matchAll(simplePathRegex)) {
                const path = match[1];
                const lastPart = path.split('.').pop();
                setNestedProperty(root.data, path, `[${lastPart}]`);
            }

            // Pass 2: Find loops to create structured array/object data
            const loopRegex = /Object\.(?:entries|values)\s*\((data\.[^\)]+)\)\s*\.forEach\s*\(\s*function\s*\(([^)]+)\)\s*\{([\s\S]*?)\}\s*\);?/g;
            for (const match of html.matchAll(loopRegex)) {
                const dataPath = match[1].replace('data.', ''); // e.g., "policy.package.coverages"
                const args = match[2].replace(/[\[\]]/g, '').split(',').map(s => s.trim()); // e.g., ['coverageKey', 'coverageData'] or ['coverage']
                const loopVarName = args.length > 1 ? args[1] : args[0]; // The variable for the object/value
                const loopBody = match[3];

                // Find all properties accessed on the loop variable
                const itemPropertiesRegex = new RegExp(`${loopVarName}\\.([a-zA-Z0-9_.]+)`, 'g');
                const sampleItem = {};
                for (const propMatch of loopBody.matchAll(itemPropertiesRegex)) {
                    const propPath = propMatch[1];
                    const lastPart = propPath.split('.').pop();
                    setNestedProperty(sampleItem, propPath, `[${lastPart}]`);
                }
                
                // Create a sample entry in the main data object
                const sampleContainer = { "sample_item": sampleItem };
                setNestedProperty(root.data, dataPath, sampleContainer);
            }

            return root;
        }
        
        /**
         * Handles the generation of JSON from the HTML input and populates the JSON textarea.
         */
        function handleGenerateJson() {
            const html = htmlInput.value;
            const generatedData = generateJsonFromHtml(html);
            jsonInput.value = JSON.stringify(generatedData, null, 2);
            updatePreview();
        }

        /**
         * Renders the HTML template with the provided data using the EJS library.
         */
        function updatePreview() {
            const html = htmlInput.value;
            let jsonData = {};

            errorDisplay.classList.add('hidden');
            errorDisplay.textContent = '';

            try {
                jsonData = JSON.parse(jsonInput.value.trim() || '{}');
            } catch (error) {
                errorDisplay.textContent = `JSON Error: ${error.message}`;
                errorDisplay.classList.remove('hidden');
                previewFrame.srcdoc = '';
                return;
            }
            
            const renderData = { ...jsonData, ...mockHelpers };

            try {
                const renderedHtml = ejs.render(html, renderData);
                previewFrame.srcdoc = renderedHtml;
            } catch (error) {
                errorDisplay.textContent = `EJS Render Error: ${error.message}`;
                errorDisplay.classList.remove('hidden');
                previewFrame.srcdoc = '';
            }
        }

        // --- RESIZER LOGIC ---
        const resizerX = document.getElementById('resizerX');
        const leftPane = document.getElementById('leftPane');
        const resizerY = document.getElementById('resizerY');
        const htmlPane = document.getElementById('htmlPane');
        
        resizerX.addEventListener('mousedown', function(e) {
            e.preventDefault();
            document.body.style.cursor = 'col-resize';
            document.body.classList.add('resizing');
            const mouseMoveHandler = function(e) {
                const containerRect = resizerX.parentElement.getBoundingClientRect();
                const newLeftWidth = e.clientX - containerRect.left;
                if (newLeftWidth > 200 && newLeftWidth < containerRect.width - 200) {
                    leftPane.style.flexBasis = `${newLeftWidth}px`;
                }
            };
            const mouseUpHandler = function() {
                document.body.style.cursor = 'default';
                document.body.classList.remove('resizing');
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            };
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
        });

        resizerY.addEventListener('mousedown', function(e) {
            e.preventDefault();
            document.body.style.cursor = 'row-resize';
            document.body.classList.add('resizing');
            const mouseMoveHandler = function(e) {
                const containerRect = resizerY.parentElement.getBoundingClientRect();
                const newTopHeight = e.clientY - containerRect.top;
                if (newTopHeight > 50 && newTopHeight < containerRect.height - 50) {
                    htmlPane.style.flexBasis = `${newTopHeight}px`;
                }
            };
            const mouseUpHandler = function() {
                document.body.style.cursor = 'default';
                document.body.classList.remove('resizing');
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            };
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
        });

        // Event listeners for live updates
        htmlInput.addEventListener('input', updatePreview);
        jsonInput.addEventListener('input', updatePreview);
        generateJsonBtn.addEventListener('click', handleGenerateJson);

        // Initial setup on page load
        window.addEventListener('DOMContentLoaded', () => {
            htmlInput.value = ``;
            handleGenerateJson();
        });
    </script>
</body>
</html>
