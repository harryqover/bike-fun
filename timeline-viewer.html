<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurtech Policy Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .timeline-grid {
            background-image:
                linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 100%;
        }
        .policy-bar {
            position: absolute;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 12px;
            padding-right: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: grab;
            user-select: none;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 150ms ease-in-out, background-color 150ms ease-in-out;
            overflow: hidden;
            white-space: nowrap;
        }
        .policy-bar:active {
            cursor: grabbing;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .resize-handle {
            position: absolute;
            width: 8px;
            height: 100%;
            top: 0;
            cursor: col-resize;
            z-index: 10;
        }
        .resize-handle-left {
            left: 0;
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }
        .resize-handle-right {
            right: 0;
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        .policy-bar-master {
            height: 40px;
            z-index: 5;
            background: linear-gradient(135deg, #1e3a8a, #2563eb); /* Deep blue gradient */
            color: #e0e7ff;
        }
        .policy-bar-risk {
            background: linear-gradient(135deg, #064e3b, #10b981); /* Emerald gradient */
            color: #d1fae5;
        }
        .policy-bar-cancelled {
             background: linear-gradient(135deg, #7f1d1d, #ef4444); /* Red gradient */
             color: #fee2e2;
        }
        .policy-bar-renewed {
             background: linear-gradient(135deg, #581c87, #a855f7); /* Purple gradient */
             color: #f3e8ff;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">
    <div id="app" class="h-screen w-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 px-6 py-3 flex items-center justify-between z-40 flex-shrink-0">
            <h1 class="text-xl font-bold text-gray-100">Insurtech Policy Visualizer</h1>
            <div class="flex items-center space-x-2">
                <div class="flex items-center bg-gray-700 rounded-lg p-1">
                    <button id="zoomOutBtn" title="Zoom Out" class="p-2 rounded-md hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button id="zoomInBtn" title="Zoom In" class="p-2 rounded-md hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div class="w-px h-6 bg-gray-600 mx-2"></div>
                <button id="importProductConfigBtn" title="Import Product Configuration" class="bg-purple-600 hover:bg-purple-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    Import Product Config
                </button>
                <input type="file" id="importProductConfigFile" class="hidden" accept="application/json">
                <button id="importJsonBtn" title="Import from JSON" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    Import
                </button>
                <input type="file" id="importFile" class="hidden" accept="application/json">
                <button id="exportJsonBtn" title="Export to JSON" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Export
                </button>
                <button id="addMasterPolicyBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Master Policy
                </button>
                <button id="addRiskItemBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Risk Item
                </button>
                 <button id="clearAllBtn" title="Clear Timeline" class="bg-red-700 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    Clear All
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col relative overflow-hidden">
            <div id="timeline-container" class="flex-grow w-full h-full overflow-auto relative">
                <div id="timeline-canvas" class="relative timeline-grid">
                    <!-- Policies will be rendered here by JS -->
                </div>
            </div>
             <!-- Timeline Ruler -->
            <div id="timeline-ruler-container" class="flex-shrink-0 bg-gray-800 border-t border-gray-700 w-full h-16">
                 <div id="timeline-ruler" class="relative h-full">
                    <!-- Ruler ticks and labels will be rendered here by JS -->
                 </div>
            </div>
        </main>
        
        <!-- Tooltip -->
        <div id="tooltip" class="absolute z-50 p-2 text-sm bg-gray-900/80 backdrop-blur-sm text-white rounded-md shadow-lg pointer-events-none opacity-0 transition-opacity duration-200"></div>

        <!-- Edit Modal -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-6">Edit Policy Details</h2>
                <form id="editForm">
                    <input type="hidden" id="policyId">
                    <div class="mb-4">
                        <label for="policyName" class="block text-sm font-medium text-gray-300 mb-1">Policy Name</label>
                        <input type="text" id="policyName" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                     <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="policyStartDate" class="block text-sm font-medium text-gray-300 mb-1">Start Date</label>
                            <input type="date" id="policyStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="policyEndDate" class="block text-sm font-medium text-gray-300 mb-1">End Date</label>
                            <input type="date" id="policyEndDate" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="policyStatus" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <select id="policyStatus" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="active">Active</option>
                            <option value="renewed">Renewed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="pricingVersion" class="block text-sm font-medium text-gray-300 mb-1">Pricing Version</label>
                        <input type="text" id="pricingVersion" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div class="flex justify-between items-center">
                         <button type="button" id="deletePolicyBtn" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Delete</button>
                        <div>
                            <button type="button" id="cancelEdit" class="text-gray-400 hover:text-white font-semibold py-2 px-4 rounded-lg mr-2 transition">Cancel</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition">Save Changes</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Clear Confirmation Modal -->
        <div id="clearConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-4">Clear Timeline?</h2>
                <p class="text-gray-400 mb-8">Are you sure you want to delete all policies? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" id="cancelClearBtn" class="text-gray-300 hover:text-white font-semibold py-2 px-6 rounded-lg transition bg-gray-700 hover:bg-gray-600">Cancel</button>
                    <button type="button" id="confirmClearBtn" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition">Confirm & Clear</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-4">Delete Policy?</h2>
                <p class="text-gray-400 mb-8">Are you sure you want to delete this policy? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" id="cancelDeleteBtn" class="text-gray-300 hover:text-white font-semibold py-2 px-6 rounded-lg transition bg-gray-700 hover:bg-gray-600">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition">Confirm & Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const timelineContainer = document.getElementById('timeline-container');
        const timelineCanvas = document.getElementById('timeline-canvas');
        const timelineRulerContainer = document.getElementById('timeline-ruler-container');
        const timelineRuler = document.getElementById('timeline-ruler');
        const tooltip = document.getElementById('tooltip');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const clearConfirmModal = document.getElementById('clearConfirmModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        
        // --- Configuration ---
        const ROW_HEIGHT = 48; // Vertical gap between policies
        const ZOOM_LEVELS = [0.5, 1, 2, 5, 10, 20]; // Pixels per day
        let currentZoomIndex = 3; // Start with 5px per day
        let PIXELS_PER_DAY = ZOOM_LEVELS[currentZoomIndex];
        const SNAP_GRID_SIZE = 1; // Snap to 1 pixel

        // --- State ---
        let policies = [];
        let nextPolicyId = 1;
        let dragInfo = {
            isDragging: false,
            isResizing: false,
            policy: null,
            startX: 0,
            originalX: 0,
            originalWidth: 0,
            resizeDirection: null
        };
        let timelineStartDate = new Date();
        let timelineEndDate = new Date();

        // --- Utility Functions ---
        const calculateTimelineBounds = () => {
            if (policies.length === 0) {
                const today = new Date();
                timelineStartDate = new Date(today.getFullYear(), 0, 1); // Start of current year
                timelineEndDate = new Date(today.getFullYear(), 11, 31); // End of current year
                return;
            }

            const allDates = policies.flatMap(p => [new Date(p.startDate + "T00:00:00"), new Date(p.endDate + "T00:00:00")]);
            let minDate = new Date(Math.min.apply(null, allDates));
            let maxDate = new Date(Math.max.apply(null, allDates));
            
            // Add 1 month padding
            minDate.setMonth(minDate.getMonth() - 1);
            maxDate.setMonth(maxDate.getMonth() + 1);
            
            // Round to start/end of month
            timelineStartDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            timelineEndDate = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);
        };
        
        const dateToPixels = (date) => {
            const dateObj = (date instanceof Date) ? date : new Date(date + "T00:00:00");
            const diffTime = dateObj - timelineStartDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            return diffDays * PIXELS_PER_DAY;
        };

        const pixelsToDate = (pixels) => {
            const diffDays = Math.round(pixels / PIXELS_PER_DAY);
            const newDate = new Date(timelineStartDate);
            newDate.setDate(timelineStartDate.getDate() + diffDays);
            return newDate.toISOString().split('T')[0];
        };

        const getNextAvailableRow = () => {
            if (policies.length === 0) return 0;
            return Math.max(...policies.map(p => p.row)) + 1;
        };

        const updateNextPolicyId = () => {
            if (policies.length === 0) {
                nextPolicyId = 1;
            } else {
                nextPolicyId = Math.max(...policies.map(p => p.id)) + 1;
            }
        };
        
        // --- Rendering ---
        const renderTimeline = () => {
            timelineCanvas.innerHTML = '';
            policies.forEach(policy => {
                const policyEl = document.createElement('div');
                policyEl.className = `policy-bar policy-bar-${policy.type} policy-bar-${policy.status}`;
                policyEl.dataset.id = policy.id;
                
                const left = dateToPixels(policy.startDate);
                const right = dateToPixels(policy.endDate);
                const width = right - left + PIXELS_PER_DAY; // Add one day width

                policyEl.style.left = `${left}px`;
                policyEl.style.width = `${width}px`;
                policyEl.style.top = `${policy.row * ROW_HEIGHT + 4}px`; // Add some top padding

                const nameEl = document.createElement('span');
                nameEl.textContent = `${policy.name} (${policy.pricingVersion})`;
                nameEl.className = 'truncate pr-2';

                const resizeHandleLeft = document.createElement('div');
                resizeHandleLeft.className = 'resize-handle resize-handle-left';
                resizeHandleLeft.dataset.direction = 'left';

                const resizeHandleRight = document.createElement('div');
                resizeHandleRight.className = 'resize-handle resize-handle-right';
                resizeHandleRight.dataset.direction = 'right';

                policyEl.appendChild(nameEl);
                policyEl.appendChild(resizeHandleLeft);
                policyEl.appendChild(resizeHandleRight);

                timelineCanvas.appendChild(policyEl);
            });
            timelineCanvas.style.height = `${(getNextAvailableRow() + 2) * ROW_HEIGHT}px`;
        };
        
        const renderRuler = () => {
            timelineRuler.innerHTML = '';
            let currentDate = new Date(timelineStartDate);

            while(currentDate <= timelineEndDate) {
                const monthWrapper = document.createElement('div');
                const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                const monthWidth = daysInMonth * PIXELS_PER_DAY;
                
                monthWrapper.className = 'absolute h-full flex flex-col items-start justify-between border-l border-gray-600';
                monthWrapper.style.left = `${dateToPixels(currentDate)}px`;
                monthWrapper.style.width = `${monthWidth}px`;
                
                const monthLabel = document.createElement('div');
                monthLabel.className = 'text-xs text-gray-400 pt-2 pl-2';
                monthLabel.textContent = currentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric'});
                
                const dayContainer = document.createElement('div');
                dayContainer.className = 'flex w-full h-6 items-end relative';
                
                if (PIXELS_PER_DAY >= 2) {
                    let dayCounter = new Date(currentDate);
                    for(let d=0; d<daysInMonth; d++){
                        const isMonday = dayCounter.getDay() === 1;
                        const tick = document.createElement('div');
                        tick.className = 'absolute border-l';
                        tick.style.left = `${d * PIXELS_PER_DAY}px`;
                        
                        if (isMonday) {
                            tick.className += ' border-gray-500 h-3';
                        } else {
                            tick.className += ' border-gray-700 h-2';
                        }

                        if (PIXELS_PER_DAY >= 10 && (d + 1) % 5 === 0) {
                            const dayLabel = document.createElement('span');
                            dayLabel.className = 'absolute -bottom-4 text-[10px] text-gray-500 transform -translate-x-1/2';
                            dayLabel.textContent = d + 1;
                            dayLabel.style.left = `${(d * PIXELS_PER_DAY)}px`;
                            tick.appendChild(dayLabel);
                        }
                        
                        dayContainer.appendChild(tick);
                        dayCounter.setDate(dayCounter.getDate() + 1);
                    }
                }
                
                monthWrapper.appendChild(monthLabel);
                monthWrapper.appendChild(dayContainer);
                timelineRuler.appendChild(monthWrapper);
                
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        };

        const renderAll = () => {
            calculateTimelineBounds();
            const totalDays = (timelineEndDate - timelineStartDate) / (1000 * 60 * 60 * 24);
            const timelineWidth = totalDays * PIXELS_PER_DAY;
            timelineCanvas.style.width = `${timelineWidth}px`;
            timelineRuler.style.width = `${timelineWidth}px`;
            renderRuler();
            renderTimeline();
            updateNextPolicyId();
        };

        // --- Drag, Drop, and Resize Logic ---
        const handleMouseDown = (e) => {
            if (e.target.closest('.policy-bar')) {
                const policyEl = e.target.closest('.policy-bar');
                const policy = policies.find(p => p.id === parseInt(policyEl.dataset.id));
                if (!policy) return;

                dragInfo = {
                    policy,
                    startX: e.clientX,
                    originalX: policyEl.offsetLeft,
                    originalWidth: policyEl.offsetWidth,
                };
                
                if (e.target.classList.contains('resize-handle')) {
                    dragInfo.isResizing = true;
                    dragInfo.resizeDirection = e.target.dataset.direction;
                } else {
                    dragInfo.isDragging = true;
                    policyEl.style.cursor = 'grabbing';
                }

                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
            }
        };

        const handleMouseMove = (e) => {
            e.preventDefault();
            if (!dragInfo.policy) return;

            const policy = dragInfo.policy;
            const policyEl = timelineCanvas.querySelector(`[data-id='${policy.id}']`);
            const dx = e.clientX - dragInfo.startX;

            if (dragInfo.isDragging) {
                const newLeft = dragInfo.originalX + dx;
                const snappedLeft = Math.round(newLeft / SNAP_GRID_SIZE) * SNAP_GRID_SIZE;
                policyEl.style.left = `${snappedLeft}px`;

                const newStartDate = pixelsToDate(snappedLeft);
                const durationDays = (new Date(policy.endDate) - new Date(policy.startDate)) / (1000 * 60 * 60 * 24);
                const newEndDate = new Date(newStartDate + "T00:00:00");
                newEndDate.setDate(newEndDate.getDate() + durationDays);
                showTooltip(e, `${newStartDate} to ${newEndDate.toISOString().split('T')[0]}`);

            } else if (dragInfo.isResizing) {
                if (dragInfo.resizeDirection === 'left') {
                    const newLeft = dragInfo.originalX + dx;
                    const newWidth = dragInfo.originalWidth - dx;
                    if (newWidth > PIXELS_PER_DAY) {
                         const snappedLeft = Math.round(newLeft / SNAP_GRID_SIZE) * SNAP_GRID_SIZE;
                         const snappedWidth = Math.round(newWidth / SNAP_GRID_SIZE) * SNAP_GRID_SIZE;
                         policyEl.style.left = `${snappedLeft}px`;
                         policyEl.style.width = `${snappedWidth}px`;
                         showTooltip(e, `${pixelsToDate(snappedLeft)} to ${policy.endDate}`);
                    }
                } else { // right
                    const newWidth = dragInfo.originalWidth + dx;
                    if (newWidth > PIXELS_PER_DAY) {
                        const snappedWidth = Math.round(newWidth / SNAP_GRID_SIZE) * SNAP_GRID_SIZE;
                        policyEl.style.width = `${snappedWidth}px`;
                        const newEndDate = pixelsToDate(policyEl.offsetLeft + snappedWidth - PIXELS_PER_DAY);
                        showTooltip(e, `${policy.startDate} to ${newEndDate}`);
                    }
                }
            }
        };

        const handleMouseUp = (e) => {
            if (dragInfo.policy) {
                const policy = dragInfo.policy;
                const policyEl = timelineCanvas.querySelector(`[data-id='${policy.id}']`);
                if(dragInfo.isDragging) {
                    policy.startDate = pixelsToDate(policyEl.offsetLeft);
                    const durationDays = Math.round((new Date(dragInfo.policy.endDate) - new Date(dragInfo.policy.startDate)) / (1000 * 60 * 60 * 24));
                    const newEndDate = new Date(policy.startDate + "T00:00:00");
                    newEndDate.setDate(newEndDate.getDate() + durationDays);
                    policy.endDate = newEndDate.toISOString().split('T')[0];
                } else if (dragInfo.isResizing) {
                    if (dragInfo.resizeDirection === 'left') {
                        policy.startDate = pixelsToDate(policyEl.offsetLeft);
                    } else {
                        policy.endDate = pixelsToDate(policyEl.offsetLeft + policyEl.offsetWidth - PIXELS_PER_DAY);
                    }
                }
                policyEl.style.cursor = 'grab';
            }
            dragInfo = {};
            hideTooltip();
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
            renderAll();
        };
        
        const showTooltip = (e, text) => {
            tooltip.textContent = text;
            tooltip.style.opacity = '1';
            tooltip.style.left = `${e.clientX + 15}px`;
            tooltip.style.top = `${e.clientY + 15}px`;
        };
        
        const hideTooltip = () => tooltip.style.opacity = '0';

        timelineContainer.addEventListener('scroll', () => {
             timelineRulerContainer.scrollLeft = timelineContainer.scrollLeft;
        });

        // --- Modal Logic ---
        const openEditModal = (policyId) => {
            const policy = policies.find(p => p.id === policyId);
            if (policy) {
                document.getElementById('policyId').value = policy.id;
                document.getElementById('policyName').value = policy.name;
                document.getElementById('policyStartDate').value = policy.startDate;
                document.getElementById('policyEndDate').value = policy.endDate;
                document.getElementById('policyStatus').value = policy.status;
                document.getElementById('pricingVersion').value = policy.pricingVersion;
                editModal.classList.remove('hidden');
            }
        };

        const closeEditModal = () => editModal.classList.add('hidden');
        
        timelineCanvas.addEventListener('dblclick', (e) => {
            const policyEl = e.target.closest('.policy-bar');
            if (policyEl) {
                openEditModal(parseInt(policyEl.dataset.id));
            }
        });

        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('policyId').value);
            const policy = policies.find(p => p.id === id);
            if (policy) {
                policy.name = document.getElementById('policyName').value;
                policy.status = document.getElementById('policyStatus').value;
                policy.pricingVersion = document.getElementById('pricingVersion').value;
                policy.startDate = document.getElementById('policyStartDate').value;
                policy.endDate = document.getElementById('policyEndDate').value;
                closeEditModal();
                renderAll();
            }
        });

        document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
        
        document.getElementById('deletePolicyBtn').addEventListener('click', () => {
            deleteConfirmModal.classList.remove('hidden');
        });
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            const id = parseInt(document.getElementById('policyId').value);
            policies = policies.filter(p => p.id !== id);
            closeEditModal();
            deleteConfirmModal.classList.add('hidden');
            renderAll();
        });

        // --- Add/Import/Export/Clear ---
        const addPolicy = (type) => {
            const row = getNextAvailableRow();
            const centerDate = pixelsToDate(timelineContainer.scrollLeft + timelineContainer.clientWidth / 2);
            const startDate = new Date(centerDate + "T00:00:00");
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + (type === 'master' ? 365 : 90));

            const newPolicy = {
                id: nextPolicyId++,
                type: type,
                name: `New ${type === 'master' ? 'Master Policy' : 'Risk Item'}`,
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                status: 'active',
                pricingVersion: 'v1.0',
                row: row
            };
            policies.push(newPolicy);
            renderAll();
            openEditModal(newPolicy.id);
        };
        
        document.getElementById('addMasterPolicyBtn').addEventListener('click', () => addPolicy('master'));
        document.getElementById('addRiskItemBtn').addEventListener('click', () => addPolicy('risk'));

        const exportPolicies = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(policies, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "policies_export.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        const importPolicies = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedPolicies = JSON.parse(event.target.result);
                    if (Array.isArray(importedPolicies)) {
                        policies = importedPolicies;
                        renderAll();
                    } else {
                        console.error('Invalid JSON format. Expected an array of policies.');
                    }
                } catch (error) {
                    console.error('Error parsing JSON file:', error);
                }
            };
            reader.readAsText(file);
            e.target.value = null;
        };

        document.getElementById('exportJsonBtn').addEventListener('click', exportPolicies);
        document.getElementById('importJsonBtn').addEventListener('click', () => document.getElementById('importFile').click());
        document.getElementById('importFile').addEventListener('change', importPolicies);

        const importProductConfig = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const productData = JSON.parse(event.target.result);
                    const isSingleMasterPolicy = !Array.isArray(productData) && productData.productConfiguration;
                    const configs = isSingleMasterPolicy ? [productData] : Array.isArray(productData) ? productData : [];

                    if (configs.length === 0) {
                         console.error('Invalid JSON format. Expected an array of product configurations or a single master policy object.');
                         return;
                    }

                    const newPolicies = [];
                    let tempId = 1;
                    const rowMap = new Map();
                    let nextRow = 0;

                    const sortedConfigs = configs.sort((a,b) => new Date(a._effectivePeriod.startDate) - new Date(b._effectivePeriod.startDate));
                    
                    for (const config of sortedConfigs) {
                         if (!rowMap.has(config.code)) {
                            rowMap.set(config.code, nextRow);
                            nextRow += 1;
                        }

                        const name = isSingleMasterPolicy ? config.policyNumber : `${config.code} - Product Config`;
                        const pricingVersion = isSingleMasterPolicy ? `v${config.productConfiguration.version}`: `v${config.version}`;
                        const startDate = config.contractPeriod?.startDate || config._effectivePeriod.startDate;
                        let endDate = config.contractPeriod?.endDate;

                        if (!endDate) {
                            const nextVersion = sortedConfigs.find(c => c.code === config.code && new Date(c._effectivePeriod.startDate) > new Date(startDate));
                            if (nextVersion) {
                                const nextStartDate = new Date(nextVersion._effectivePeriod.startDate);
                                nextStartDate.setDate(nextStartDate.getDate() - 1);
                                endDate = nextStartDate.toISOString().split('T')[0];
                            } else {
                                const defaultEndDate = new Date(startDate);
                                defaultEndDate.setFullYear(defaultEndDate.getFullYear() + 1);
                                endDate = defaultEndDate.toISOString().split('T')[0];
                            }
                        }

                        newPolicies.push({
                            id: tempId++,
                            type: 'master',
                            name: name,
                            startDate: startDate,
                            endDate: endDate,
                            status: 'active',
                            pricingVersion: pricingVersion,
                            row: rowMap.get(config.code || (isSingleMasterPolicy && config.productConfiguration.id))
                        });
                    }
                    policies = newPolicies;
                    renderAll();
                } catch (error) {
                    console.error('Error parsing Product Config JSON file:', error);
                }
            };
            reader.readAsText(file);
            e.target.value = null;
        };

        document.getElementById('importProductConfigBtn').addEventListener('click', () => document.getElementById('importProductConfigFile').click());
        document.getElementById('importProductConfigFile').addEventListener('change', importProductConfig);

        const openClearModal = () => clearConfirmModal.classList.remove('hidden');
        const closeClearModal = () => clearConfirmModal.classList.add('hidden');

        document.getElementById('clearAllBtn').addEventListener('click', openClearModal);
        document.getElementById('cancelClearBtn').addEventListener('click', closeClearModal);
        clearConfirmModal.addEventListener('click', (e) => {
            if (e.target === clearConfirmModal) closeClearModal();
        });
        document.getElementById('confirmClearBtn').addEventListener('click', () => {
            policies = [];
            renderAll();
            closeClearModal();
        });

        // --- Zoom Logic ---
        const zoom = (direction) => {
            const scrollLeftPixels = timelineContainer.scrollLeft;
            const centerXPixels = scrollLeftPixels + timelineContainer.clientWidth / 2;
            const centerDate = pixelsToDate(centerXPixels);

            if (direction === 'in' && currentZoomIndex < ZOOM_LEVELS.length - 1) {
                currentZoomIndex++;
            } else if (direction === 'out' && currentZoomIndex > 0) {
                currentZoomIndex--;
            } else {
                return;
            }
            PIXELS_PER_DAY = ZOOM_LEVELS[currentZoomIndex];
            
            renderAll();

            const newCenterPixels = dateToPixels(centerDate);
            const newScrollLeft = newCenterPixels - timelineContainer.clientWidth / 2;
            timelineContainer.scrollLeft = newScrollLeft;
            timelineRulerContainer.scrollLeft = newScrollLeft;
        };

        document.getElementById('zoomInBtn').addEventListener('click', () => zoom('in'));
        document.getElementById('zoomOutBtn').addEventListener('click', () => zoom('out'));

        // --- Initialization ---
        const init = () => {
            renderAll();
            timelineCanvas.addEventListener('mousedown', handleMouseDown);
        };

        init();
    });
    </script>
</body>
</html>

