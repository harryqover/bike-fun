<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Request Travel Certificate</title>
  <style>
    :root {
      --primary-color: #0062FF; --primary-hover: #005ae0; --text-color: #2c3e50;
      --light-text-color: #7f8c8d; --border-color: #bdc3c7; --background-color: #f8f9fa;
      --error-color: #e74c3c; --success-color: #2ecc71; --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .container { background-color: #ffffff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); width: 100%; max-width: 600px; }
    h1 { font-size: 28px; margin: 0 0 10px; text-align: center; }
    p { text-align: center; color: var(--light-text-color); margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-weight: 600; margin-bottom: 8px; }
    input[type="text"], input[type="email"], input[type="date"], select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
    input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 98, 255, 0.2); }
    .btn { width: 100%; padding: 14px; border-radius: 6px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-secondary { background-color: #e9ecef; color: var(--text-color); border: 1px solid var(--border-color); }
    .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    #message-area, #final-message-area { text-align: center; padding: 12px; border-radius: 6px; margin-top: 20px; font-weight: 500; display: none; }
    .message-success { background-color: #eafaf1; color: var(--success-color); border: 1px solid var(--success-color); }
    .message-error { background-color: #fdedec; color: var(--error-color); border: 1px solid var(--error-color); }
    .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 18px; height: 18px; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #certificate-details-form { display: none; }
    .insured-person-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .insured-person-row input { flex-grow: 1; }
    .insured-person-row button { padding: 8px 12px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; cursor: pointer; line-height: 1; }
    hr { border: none; border-top: 1px solid #eee; margin: 30px 0; }
    .flex-inputs { display: flex; gap: 20px; }
    .flex-inputs .form-group { flex: 1; }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; cursor: pointer; }
    .file-input-button { border: 1px solid var(--border-color); background-color: #e9ecef; color: var(--text-color); padding: 12px; border-radius: 6px; display: block; text-align: center; }
    .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    #file-name-display { margin-top: 10px; color: var(--light-text-color); font-style: italic; text-align: center; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Travel Certificate Request</h1>
      <p>Please enter your policy number and email to begin.</p>
    </header>

    <form id="policy-check-form">
      <div class="form-group"><label for="policyNumber">Policy Number</label><input type="text" id="policyNumber" placeholder="e.g., M-ABC123456-7891011" required></div>
      <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" placeholder="you@example.com" required></div>
      <button type="submit" id="check-policy-btn" class="btn btn-primary"><span>Verify Policy</span></button>
      <div id="message-area"></div>
    </form>

    <form id="certificate-details-form">
      <hr>
      <div class="form-group">
        <label>Policyholder Details</label>
        <div class="flex-inputs">
          <div class="form-group" style="margin-bottom:0;"><input type="text" id="policyholderFirstName" placeholder="First Name" required></div>
          <div class="form-group" style="margin-bottom:0;"><input type="text" id="policyholderLastName" placeholder="Last Name" required></div>
        </div>
      </div>
      <div class="form-group">
        <label>Travel Dates</label>
        <div class="flex-inputs">
          <div class="form-group"><label for="startDate" style="font-size:14px; font-weight:500;">Start Date</label><input type="date" id="startDate" required></div>
          <div class="form-group"><label for="endDate" style="font-size:14px; font-weight:500;">End Date</label><input type="date" id="endDate" required></div>
        </div>
      </div>
      <div class="form-group">
        <label>Additional Insured Persons</label>
        <div id="insured-persons-container"></div>
        <button type="button" id="add-person-btn" class="btn btn-secondary" style="margin-top: 10px; width: auto; padding: 10px 15px;">+ Add Person</button>
      </div>
      <div class="form-group">
        <label for="family-document">Proof of Family Relation</label>
        <div class="file-input-wrapper"><div class="file-input-button">Choose File</div><input type="file" id="family-document" required></div>
        <div id="file-name-display">No file selected</div>
      </div>
      <button type="submit" id="request-certificate-btn" class="btn btn-primary"><span>Request Certificate</span></button>
      <div id="final-message-area"></div>
    </form>
  </div>

  <script>
    // The AppScript Alchemist
    // Version: 5.1 - Removed pre-filling of name for GDPR compliance.
    console.log('Version: 5.1 - Frontend for Travel Certificate Request Form');

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGRc1epP58gKZKPu-3RQsa4fBlPAsF0lgabw3PHaxszN0J8owcw_frQQRPwaw4vdcYhQ/exec";
    let validatedProduct = null;

    const policyCheckForm = document.getElementById('policy-check-form');
    const policyInput = document.getElementById('policyNumber');
    const emailInput = document.getElementById('email');
    const checkPolicyBtn = document.getElementById('check-policy-btn');
    const messageArea = document.getElementById('message-area');
    
    const detailsForm = document.getElementById('certificate-details-form');
    const requestCertBtn = document.getElementById('request-certificate-btn');
    const finalMessageArea = document.getElementById('final-message-area');
    const fileInput = document.getElementById('family-document');
    const fileNameDisplay = document.getElementById('file-name-display');

    policyCheckForm.addEventListener('submit', event => {
      event.preventDefault();
      validatePolicyAndEmail();
    });

    fileInput.addEventListener('change', () => {
      fileNameDisplay.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'No file selected';
    });

    async function validatePolicyAndEmail() {
      const policyNumber = policyInput.value.trim();
      const email = emailInput.value.trim();
      if (!policyNumber || !email) {
        showMessage('Please enter both a policy number and an email address.', 'error', messageArea);
        return;
      }
      setLoadingState(true, checkPolicyBtn, "Verifying...");
      const payload = { action: "checkPolicy", policyNumber, email };
      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
        const result = await res.json();
        handleValidationSuccess(result);
      } catch (error) {
        handleValidationFailure(error);
      }
    }

    function handleValidationSuccess(response) {
      setLoadingState(false, checkPolicyBtn, "Verify Policy");
      showMessage(response.message, response.success ? 'success' : 'error', messageArea);
      if (response.success) {
        validatedProduct = response.data.product;
        // The following lines that pre-filled the name have been removed.
        // document.getElementById('policyholderFirstName').value = response.data.firstName || '';
        // document.getElementById('policyholderLastName').value = response.data.lastName || '';
        policyCheckForm.style.display = 'none';
        detailsForm.style.display = 'block';
      }
    }

    function handleValidationFailure(error) {
      setLoadingState(false, checkPolicyBtn, "Verify Policy");
      showMessage('An error occurred while contacting the server. ' + error.message, 'error', messageArea);
    }
    
    detailsForm.addEventListener('submit', async event => {
        event.preventDefault();
        setLoadingState(true, requestCertBtn, "Submitting...");

        const file = fileInput.files[0];
        if (!detailsForm.checkValidity() || !file) {
            showMessage("Please fill all required fields, including the proof of relation document.", 'error', finalMessageArea);
            setLoadingState(false, requestCertBtn, "Request Certificate");
            return;
        }

        try {
            const datePayload = { action: "validateDates", product: validatedProduct, startDate: document.getElementById('startDate').value, endDate: document.getElementById('endDate').value };
            const dateRes = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(datePayload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
            const dateResult = await dateRes.json();

            if (!dateResult.success) {
                showMessage(dateResult.message, 'error', finalMessageArea);
                setLoadingState(false, requestCertBtn, "Request Certificate");
                return;
            }

            const fileData = await readFileAsBase64(file);
            const finalPayload = collectFinalData(fileData);
            
            const finalRes = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(finalPayload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
            const finalResult = await finalRes.json();

            if (finalResult.success) {
                showMessage(finalResult.message, 'success', finalMessageArea);
                detailsForm.reset();
                fileNameDisplay.textContent = 'No file selected';
            } else {
                showMessage(finalResult.message, 'error', finalMessageArea);
            }
        } catch (error) {
            showMessage('An error occurred during the final submission. ' + error.message, 'error', finalMessageArea);
        } finally {
            setLoadingState(false, requestCertBtn, "Request Certificate");
        }
    });

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve({ base64Data: reader.result.split(',')[1], mimeType: file.type, fileName: file.name });
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    function collectFinalData(fileData) {
        const insuredPersons = [];
        document.querySelectorAll('.insured-person-row').forEach(row => {
            insuredPersons.push({ name: row.querySelector('input').value, relationship: row.querySelector('select').value });
        });
        return {
            action: "createCertificate",
            policyHolderEmail: emailInput.value,
            policyNumber: policyInput.value,
            policyholderFirstName: document.getElementById('policyholderFirstName').value,
            policyholderLastName: document.getElementById('policyholderLastName').value,
            travelStartDate: document.getElementById('startDate').value,
            travelEndDate: document.getElementById('endDate').value,
            insureds: insuredPersons,
            fileData: fileData
        };
    }

    let personId = 0;
    document.getElementById('add-person-btn').addEventListener('click', () => {
        personId++;
        const personRow = document.createElement('div');
        personRow.className = 'insured-person-row';
        personRow.id = `person-row-${personId}`;
        personRow.innerHTML = `<input type="text" placeholder="First & Last Name" required><select required><option value="" disabled selected>Relationship</option><option value="Spouse">Spouse</option><option value="Child">Child</option><option value="Parent">Parent</option><option value="Other">Other</option></select><button type="button" onclick="document.getElementById('person-row-${personId}').remove()">×</button>`;
        document.getElementById('insured-persons-container').appendChild(personRow);
    });

    function setLoadingState(isLoading, button, text) {
      button.disabled = isLoading;
      if (isLoading) {
        if (!button.dataset.originalText) button.dataset.originalText = button.textContent.trim();
        button.innerHTML = `<div class="spinner"></div><span>${text}</span>`;
      } else {
        const originalText = button.dataset.originalText || text;
        button.innerHTML = `<span>${originalText}</span>`;
        delete button.dataset.originalText;
      }
    }

    function showMessage(text, type, element) {
      element.textContent = text;
      element.className = type === 'success' ? 'message-success' : 'message-error';
      element.style.display = 'block';
    }
  </script>
</body>
</html>
