<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Insurance Quote</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .step { display: none; border: 1px solid #ccc; padding: 20px; margin-top: 15px; border-radius: 5px; }
        .step.active { display: block; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .input-group { display: flex; gap: 10px; }
        .input-group > div { flex: 1; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; margin-right: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        .error { color: red; font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; min-height: 1em; }
        .package-options { display: flex; justify-content: space-around; margin-top: 20px; flex-wrap: wrap; }
        .package { border: 1px solid #eee; padding: 15px; margin: 10px; border-radius: 5px; text-align: center; width: 28%; min-width: 200px; }
        .package h3 { margin-top: 0; }
        .package .price { font-size: 1.4em; font-weight: bold; margin: 10px 0; }
        .package button { width: 100%; }
        .optional-coverages { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; }
        .optional-coverages label { display: inline-block; margin-right: 15px; font-weight: normal; }
        .summary { background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .summary h3 { margin-top: 0; }
        #totalPriceSummary { font-size: 1.2em; font-weight: bold; }
        #medicalConditionCheck label { display: inline; font-weight: normal; }
        #medicalConditionCheck input { width: auto; margin-right: 5px;}
        .beneficiary-fields { border: 1px dashed #eee; padding: 15px; margin-top: 15px; border-radius: 4px; }
        .beneficiary-fields legend { font-weight: bold; padding: 0 5px; }
        /* Updated Loading Indicators */
        #loadingIndicator { display: none; margin-top: 10px; color: #555; font-style: italic;}
        #quoteLoadingIndicator { display: none; margin-top: 10px; color: #555; font-weight: bold; }
        #apiError, #quoteApiError { display: none; color: red; margin-top: 10px; font-weight: bold;}
        #quoteSuccess { display: none; color: green; margin-top: 10px; font-weight: bold;} /* Kept for potential future use */
    </style>
</head>
<body>

<h1>Get Your Annual Travel Insurance Quote</h1>

<div id="step1" class="step active">
    <h2>Step 1: Tell us about your plan</h2>
    <form id="tripForm">
        <div>
            <label for="tripZone">Primary Travel Zone:</label>
            <select id="tripZone" name="tripZone" required>
                <option value="">-- Select Zone --</option>
                <option value="ZONE_EUROPE">Europe</option>
                <option value="ZONE_WORLD_EXCLUDING_USA">Worldwide (excluding USA/Canada)</option>
                <option value="ZONE_WORLD_INCLUDING_USA">Worldwide (including USA/Canada)</option>
            </select>
             <small>Select the main region you plan to travel to during the year.</small>
            <div class="error" id="tripZoneError"></div>
        </div>
        <div>
            <label for="familyType">Who needs cover?</label>
            <select id="familyType" name="familyType" required>
                <option value="">-- Select Option --</option>
                <option value="FAMILY_TYPE_INDIVIDUAL">Individual (Just Me)</option>
                <option value="FAMILY_TYPE_COUPLE">Couple (Me + 1 Adult)</option>
                <option value="FAMILY_TYPE_FAMILY">Family (Me + 1 Adult + Child/Children)</option>
            </select>
            <div class="error" id="familyTypeError"></div>
        </div>
        <div>
            <label for="startDate">Coverage Start Date:</label>
            <input type="date" id="startDate" name="startDate" required>
             <small>Your policy will be valid for 1 year from this date.</small>
            <div class="error" id="startDateError"></div>
        </div>
        <div id="medicalConditionCheck">
            <label>Medical Condition Declaration:</label>
            <input type="checkbox" id="noMedicalCondition" name="noMedicalCondition" value="true" required>
            <span>I confirm that no traveller has pre-existing medical conditions.</span>
            <div class="error" id="noMedicalConditionError"></div>
        </div>
        <button type="button" id="btnStep1Next">Next: Policyholder Details</button>
    </form>
</div>

<div id="step2" class="step">
    <h2>Step 2: Policyholder Details</h2>
    <form id="policyholderForm">
         <div class="input-group">
            <div><label for="phFirstName">First Name:</label><input type="text" id="phFirstName" name="phFirstName" required><div class="error" id="phFirstNameError"></div></div>
            <div><label for="phLastName">Last Name:</label><input type="text" id="phLastName" name="phLastName" required><div class="error" id="phLastNameError"></div></div>
        </div>
         <div class="input-group">
             <div><label for="phBirthdate">Birthdate:</label><input type="date" id="phBirthdate" name="phBirthdate" required><div class="error" id="phBirthdateError"></div></div>
             <div><label for="phEmail">Email:</label><input type="email" id="phEmail" name="phEmail" required><div class="error" id="phEmailError"></div></div>
        </div>
         <div><label for="phPhone">Phone:</label><input type="tel" id="phPhone" name="phPhone" placeholder="+32..." required><div class="error" id="phPhoneError"></div></div>
        <fieldset>
            <legend>Address</legend>
            <div class="input-group">
                 <div><label for="phStreet">Street:</label><input type="text" id="phStreet" name="phStreet" required><div class="error" id="phStreetError"></div></div>
                 <div><label for="phNumber">Number:</label><input type="text" id="phNumber" name="phNumber" required><div class="error" id="phNumberError"></div></div>
            </div>
            <div class="input-group">
                 <div><label for="phZip">Zip Code:</label><input type="text" id="phZip" name="phZip" required><div class="error" id="phZipError"></div></div>
                 <div><label for="phCity">City:</label><input type="text" id="phCity" name="phCity" required><div class="error" id="phCityError"></div></div>
                 <div><label for="phCountry">Country:</label><select id="phCountry" name="phCountry" required><option value="BE">Belgium</option></select><div class="error" id="phCountryError"></div></div>
            </div>
        </fieldset>
        <div id="beneficiarySection" style="display: none;">
            <h3>Other Travellers</h3>
            <div id="beneficiary1" class="beneficiary-fields">
                 <legend>Partner Details</legend>
                 <div class="input-group">
                    <div><label for="b1FirstName">First Name:</label><input type="text" id="b1FirstName" name="b1FirstName"><div class="error" id="b1FirstNameError"></div></div>
                    <div><label for="b1LastName">Last Name:</label><input type="text" id="b1LastName" name="b1LastName"><div class="error" id="b1LastNameError"></div></div>
                    <div><label for="b1Birthdate">Birthdate:</label><input type="date" id="b1Birthdate" name="b1Birthdate"><div class="error" id="b1BirthdateError"></div></div>
                </div>
            </div>
             <div id="beneficiary2" class="beneficiary-fields" style="display: none;">
                 <legend>Child Details</legend>
                 <div class="input-group">
                    <div><label for="b2FirstName">First Name:</label><input type="text" id="b2FirstName" name="b2FirstName"><div class="error" id="b2FirstNameError"></div></div>
                    <div><label for="b2LastName">Last Name:</label><input type="text" id="b2LastName" name="b2LastName"><div class="error" id="b2LastNameError"></div></div>
                    <div><label for="b2Birthdate">Birthdate:</label><input type="date" id="b2Birthdate" name="b2Birthdate"><div class="error" id="b2BirthdateError"></div></div>
                </div>
            </div>
        </div>
        <button type="button" id="btnStep2Back">Back</button>
        <button type="button" id="btnStep2Next">Get Prices</button>
        <div id="loadingIndicator">Fetching prices... <img src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" alt="loading" width="16"></div>
        <div id="apiError"></div>
    </form>
</div>


<div id="step3" class="step">
    <h2>Step 3: Choose your plan</h2>
    <p>Based on your selection: <span id="tripInfoSummaryPrices"></span></p>
    <div class="package-options">
        <div class="package" id="packageBasic">
            <h3>Basic</h3>
            <div class="price">€ <span id="priceBasic">--</span></div>
            <button type="button" class="btnSelectPackage" data-package="MULTIPERILBASIC" data-package-name="Basic">Select Basic</button>
        </div>
        <div class="package" id="packagePlus">
            <h3>Plus</h3>
            <div class="price">€ <span id="pricePlus">--</span></div>
             <button type="button" class="btnSelectPackage" data-package="MULTIPERILPLUS" data-package-name="Plus">Select Plus</button>
        </div>
        <div class="package" id="packagePremium">
            <h3>Premium</h3>
             <div class="price">€ <span id="pricePremium">--</span></div>
             <button type="button" class="btnSelectPackage" data-package="MULTIPERILPREMIUM" data-package-name="Premium">Select Premium</button>
        </div>
    </div>
    <div class="optional-coverages">
        <h3>Optional Coverages</h3>
        <div id="optionWinterSports"><input type="checkbox" id="winterSports" name="winterSports"><label for="winterSports">Winter Sports (+ € <span id="priceWinterSports">--</span>)</label></div>
        <div id="optionCarHireExcess"><input type="checkbox" id="carHireExcess" name="carHireExcess" disabled><label for="carHireExcess">Car Hire Excess (+ € <span id="priceCarHireExcess">--</span>)</label><small id="carHireMsg">(Only available for Europe Zone)</small></div>
        <div id="optionExcessWaiver"><input type="checkbox" id="excessWaiver" name="excessWaiver"><label for="excessWaiver">Excess Waiver (+ € <span id="priceExcessWaiver">--</span>)</label></div>
    </div>
    <button type="button" id="btnStep3Back">Back</button>
    <button type="button" id="btnStep3Next" disabled>Next: Summary</button>
</div>

<div id="step4" class="step">
    <h2>Step 4: Summary</h2>
    <div class="summary">
        <h3>Your Selection</h3>
        <p><strong>Primary Travel Zone:</strong> <span id="summaryTripZone"></span></p>
        <p><strong>Travellers Covered:</strong> <span id="summaryFamilyType"></span></p>
        <p><strong>Policyholder:</strong> <span id="summaryPolicyholder"></span></p>
        <div id="summaryBeneficiariesList"></div>
        <p><strong>Coverage Start Date:</strong> <span id="summaryDates"></span> (Valid for 1 year)</p>
        <hr>
        <p><strong>Selected Plan:</strong> <span id="summaryPackage"></span></p>
        <p><strong>Base Price (Annual):</strong> € <span id="summaryBasePrice"></span></p>
        <div id="summaryOptionalCoverages">
            <p><strong>Optional Coverages (Annual):</strong></p>
            <ul></ul>
        </div>
        <hr>
        <p><strong>Total Price (Annual, inc. Taxes):</strong> € <span id="totalPriceSummary">--</span></p>
    </div>
    <button type="button" id="btnStep4Back">Back</button>
    <button type="button" id="btnProceedToPayment">Create Quote & Proceed to Payment</button>
     <div id="quoteLoadingIndicator">Creating your quote and preparing payment link... <img src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" alt="loading" width="16"></div> <div id="quoteApiError"></div>
     <div id="quoteSuccess"></div> </div>

<script>
$(document).ready(function() {

    // --- Configuration ---
    const PRICE_API_ENDPOINT = 'https://api.sbx.qover.io/policies/v1/product-configurations/tui-demo-multi/versions/effective/packages';
    const QUOTE_API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwoXRnQGpQOMDyRGGS4z5RrKeB-a1KT5hTWx9J3G-cpt3MOeDqootMdPny6L6FrbQaM/exec'; // Your Apps Script URL
    const PRICE_API_KEY = 'sk_B4B9BB9B72E44E264D40'; // SECURITY RISK - Use backend proxy
    const PARTNER_ID = "6810e8b75bc1edd801534d9d";

    // Package Definitions (derived from tui-product-config.json)
    const packageDefinitions = {
        'MULTIPERILBASIC': {
            coverages: { "cancellation": "basic", "assistance": "basic", "medicalExpenses": "basic", "hospitalBenefit": "basic", "personalAccident": "basic", "baggages": "basic", "moneyAndDocuments": "basic", "personalLiability": "basic", "missedDeparture": "basic", "delayedDeparture": "basic" },
            optionalCoverages: { "winterSports": "basic", "carHireExcess": "basic", "excessWaiver": "default" }
        },
        'MULTIPERILPLUS': {
             coverages: { "cancellation": "plus", "assistance": "plus", "medicalExpenses": "plus", "hospitalBenefit": "plus", "personalAccident": "plus", "baggages": "plus", "moneyAndDocuments": "plus", "personalLiability": "plus", "hijack": "plus", "missedDeparture": "plus", "catastrophe": "plus", "delayedDeparture": "plus", "holidayAbandonment": "plus", "creditCardFraud": "plus", "legalExpenses": "plus", "strike": "plus" },
            optionalCoverages: { "winterSports": "plus", "carHireExcess": "plus", "excessWaiver": "default" }
        },
        'MULTIPERILPREMIUM': {
             coverages: { "cancellation": "premium", "assistance": "premium", "medicalExpenses": "premium", "hospitalBenefit": "premium", "personalAccident": "premium", "baggages": "premium", "moneyAndDocuments": "premium", "personalLiability": "premium", "hijack": "premium", "missedDeparture": "premium", "catastrophe": "premium", "delayedDeparture": "premium", "holidayAbandonment": "premium", "creditCardFraud": "premium", "legalExpenses": "premium", "strike": "premium" },
             optionalCoverages: { "winterSports": "premium", "carHireExcess": "premium", "excessWaiver": "default" }
        }
    };

    // State variables
    let currentStep = 1;
    let quoteData = {};
    let apiPrices = { packages: {}, optionals: {}, rawOptionals: {} };
    let selectedPackage = null;
    let selectedOptionals = {};

    // --- Core Functions (navigateToStep, clearErrors, Validation, API calls, etc.) ---
    function navigateToStep(step) { /* ... (keep as before) ... */
        $('.step').removeClass('active');
        $('#step' + step).addClass('active');
        currentStep = step;
         if (step !== 4) {
             $('#quoteLoadingIndicator').hide();
             $('#quoteApiError').hide().text('');
             $('#quoteSuccess').hide().text('');
         }
     }
    function clearErrors() { /* ... (keep as before) ... */
        $('.error').text('');
        $('#apiError').hide().text('');
        $('#quoteApiError').hide().text('');
    }
    function validateStep1() { /* ... (keep as before) ... */
         let isValid = true;
         clearErrors();
         const tripZone = $('#tripZone').val();
         const familyType = $('#familyType').val();
         const startDate = $('#startDate').val();
         const noMedical = $('#noMedicalCondition').is(':checked');
         const today = new Date().toISOString().split('T')[0];
         if (!tripZone) { $('#tripZoneError').text('Please select a trip zone.'); isValid = false; }
         if (!familyType) { $('#familyTypeError').text('Please select who needs cover.'); isValid = false; }
         if (!startDate) { $('#startDateError').text('Please select a start date.'); isValid = false; }
         else if (startDate < today) { $('#startDateError').text('Start date cannot be in the past.'); isValid = false; }
         if (!noMedical) { $('#noMedicalConditionError').text('You must confirm no pre-existing medical conditions to proceed.'); isValid = false; }
         return isValid;
     }
    function getAge(birthDateString) { /* ... (keep as before) ... */
        if (!birthDateString) return 0;
        try {
            const today = new Date();
            const birthDate = new Date(birthDateString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
            return age;
        } catch (e) { return 0; }
    }
    function validateStep2() { /* ... (keep as before) ... */
         let isValid = true;
         clearErrors();
         const familyType = $('#familyType').val();
         if (!$('#phFirstName').val()) { $('#phFirstNameError').text('First name required.'); isValid = false; }
         if (!$('#phLastName').val()) { $('#phLastNameError').text('Last name required.'); isValid = false; }
         if (!$('#phEmail').val()) { $('#phEmailError').text('Email required.'); isValid = false; }
          else if (!/^\S+@\S+\.\S+$/.test($('#phEmail').val())) { $('#phEmailError').text('Invalid email format.'); isValid = false;}
         if (!$('#phPhone').val()) { $('#phPhoneError').text('Phone number required.'); isValid = false; }
         if (!$('#phBirthdate').val()) { $('#phBirthdateError').text('Birthdate required.'); isValid = false; }
         else { const age = getAge($('#phBirthdate').val()); if (age < 18) { $('#phBirthdateError').text('Must be 18+.'); isValid = false; } if (age >= 76) { $('#phBirthdateError').text('Must be under 76.'); isValid = false; } }
         if (!$('#phStreet').val()) { $('#phStreetError').text('Street required.'); isValid = false; }
         if (!$('#phNumber').val()) { $('#phNumberError').text('Number required.'); isValid = false; }
         if (!$('#phZip').val()) { $('#phZipError').text('Zip code required.'); isValid = false; }
         if (!$('#phCity').val()) { $('#phCityError').text('City required.'); isValid = false; }
         if (!$('#phCountry').val()) { $('#phCountryError').text('Country required.'); isValid = false; }
         if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') {
              if (!$('#b1FirstName').val()) { $('#b1FirstNameError').text('First name required.'); isValid = false; }
              if (!$('#b1LastName').val()) { $('#b1LastNameError').text('Last name required.'); isValid = false; }
              if (!$('#b1Birthdate').val()) { $('#b1BirthdateError').text('Birthdate required.'); isValid = false; }
         }
         if (familyType === 'FAMILY_TYPE_FAMILY') {
             if (!$('#b2FirstName').val()) { $('#b2FirstNameError').text('First name required.'); isValid = false; }
             if (!$('#b2LastName').val()) { $('#b2LastNameError').text('Last name required.'); isValid = false; }
             if (!$('#b2Birthdate').val()) { $('#b2BirthdateError').text('Birthdate required.'); isValid = false; }
         }
         return isValid;
     }
    function callPricingAPI() { /* ... (keep as before) ... */
        clearErrors();
        $('#loadingIndicator').show();
        $('#btnStep2Next').prop('disabled', true);
        const extraBeneficiaries = [];
        const familyType = $('#familyType').val();
        if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') { extraBeneficiaries.push({ firstName: $('#b1FirstName').val(), lastName: $('#b1LastName').val(), birthdate: $('#b1Birthdate').val() }); }
        if (familyType === 'FAMILY_TYPE_FAMILY') { extraBeneficiaries.push({ firstName: $('#b2FirstName').val(), lastName: $('#b2LastName').val(), birthdate: $('#b2Birthdate').val() }); }
        const startDateValue = $('#startDate').val();
        const startsAtValue = `${startDateValue}T00:00:00.000Z`;
        const payload = { partnerId: PARTNER_ID, policyholder: { email: $('#phEmail').val(), entityType: "ENTITY_TYPE_PERSON", phone: $('#phPhone').val(), firstName: $('#phFirstName').val(), lastName: $('#phLastName').val(), birthdate: $('#phBirthdate').val(), address: { street: $('#phStreet').val(), number: $('#phNumber').val(), zip: $('#phZip').val(), city: $('#phCity').val(), country: $('#phCountry').val() } }, country: $('#phCountry').val(), subject: { familyType: familyType, tripZone: $('#tripZone').val(), noMedicalCondition: $('#noMedicalCondition').is(':checked'), ...(extraBeneficiaries.length > 0 && { extraBeneficiaries: extraBeneficiaries }) }, contractPeriod: { timeZone: "Europe/Brussels", startDate: startDateValue, startsAt: startsAtValue } };
        console.log("Price API Payload:", JSON.stringify(payload, null, 2));
        $.ajax({ url: `${PRICE_API_ENDPOINT}?apikey=${PRICE_API_KEY}`, type: 'POST', contentType: 'application/json', data: JSON.stringify(payload),
            success: function(response) {
                console.log("Price API Response:", response); $('#loadingIndicator').hide(); $('#btnStep2Next').prop('disabled', false);
                if (response && response.packages) { processApiResponse(response.packages); $('#tripInfoSummaryPrices').text(`Zone: ${$('#tripZone option:selected').text()}, Travellers: ${$('#familyType option:selected').text()}, Coverage Start: ${$('#startDate').val()}`); selectedPackage = null; $('.btnSelectPackage').prop('disabled', false).text(function() { return $(this).data('package-name') ? `Select ${$(this).data('package-name')}` : 'Select'; }); $('#btnStep3Next').prop('disabled', true); $('#winterSports, #carHireExcess, #excessWaiver').prop('checked', false); navigateToStep(3); }
                else { $('#apiError').text('Invalid response received from pricing API.').show(); }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Price API Error:", textStatus, errorThrown, jqXHR.responseText); $('#loadingIndicator').hide(); $('#btnStep2Next').prop('disabled', false); let errorMsg = 'Failed to fetch prices. Please try again.'; if (jqXHR.responseJSON && jqXHR.responseJSON.message) { errorMsg = jqXHR.responseJSON.message; } else if (jqXHR.responseText) { try { const errData = JSON.parse(jqXHR.responseText); if(errData.message && errData.message.includes("JSON schema validation failed")){ errorMsg = `API Error: ${errData.message} (Details: ${errData.errors?.[0]?.message || 'Unknown validation issue'})`; } else if (errData.message) { errorMsg = `API Error: ${errData.message}`; } } catch(e) { /* ignore */ } } $('#apiError').text(errorMsg).show();
            }
        });
     }
    function processApiResponse(packagesData) { /* ... (keep as before) ... */
         console.log("Processing API Response Data:", packagesData);
         apiPrices = { packages: { 'MULTIPERILBASIC': 0, 'MULTIPERILPLUS': 0, 'MULTIPERILPREMIUM': 0 }, optionals: { 'winterSports': 0, 'carHireExcess': 0, 'excessWaiver': 0 }, rawOptionals: {} };
         const packageCodes = ['MULTIPERILBASIC', 'MULTIPERILPLUS', 'MULTIPERILPREMIUM'];
         packageCodes.forEach(code => {
            let totalCip = 0; const packageInfo = packagesData[code]; console.log(`--- Processing Package: ${code} ---`);
            if (packageInfo && packageInfo.coverages) {
                Object.entries(packageInfo.coverages).forEach(([coverageCode, coverage]) => {
                     const variantKey = Object.keys(coverage.variants)[0]; if (!variantKey) { console.warn(`No variant key for ${coverageCode} in ${code}`); return; }
                     const cipValue = coverage.variants[variantKey]?.premium?.cip; console.log(` -> Coverage: ${coverageCode}, Variant: ${variantKey}, CIP: ${cipValue}`);
                     if (typeof cipValue === 'number' && !isNaN(cipValue)) { totalCip += cipValue; } else { console.warn(`Invalid CIP for ${coverageCode} in ${code}`); } });
                console.log(`Total CIP for ${code}: ${totalCip}`); apiPrices.packages[code] = totalCip;
                if (packageInfo.optionalCoverages) {
                    apiPrices.rawOptionals[code] = {}; console.log(`Optional for ${code}:`, packageInfo.optionalCoverages);
                     Object.entries(packageInfo.optionalCoverages).forEach(([optCode, optCoverage]) => {
                         const variantKey = Object.keys(optCoverage.variants)[0]; if (!variantKey) { console.warn(`No variant key for optional ${optCode} in ${code}`); return; }
                         const optionalCipValue = optCoverage.variants[variantKey]?.premium?.cip; console.log(` -> Optional: ${optCode}, Variant: ${variantKey}, CIP: ${optionalCipValue}`);
                         if(typeof optionalCipValue === 'number' && !isNaN(optionalCipValue)) { apiPrices.rawOptionals[code][optCode] = optionalCipValue; }
                         else { console.warn(`Invalid CIP for optional ${optCode} in ${code}`); } });
                     console.log(`Stored Optional for ${code}:`, apiPrices.rawOptionals[code]);
                } else { console.log(`No Optional found for ${code}`); }
            } else { console.warn(`Package data missing/invalid: ${code}`); }
            let displayId; if (code === 'MULTIPERILBASIC') displayId = '#priceBasic'; else if (code === 'MULTIPERILPLUS') displayId = '#pricePlus'; else if (code === 'MULTIPERILPREMIUM') displayId = '#pricePremium'; else { console.error(`Unexpected code: ${code}`); return; }
            const priceElement = $(displayId);
            if(priceElement.length) { const priceToShow = apiPrices.packages[code]; if (typeof priceToShow === 'number' && !isNaN(priceToShow)) { priceElement.text(priceToShow.toFixed(2)); console.log(`Updated ${displayId}: ${priceToShow.toFixed(2)}`); } else { priceElement.text('--'); console.warn(`Invalid price for ${displayId}:`, priceToShow); } }
            else { console.error(`Element ${displayId} not found!`); }
         });
        updateOptionalPriceDisplay(packageCodes[0]);
        if ($('#tripZone').val() === 'ZONE_EUROPE') { $('#carHireExcess').prop('disabled', false); $('#carHireMsg').hide(); } else { $('#carHireExcess').prop('disabled', true).prop('checked', false); $('#carHireMsg').show(); }
        console.log("--- Finished processing API response ---"); console.log("Stored API Prices:", apiPrices);
     }
    function updateOptionalPriceDisplay(selectedPackageCode) { /* ... (keep as before) ... */
         const optionalsForPackage = apiPrices.rawOptionals[selectedPackageCode] || {}; console.log(`Updating optionals display for ${selectedPackageCode}:`, optionalsForPackage);
         apiPrices.optionals.winterSports = optionalsForPackage['winterSports'] ?? 0;
         apiPrices.optionals.carHireExcess = optionalsForPackage['carHireExcess'] ?? 0;
         apiPrices.optionals.excessWaiver = optionalsForPackage['excessWaiver'] ?? 0;
         $('#priceWinterSports').text(apiPrices.optionals.winterSports.toFixed(2));
         $('#priceCarHireExcess').text(apiPrices.optionals.carHireExcess.toFixed(2));
         $('#priceExcessWaiver').text(apiPrices.optionals.excessWaiver.toFixed(2));
         console.log(`Display prices: Winter=${apiPrices.optionals.winterSports.toFixed(2)}, CarHire=${apiPrices.optionals.carHireExcess.toFixed(2)}, Waiver=${apiPrices.optionals.excessWaiver.toFixed(2)}`);
     }
    function updateTotal() { /* ... (keep as before) ... */
        if (!selectedPackage) { $('#btnStep3Next').prop('disabled', true); return; }
        let base = selectedPackage.basePrice; let optionalTotal = 0; selectedOptionals = {};
        if ($('#winterSports').is(':checked')) { optionalTotal += apiPrices.optionals.winterSports; selectedOptionals.winterSports = { name: 'Winter Sports', price: apiPrices.optionals.winterSports }; }
        if ($('#carHireExcess').is(':checked') && !$('#carHireExcess').is(':disabled')) { optionalTotal += apiPrices.optionals.carHireExcess; selectedOptionals.carHireExcess = { name: 'Car Hire Excess', price: apiPrices.optionals.carHireExcess }; }
        if ($('#excessWaiver').is(':checked')) { optionalTotal += apiPrices.optionals.excessWaiver; selectedOptionals.excessWaiver = { name: 'Excess Waiver', price: apiPrices.optionals.excessWaiver }; }
        let total = base + optionalTotal;
        $('#totalPriceSummary').text(total.toFixed(2)); $('#btnStep3Next').prop('disabled', false);
     }
    function populateSummary() { /* ... (keep as before) ... */
        const zoneText = $('#tripZone option:selected').text(); const familyText = $('#familyType option:selected').text(); const startDateText = $('#startDate').val();
        $('#summaryTripZone').text(zoneText); $('#summaryFamilyType').text(familyText); $('#summaryPolicyholder').text(`${$('#phFirstName').val()} ${$('#phLastName').val()} (${$('#phEmail').val()})`); $('#summaryDates').text(`${startDateText}`); $('#summaryPackage').text(selectedPackage.name); $('#summaryBasePrice').text(selectedPackage.basePrice.toFixed(2));
        const $beneficiaryList = $('#summaryBeneficiariesList').empty(); const beneficiaries = quoteData.beneficiaries || [];
        if (beneficiaries.length > 0) { const $ul = $('<ul></ul>').appendTo($('<p><strong>Other Travellers Covered:</strong></p>').appendTo($beneficiaryList)); beneficiaries.forEach(b => { $('<li>').text(`${b.firstName} ${b.lastName} (${b.birthdate})`).appendTo($ul); }); }
        const $optionalList = $('#summaryOptionalCoverages ul'); $optionalList.empty(); let optionalTotal = 0;
        if (Object.keys(selectedOptionals).length > 0) { $('#summaryOptionalCoverages').show(); $.each(selectedOptionals, function(key, item) { $('<li>').text(`${item.name} (+ € ${item.price.toFixed(2)})`).appendTo($optionalList); optionalTotal += item.price; }); }
        else { $('#summaryOptionalCoverages').hide(); }
        let total = selectedPackage.basePrice + optionalTotal; $('#totalPriceSummary').text(total.toFixed(2));
     }
    function getUrlParameter(name) { /* ... (keep as before) ... */
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]'); var regex = new RegExp('[\\?&]' + name + '=([^&#]*)'); var results = regex.exec(location.search); return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    function getTomorrowDate() { /* ... (keep as before) ... */
        const today = new Date(); const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1); const year = tomorrow.getFullYear(); const month = String(tomorrow.getMonth() + 1).padStart(2, '0'); const day = String(tomorrow.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`;
    }
    function prefillTestData() { /* ... (keep as before) ... */
        console.log("Prefilling test data..."); $('#tripZone').val('ZONE_EUROPE'); $('#familyType').val('FAMILY_TYPE_INDIVIDUAL'); $('#startDate').val(getTomorrowDate()); $('#noMedicalCondition').prop('checked', true); $('#phFirstName').val('John'); $('#phLastName').val('Doe'); $('#phBirthdate').val('1988-03-31'); $('#phEmail').val('harry+test@qover.com'); $('#phPhone').val('+32486910819'); $('#phStreet').val('Rue du Commerce'); $('#phNumber').val('31'); $('#phZip').val('1000'); $('#phCity').val('Brussels'); $('#phCountry').val('BE'); $('#familyType').trigger('change'); console.log("Test data prefilled.");
    }

     // --- Event Handlers (keep as before, except #btnProceedToPayment) ---
     $('#familyType').change(function() { /* ... */ });
     $('#btnStep1Next').click(function() { /* ... */ });
     $('#btnStep2Back').click(function() { navigateToStep(1); });
     $('#btnStep2Next').click(function() { /* ... */ });
     $('#btnStep3Back').click(function() { navigateToStep(2); });
     $('.btnSelectPackage').click(function() { /* ... */ });
     $('#winterSports, #carHireExcess, #excessWaiver').change(function() { updateTotal(); });
     $('#btnStep3Next').click(function() { if (selectedPackage) { populateSummary(); navigateToStep(4); } });
     $('#btnStep4Back').click(function() { navigateToStep(3); });

    // --- *** UPDATED #btnProceedToPayment Handler *** ---
    $('#btnProceedToPayment').click(function() {
        if (!selectedPackage || !quoteData.trip || !quoteData.policyholder) {
            alert("Cannot proceed. Please ensure you have selected a package and filled all details.");
            return;
        }

        // Show loading indicator and disable button
        $('#quoteLoadingIndicator').show(); // Show specific loading message
        $('#quoteApiError').hide().text('');
        $('#quoteSuccess').hide().text('');
        $(this).prop('disabled', true);

        // 1. Determine the coverages object for the payload
        const coveragesForPayload = {};
        const basePackageDef = packageDefinitions[selectedPackage.code];

        if (!basePackageDef) {
             console.error("Could not find package definition for:", selectedPackage.code);
             $('#quoteApiError').text('Internal error: Package definition not found.').show();
             $('#quoteLoadingIndicator').hide();
             $(this).prop('disabled', false);
             return;
        }

         // Add base coverages with correct variant
         Object.assign(coveragesForPayload, basePackageDef.coverages);

        // Add selected optional coverages with correct variant
        // Use the *keys* from selectedOptionals ('winterSports', 'carHireExcess', 'excessWaiver')
        $.each(selectedOptionals, (optKey) => {
             if (basePackageDef.optionalCoverages.hasOwnProperty(optKey)) {
                 coveragesForPayload[optKey] = basePackageDef.optionalCoverages[optKey]; // Get the variant ('basic', 'plus', 'premium', 'default')
             } else {
                 console.warn(`Optional coverage key '${optKey}' selected but not found in package definition for ${selectedPackage.code}`);
             }
        });

        console.log("Coverages for Quote Payload:", coveragesForPayload);

         // 2. Construct the final payload for the quote API
        const finalPayload = {
             action: "createQuote",
             env: "sbx", // Assuming 'sbx' based on your example
             payload: {
                productConfigurationId: "tui-demo-multi",
                partnerId: PARTNER_ID,
                package: {
                    name: selectedPackage.code,
                    coverages: coveragesForPayload
                },
                policyholder: {
                    ...quoteData.policyholder,
                    entityType: "ENTITY_TYPE_PERSON"
                },
                country: quoteData.policyholder.address.country,
                language: "en", // Assuming English
                subject: {
                    familyType: quoteData.trip.familyType,
                    tripZone: quoteData.trip.tripZone,
                    noMedicalCondition: quoteData.trip.noMedicalCondition,
                    ...(quoteData.beneficiaries && quoteData.beneficiaries.length > 0 && { extraBeneficiaries: quoteData.beneficiaries })
                },
                contractPeriod: {
                    timeZone: "Europe/Brussels",
                    startDate: quoteData.trip.startDate
                }
             }
        };

        console.log("Quote API Payload:", JSON.stringify(finalPayload, null, 2));

        // 3. Make the API call to Google Apps Script
        $.ajax({
             url: QUOTE_API_ENDPOINT,
             type: 'POST',
             contentType: 'application/json',
             data: JSON.stringify(finalPayload),
             success: function(response) {
                 console.log("Quote API Response:", response);
                 $('#quoteLoadingIndicator').hide();
                 // Keep button disabled on success before redirect

                 // --- SUCCESS HANDLING & REDIRECT ---
                 if (response && response.status === "success" && response.payUrl) {
                     console.log("Quote created successfully. Redirecting to:", response.payUrl);
                     // Optional: show a very brief success message before redirect
                     // $('#quoteSuccess').text('Quote created! Redirecting to payment...').show();
                     // Redirect to the payment URL
                     window.location.href = response.payUrl;
                     // No need to re-enable button as we are leaving the page
                 } else {
                     // Handle cases where status is not success or payUrl is missing
                     const errorDetail = response?.message || `Status: ${response?.status}, PayURL missing: ${!response?.payUrl}`;
                     $('#quoteApiError').text(`Quote creation failed or response invalid. Details: ${errorDetail}`).show();
                     console.error("Quote API Response indicates failure or missing payUrl:", response);
                      $('#btnProceedToPayment').prop('disabled', false); // Re-enable button on failure
                 }
             },
             error: function(jqXHR, textStatus, errorThrown) {
                 console.error("Quote API Error:", textStatus, errorThrown, jqXHR.responseText);
                 $('#quoteLoadingIndicator').hide();
                 $('#btnProceedToPayment').prop('disabled', false); // Re-enable button on error
                 let errorMsg = 'Failed to create quote. Please try again.';
                 if (jqXHR.responseText) {
                    try {
                         if (jqXHR.responseText.toLowerCase().includes("scripterror") || jqXHR.responseText.toLowerCase().includes("exception")) {
                             errorMsg = "An error occurred while creating the quote via the script.";
                         } else {
                             const errData = JSON.parse(jqXHR.responseText);
                             if (errData.message) { errorMsg = `Quote API Error: ${errData.message}`; }
                              else if (jqXHR.responseText.length < 200) { errorMsg = `Quote API Error: ${jqXHR.responseText}`; }
                         }
                    } catch (e) { if (jqXHR.responseText.length < 200) { errorMsg = `Quote API Error: ${jqXHR.responseText}`; } }
                 }
                  $('#quoteApiError').text(errorMsg).show();
             }
         });
    });
    // --- *** END UPDATED #btnProceedToPayment Handler *** ---

    // --- Initial Setup ---
    const today = new Date().toISOString().split('T')[0];
    $('#phBirthdate, #b1Birthdate, #b2Birthdate').attr('max', today);
    $('#startDate').attr('min', today);

    if (getUrlParameter('test') === 'true') {
        prefillTestData();
    }

});
</script>

</body>
</html>