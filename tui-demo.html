<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Insurance Quote</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .step { display: none; border: 1px solid #ccc; padding: 20px; margin-top: 15px; border-radius: 5px; }
        .step.active { display: block; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .input-group { display: flex; gap: 10px; }
        .input-group > div { flex: 1; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; margin-right: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        .error { color: red; font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; min-height: 1em; }
        .package-options { display: flex; justify-content: space-around; margin-top: 20px; flex-wrap: wrap; }
        .package { border: 1px solid #eee; padding: 15px; margin: 10px; border-radius: 5px; text-align: center; width: 28%; min-width: 200px; }
        .package h3 { margin-top: 0; }
        .package .price { font-size: 1.4em; font-weight: bold; margin: 10px 0; }
        .package button { width: 100%; }
        .optional-coverages { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; }
        .optional-coverages label { display: inline-block; margin-right: 15px; font-weight: normal; }
        .summary { background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .summary h3 { margin-top: 0; }
        #totalPriceSummary { font-size: 1.2em; font-weight: bold; }
        #medicalConditionCheck label { display: inline; font-weight: normal; }
        #medicalConditionCheck input { width: auto; margin-right: 5px;}
        .beneficiary-fields { border: 1px dashed #eee; padding: 15px; margin-top: 15px; border-radius: 4px; }
        .beneficiary-fields legend { font-weight: bold; padding: 0 5px; }
        #loadingIndicator { display: none; margin-top: 10px; color: #555; }
        #apiError { display: none; color: red; margin-top: 10px; font-weight: bold;}
    </style>
</head>
<body>

<h1>Get Your Annual Travel Insurance Quote</h1>

<div id="step1" class="step active">
    <h2>Step 1: Tell us about your plan</h2>
    <form id="tripForm">
        <div>
            <label for="tripZone">Primary Travel Zone:</label>
            <select id="tripZone" name="tripZone" required>
                <option value="">-- Select Zone --</option>
                <option value="ZONE_EUROPE">Europe</option>
                <option value="ZONE_WORLD_EXCLUDING_USA">Worldwide (excluding USA/Canada)</option>
                <option value="ZONE_WORLD_INCLUDING_USA">Worldwide (including USA/Canada)</option>
            </select>
             <small>Select the main region you plan to travel to during the year.</small>
            <div class="error" id="tripZoneError"></div>
        </div>
        <div>
            <label for="familyType">Who needs cover?</label>
            <select id="familyType" name="familyType" required>
                <option value="">-- Select Option --</option>
                <option value="FAMILY_TYPE_INDIVIDUAL">Individual (Just Me)</option>
                <option value="FAMILY_TYPE_COUPLE">Couple (Me + 1 Adult)</option>
                <option value="FAMILY_TYPE_FAMILY">Family (Me + 1 Adult + Child/Children)</option>
            </select>
            <div class="error" id="familyTypeError"></div>
        </div>
        <div>
            <label for="startDate">Coverage Start Date:</label>
            <input type="date" id="startDate" name="startDate" required>
             <small>Your policy will be valid for 1 year from this date.</small>
            <div class="error" id="startDateError"></div>
        </div>
        <div id="medicalConditionCheck">
            <label>Medical Condition Declaration:</label>
            <input type="checkbox" id="noMedicalCondition" name="noMedicalCondition" value="true" required>
            <span>I confirm that no traveller has pre-existing medical conditions.</span>
            <div class="error" id="noMedicalConditionError"></div>
        </div>
        <button type="button" id="btnStep1Next">Next: Policyholder Details</button>
    </form>
</div>

<div id="step2" class="step">
    <h2>Step 2: Policyholder Details</h2>
    <form id="policyholderForm">
         <div class="input-group">
            <div>
                <label for="phFirstName">First Name:</label>
                <input type="text" id="phFirstName" name="phFirstName" required>
                <div class="error" id="phFirstNameError"></div>
            </div>
            <div>
                <label for="phLastName">Last Name:</label>
                <input type="text" id="phLastName" name="phLastName" required>
                <div class="error" id="phLastNameError"></div>
            </div>
        </div>
         <div class="input-group">
             <div>
                <label for="phBirthdate">Birthdate:</label>
                <input type="date" id="phBirthdate" name="phBirthdate" required>
                <div class="error" id="phBirthdateError"></div>
            </div>
             <div>
                <label for="phEmail">Email:</label>
                <input type="email" id="phEmail" name="phEmail" required>
                <div class="error" id="phEmailError"></div>
            </div>
        </div>
         <div>
            <label for="phPhone">Phone:</label>
            <input type="tel" id="phPhone" name="phPhone" placeholder="+32..." required>
            <div class="error" id="phPhoneError"></div>
        </div>
        <fieldset>
            <legend>Address</legend>
            <div class="input-group">
                 <div>
                     <label for="phStreet">Street:</label>
                     <input type="text" id="phStreet" name="phStreet" required>
                     <div class="error" id="phStreetError"></div>
                 </div>
                 <div>
                    <label for="phNumber">Number:</label>
                    <input type="text" id="phNumber" name="phNumber" required>
                    <div class="error" id="phNumberError"></div>
                </div>
            </div>
            <div class="input-group">
                 <div>
                     <label for="phZip">Zip Code:</label>
                     <input type="text" id="phZip" name="phZip" required>
                     <div class="error" id="phZipError"></div>
                 </div>
                 <div>
                    <label for="phCity">City:</label>
                    <input type="text" id="phCity" name="phCity" required>
                     <div class="error" id="phCityError"></div>
                </div>
                 <div>
                    <label for="phCountry">Country:</label>
                    <select id="phCountry" name="phCountry" required>
                         <option value="BE">Belgium</option>
                         </select>
                     <div class="error" id="phCountryError"></div>
                </div>
            </div>
        </fieldset>

        <div id="beneficiarySection" style="display: none;">
            <h3>Other Travellers</h3>
            <div id="beneficiary1" class="beneficiary-fields">
                 <legend>Partner Details</legend>
                 <div class="input-group">
                    <div>
                        <label for="b1FirstName">First Name:</label>
                        <input type="text" id="b1FirstName" name="b1FirstName">
                        <div class="error" id="b1FirstNameError"></div>
                    </div>
                    <div>
                        <label for="b1LastName">Last Name:</label>
                        <input type="text" id="b1LastName" name="b1LastName">
                        <div class="error" id="b1LastNameError"></div>
                    </div>
                     <div>
                        <label for="b1Birthdate">Birthdate:</label>
                        <input type="date" id="b1Birthdate" name="b1Birthdate">
                        <div class="error" id="b1BirthdateError"></div>
                    </div>
                </div>
            </div>
             <div id="beneficiary2" class="beneficiary-fields" style="display: none;">
                 <legend>Child Details</legend>
                 <div class="input-group">
                    <div>
                        <label for="b2FirstName">First Name:</label>
                        <input type="text" id="b2FirstName" name="b2FirstName">
                        <div class="error" id="b2FirstNameError"></div>
                    </div>
                    <div>
                        <label for="b2LastName">Last Name:</label>
                        <input type="text" id="b2LastName" name="b2LastName">
                        <div class="error" id="b2LastNameError"></div>
                    </div>
                     <div>
                        <label for="b2Birthdate">Birthdate:</label>
                        <input type="date" id="b2Birthdate" name="b2Birthdate">
                        <div class="error" id="b2BirthdateError"></div>
                    </div>
                </div>
                 </div>
        </div>
         <button type="button" id="btnStep2Back">Back</button>
        <button type="button" id="btnStep2Next">Get Prices</button>
        <div id="loadingIndicator">Fetching prices... <img src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" alt="loading" width="16"></div>
        <div id="apiError"></div>
    </form>
</div>


<div id="step3" class="step">
    <h2>Step 3: Choose your plan</h2>
    <p>Based on your selection: <span id="tripInfoSummaryPrices"></span></p>
    <div class="package-options">
        <div class="package" id="packageBasic">
            <h3>Basic</h3>
            <div class="price">€ <span id="priceBasic">--</span></div>
            <button type="button" class="btnSelectPackage" data-package="MULTIPERILBASIC" data-package-name="Basic">Select Basic</button>
        </div>
        <div class="package" id="packagePlus">
            <h3>Plus</h3>
            <div class="price">€ <span id="pricePlus">--</span></div>
             <button type="button" class="btnSelectPackage" data-package="MULTIPERILPLUS" data-package-name="Plus">Select Plus</button>
        </div>
        <div class="package" id="packagePremium">
            <h3>Premium</h3>
             <div class="price">€ <span id="pricePremium">--</span></div>
             <button type="button" class="btnSelectPackage" data-package="MULTIPERILPREMIUM" data-package-name="Premium">Select Premium</button>
        </div>
    </div>

    <div class="optional-coverages">
        <h3>Optional Coverages</h3>
        <div id="optionWinterSports">
            <input type="checkbox" id="winterSports" name="winterSports">
            <label for="winterSports">Winter Sports (+ € <span id="priceWinterSports">--</span>)</label>
        </div>
         <div id="optionCarHireExcess">
            <input type="checkbox" id="carHireExcess" name="carHireExcess" disabled>
            <label for="carHireExcess">Car Hire Excess (+ € <span id="priceCarHireExcess">--</span>)</label>
            <small id="carHireMsg">(Only available for Europe Zone)</small>
        </div>
        <div id="optionExcessWaiver">
             <input type="checkbox" id="excessWaiver" name="excessWaiver">
             <label for="excessWaiver">Excess Waiver (+ € <span id="priceExcessWaiver">--</span>)</label>
        </div>
    </div>

    <button type="button" id="btnStep3Back">Back</button>
    <button type="button" id="btnStep3Next" disabled>Next: Summary</button>
</div>

<div id="step4" class="step">
    <h2>Step 4: Summary</h2>
    <div class="summary">
        <h3>Your Selection</h3>
        <p><strong>Primary Travel Zone:</strong> <span id="summaryTripZone"></span></p>
        <p><strong>Travellers Covered:</strong> <span id="summaryFamilyType"></span></p>
        <p><strong>Policyholder:</strong> <span id="summaryPolicyholder"></span></p>
        <div id="summaryBeneficiariesList"></div>
        <p><strong>Coverage Start Date:</strong> <span id="summaryDates"></span> (Valid for 1 year)</p>
        <hr>
        <p><strong>Selected Plan:</strong> <span id="summaryPackage"></span></p>
        <p><strong>Base Price (Annual):</strong> € <span id="summaryBasePrice"></span></p>
        <div id="summaryOptionalCoverages">
            <p><strong>Optional Coverages (Annual):</strong></p>
            <ul>
                </ul>
        </div>
        <hr>
        <p><strong>Total Price (Annual, inc. Taxes):</strong> € <span id="totalPriceSummary">--</span></p>
    </div>

    <div id="paymentLoadingIndicator" style="display: none; margin-top: 15px; color: #007bff; font-weight: bold;">
        Preparing your quote and payment page, please wait...
        <img src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" alt="loading" width="16" style="vertical-align: middle; margin-left: 5px;">
    </div>
    <div id="paymentApiError" class="error" style="display: none; margin-top: 10px; font-weight: bold;"></div>

    <button type="button" id="btnStep4Back">Back</button>
    <button type="button" id="btnProceedToPayment">Proceed to Payment</button>
</div>

<script>
$(document).ready(function() {

    // --- Configuration ---
    const API_ENDPOINT_PRICING = 'https://api.sbx.qover.io/policies/v1/product-configurations/tui-demo-multi/versions/effective/packages';
    // IMPORTANT: Storing API keys client-side is insecure. Use a backend proxy in production.
    const API_KEY = 'sk_B4B9BB9B72E44E264D40';
    const PARTNER_ID = "6810e8b75bc1edd801534d9d";
    // New endpoint for creating the quote via Google Apps Script
    const CREATE_QUOTE_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwoXRnQGpQOMDyRGGS4z5RrKeB-a1KT5hTWx9J3G-cpt3MOeDqootMdPny6L6FrbQaM/exec';


    let currentStep = 1;
    let quoteData = {}; // Will hold trip, policyholder, beneficiaries
    let apiPrices = { // Store prices fetched from API
        packages: {
            'MULTIPERILBASIC': 0,
            'MULTIPERILPLUS': 0,
            'MULTIPERILPREMIUM': 0
        },
        optionals: {
            'winterSports': 0,
            'carHireExcess': 0,
            'excessWaiver': 0
        },
        // Store raw optional data keyed by package name for lookup
        rawOptionals: {},
        // Store raw package data to access full coverage details if needed later
        rawPackages: {}
    };
    let selectedPackage = null; // { code: '', name: '', basePrice: 0 }
    let selectedOptionals = {}; // { winterSports: { name: 'Winter Sports', price: 0, code: 'winterSports' }, ... } // Added code property


    function navigateToStep(step) {
        $('.step').removeClass('active');
        $('#step' + step).addClass('active');
        currentStep = step;
        // Hide payment specific messages when navigating away from step 4
        if (step !== 4) {
            $('#paymentLoadingIndicator').hide();
            $('#paymentApiError').hide().text('');
        }
    }

    function clearErrors() {
        $('.error').text('');
        $('#apiError').hide().text('');
        $('#paymentApiError').hide().text(''); // Also clear payment error
    }

      // --- Validation Functions ---
      function validateStep1() {
        let isValid = true;
        clearErrors();
        const tripZone = $('#tripZone').val();
        const familyType = $('#familyType').val();
        const startDate = $('#startDate').val();
        const noMedical = $('#noMedicalCondition').is(':checked');
        const today = new Date().toISOString().split('T')[0];

        if (!tripZone) { $('#tripZoneError').text('Please select a trip zone.'); isValid = false; }
        if (!familyType) { $('#familyTypeError').text('Please select who needs cover.'); isValid = false; }
        if (!startDate) { $('#startDateError').text('Please select a start date.'); isValid = false; }
        else if (startDate < today) { $('#startDateError').text('Start date cannot be in the past.'); isValid = false; }
        if (!noMedical) { $('#noMedicalConditionError').text('You must confirm no pre-existing medical conditions to proceed.'); isValid = false; }

        return isValid;
      }

    function getAge(birthDateString) {
        if (!birthDateString) return 0;
        try {
            const today = new Date();
            const birthDate = new Date(birthDateString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        } catch (e) {
            return 0; // Handle invalid date format
        }
    }


      function validateStep2() {
        let isValid = true;
        clearErrors();
        const familyType = $('#familyType').val(); // Needed for beneficiary validation

        // Policyholder fields
        if (!$('#phFirstName').val()) { $('#phFirstNameError').text('First name required.'); isValid = false; }
        if (!$('#phLastName').val()) { $('#phLastNameError').text('Last name required.'); isValid = false; }
        if (!$('#phEmail').val()) { $('#phEmailError').text('Email required.'); isValid = false; }
         else if (!/^\S+@\S+\.\S+$/.test($('#phEmail').val())) { $('#phEmailError').text('Invalid email format.'); isValid = false;} // Basic email format check
        if (!$('#phPhone').val()) { $('#phPhoneError').text('Phone number required.'); isValid = false; }
        // Simple check for phone format (starts with + and has digits) - refine if needed
         else if (!/^\+\d+$/.test($('#phPhone').val())) { $('#phPhoneError').text('Invalid phone format (e.g., +324...).'); isValid = false;}
        if (!$('#phBirthdate').val()) {
              $('#phBirthdateError').text('Birthdate required.'); isValid = false;
        } else {
              const age = getAge($('#phBirthdate').val());
              if (age < 18) { $('#phBirthdateError').text('Policyholder must be at least 18 years old.'); isValid = false; }
              if (age >= 76) { $('#phBirthdateError').text('Policyholder must be under 76 years old.'); isValid = false; }
        }
        if (!$('#phStreet').val()) { $('#phStreetError').text('Street required.'); isValid = false; }
        if (!$('#phNumber').val()) { $('#phNumberError').text('Number required.'); isValid = false; }
        if (!$('#phZip').val()) { $('#phZipError').text('Zip code required.'); isValid = false; }
        if (!$('#phCity').val()) { $('#phCityError').text('City required.'); isValid = false; }
        if (!$('#phCountry').val()) { $('#phCountryError').text('Country required.'); isValid = false; }

        // Beneficiary fields (only if applicable)
        if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') {
              if (!$('#b1FirstName').val()) { $('#b1FirstNameError').text('First name required.'); isValid = false; }
              if (!$('#b1LastName').val()) { $('#b1LastNameError').text('Last name required.'); isValid = false; }
              if (!$('#b1Birthdate').val()) { $('#b1BirthdateError').text('Birthdate required.'); isValid = false; }
              // Add age validation for partner if needed (e.g., under 76)
               else if (getAge($('#b1Birthdate').val()) >= 76) { $('#b1BirthdateError').text('Partner must be under 76 years old.'); isValid = false; }

        }
        if (familyType === 'FAMILY_TYPE_FAMILY') {
              // Assuming only one child for now, matching API example
              if (!$('#b2FirstName').val()) { $('#b2FirstNameError').text('First name required.'); isValid = false; }
              if (!$('#b2LastName').val()) { $('#b2LastNameError').text('Last name required.'); isValid = false; }
              if (!$('#b2Birthdate').val()) { $('#b2BirthdateError').text('Birthdate required.'); isValid = false; }
               // Add age validation for child if needed (e.g., under 18 or 21)
               // Example: Check if child is 18 or older, which might be invalid depending on rules
               // else if (getAge($('#b2Birthdate').val()) >= 18) { $('#b2BirthdateError').text('Child must be under 18.'); isValid = false; }

        }

        return isValid;
      }

      // --- API Call and Price Handling ---
    function callPricingAPI() {
        clearErrors();
        $('#loadingIndicator').show();
        $('#btnStep2Next').prop('disabled', true);

        // 1. Construct Beneficiaries Array
        const extraBeneficiaries = [];
        const familyType = $('#familyType').val();
        if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') {
            extraBeneficiaries.push({
                firstName: $('#b1FirstName').val(),
                lastName: $('#b1LastName').val(),
                birthdate: $('#b1Birthdate').val()
            });
        }
        if (familyType === 'FAMILY_TYPE_FAMILY') {
            extraBeneficiaries.push({
                firstName: $('#b2FirstName').val(),
                lastName: $('#b2LastName').val(),
                birthdate: $('#b2Birthdate').val()
            });
        }

        // 2. Construct Payload
        const startDateValue = $('#startDate').val(); // YYYY-MM-DD
        const startsAtValue = `${startDateValue}T00:00:00.000Z`; // Combine date with time for ISO string

        const payload = {
            partnerId: PARTNER_ID,
            policyholder: {
                email: $('#phEmail').val(),
                entityType: "ENTITY_TYPE_PERSON",
                phone: $('#phPhone').val(),
                firstName: $('#phFirstName').val(),
                lastName: $('#phLastName').val(),
                birthdate: $('#phBirthdate').val(),
                address: {
                    street: $('#phStreet').val(),
                    number: $('#phNumber').val(),
                    zip: $('#phZip').val(),
                    city: $('#phCity').val(),
                    country: $('#phCountry').val()
                }
            },
            country: $('#phCountry').val(), // Typically same as policyholder country
            subject: {
                familyType: familyType,
                tripZone: $('#tripZone').val(),
                noMedicalCondition: $('#noMedicalCondition').is(':checked'),
                // Only include if there are beneficiaries
                ...(extraBeneficiaries.length > 0 && { extraBeneficiaries: extraBeneficiaries })
            },
            contractPeriod: {
                timeZone: "Europe/Brussels", // As per JSON config
                startDate: startDateValue,
                startsAt: startsAtValue
            }
        };

        console.log("Pricing API Payload:", JSON.stringify(payload, null, 2)); // For debugging

        // 3. Make AJAX Call
        $.ajax({
            url: `${API_ENDPOINT_PRICING}?apikey=${API_KEY}`, // Use pricing endpoint
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                console.log("Pricing API Response:", response); // For debugging
                $('#loadingIndicator').hide();
                $('#btnStep2Next').prop('disabled', false);

                if (response && response.packages) {
                    // Store the raw packages response for later use in createQuote
                    apiPrices.rawPackages = response.packages;
                    processApiResponse(response.packages); // Process prices for display
                    // Update summary text here as inputs are now confirmed
                    $('#tripInfoSummaryPrices').text(`Zone: ${$('#tripZone option:selected').text()}, Travellers: ${$('#familyType option:selected').text()}, Coverage Start: ${$('#startDate').val()}`);
                    selectedPackage = null; // Reset package selection
                    $('.btnSelectPackage').prop('disabled', false).text(function() { return $(this).data('package-name') ? `Select ${$(this).data('package-name')}` : 'Select'; }); // Reset button state
                    $('#btnStep3Next').prop('disabled', true); // Disable next until package selected
                    // Uncheck optionals before showing step 3
                   $('#winterSports, #carHireExcess, #excessWaiver').prop('checked', false);
                    navigateToStep(3);
                } else {
                    $('#apiError').text('Invalid response received from pricing API.').show();
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Pricing API Error:", textStatus, errorThrown, jqXHR.responseText);
                $('#loadingIndicator').hide();
                $('#btnStep2Next').prop('disabled', false);
                let errorMsg = 'Failed to fetch prices. Please try again.';
                if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                    errorMsg = jqXHR.responseJSON.message; // Use API error if available
                } else if (jqXHR.responseText) {
                   // Try to parse plain text error
                    try {
                        const errData = JSON.parse(jqXHR.responseText);
                        // Specific check for the schema validation error
                         if(errData.message && errData.message.includes("JSON schema validation failed")){
                             errorMsg = `API Error: ${errData.message} (Details: ${errData.errors?.[0]?.message || 'Unknown validation issue'})`;
                         } else if (errData.message) {
                             errorMsg = `API Error: ${errData.message}`;
                         } else if (jqXHR.status === 0) {
                             errorMsg = 'Network error or CORS issue. Check browser console and API endpoint.';
                         } else {
                             errorMsg = `API Error: Status ${jqXHR.status} - ${errorThrown}`;
                         }
                    } catch(e) {
                        if (jqXHR.status === 0) {
                             errorMsg = 'Network error or CORS issue. Check browser console and API endpoint.';
                        } else {
                            errorMsg = `API Error: Status ${jqXHR.status} - ${errorThrown}. Response is not valid JSON.`;
                        }
                    }
                } else if (textStatus === 'timeout') {
                    errorMsg = 'The request to fetch prices timed out. Please try again.';
                } else if (textStatus === 'error' && jqXHR.status === 0) {
                     errorMsg = 'Network error or CORS issue preventing price fetch. Check browser console.';
                }

                $('#apiError').text(errorMsg).show();
            }
        });
    }

    function processApiResponse(packagesData) {
         console.log("Processing API Response Data:", packagesData); // Log the raw data received

         // Reset stored prices
         apiPrices.packages = { 'MULTIPERILBASIC': 0, 'MULTIPERILPLUS': 0, 'MULTIPERILPREMIUM': 0 };
         apiPrices.optionals = { 'winterSports': 0, 'carHireExcess': 0, 'excessWaiver': 0 };
         apiPrices.rawOptionals = {}; // Reset raw optionals too

         const packageCodes = ['MULTIPERILBASIC', 'MULTIPERILPLUS', 'MULTIPERILPREMIUM'];

         packageCodes.forEach(code => {
             let totalCip = 0;
             const packageInfo = packagesData[code];
             console.log(`--- Processing Package: ${code} ---`); // Log which package is being processed

             if (packageInfo && packageInfo.coverages) {
                 // Sum CIP for all base coverages in the package
                 Object.entries(packageInfo.coverages).forEach(([coverageCode, coverage]) => { // Use entries to get code and object
                      // Determine the variant key ('basic', 'plus', or 'premium')
                       const variantKey = Object.keys(coverage.variants)[0];
                       if (!variantKey) {
                           console.warn(`No variant key found for coverage ${coverageCode} in package ${code}`);
                           return; // Skip this coverage if no variant key
                       }

                       const cipValue = coverage.variants[variantKey]?.premium?.cip;
                       console.log(` -> Coverage: ${coverageCode}, Variant: ${variantKey}, CIP: ${cipValue}`); // Log each coverage CIP found

                       if (typeof cipValue === 'number' && !isNaN(cipValue)) {
                           totalCip += cipValue;
                       } else {
                            console.warn(`Invalid or missing CIP for coverage ${coverageCode} in package ${code}. Value:`, cipValue);
                       }
                 });

                 console.log(`Calculated Total CIP for ${code}: ${totalCip}`); // Log the final sum for the package
                 apiPrices.packages[code] = totalCip;

                 // Store optional coverage prices for this package
                 if (packageInfo.optionalCoverages) {
                     apiPrices.rawOptionals[code] = {};
                     console.log(`Processing Optional Coverages for ${code}:`, packageInfo.optionalCoverages);
                      Object.entries(packageInfo.optionalCoverages).forEach(([optCode, optCoverage]) => {
                          // Optionals might have 'default', 'basic', 'plus', or 'premium' as the variant key
                          const variantKey = Object.keys(optCoverage.variants)[0];
                           if (!variantKey) {
                               console.warn(`No variant key found for optional coverage ${optCode} in package ${code}`);
                               return;
                           }
                           const optionalCipValue = optCoverage.variants[variantKey]?.premium?.cip;
                           console.log(` -> Optional: ${optCode}, Variant: ${variantKey}, CIP: ${optionalCipValue}`);
                           if(typeof optionalCipValue === 'number' && !isNaN(optionalCipValue)) {
                               // Store using the code from the API response (e.g., 'winterSports')
                               apiPrices.rawOptionals[code][optCode] = optionalCipValue;
                           } else {
                               console.warn(`Invalid or missing CIP for optional coverage ${optCode} in package ${code}. Value:`, optionalCipValue);
                           }
                      });
                      console.log(`Stored Optional Prices for ${code}:`, apiPrices.rawOptionals[code]);
                 } else {
                      console.log(`No Optional Coverages found for ${code}`);
                 }
             } else {
                  console.warn(`Package data missing or invalid for code: ${code}`);
             }

             // --- Corrected ID Selection ---
             let displayId;
              if (code === 'MULTIPERILBASIC') {
                   displayId = '#priceBasic';
              } else if (code === 'MULTIPERILPLUS') {
                   displayId = '#pricePlus';
              } else if (code === 'MULTIPERILPREMIUM') {
                   displayId = '#pricePremium';
              } else {
                   console.error(`Unexpected package code: ${code}`);
                   return;
              }
              // --- End Correction ---

             const priceElement = $(displayId); // Get the jQuery element using the correct ID

             if(priceElement.length) { // Check if the element exists
                  const priceToShow = apiPrices.packages[code];
                  if (typeof priceToShow === 'number' && !isNaN(priceToShow)) {
                       priceElement.text(priceToShow.toFixed(2));
                        console.log(`Updated HTML element ${displayId} with price: ${priceToShow.toFixed(2)}`);
                  } else {
                         priceElement.text('--');
                         console.warn(`Failed to update HTML element ${displayId} - price is invalid:`, priceToShow);
                  }
             } else {
                  console.error(`HTML element ${displayId} not found! Check HTML structure and ID.`); // Log error if element missing
             }
         });

        // Update display for optional prices based on the 'basic' package by default
        // Or better, update when a package is selected. Let's clear them initially.
        $('#priceWinterSports').text('--');
        $('#priceCarHireExcess').text('--');
        $('#priceExcessWaiver').text('--');


        // Handle Car Hire Excess availability based on zone
        if ($('#tripZone').val() === 'ZONE_EUROPE') {
            $('#carHireExcess').prop('disabled', false);
            $('#carHireMsg').hide();
        } else {
            $('#carHireExcess').prop('disabled', true).prop('checked', false);
            $('#carHireMsg').show();
        }

         console.log("--- Finished processing API response ---");
         console.log("Stored API Prices:", apiPrices); // Log the final stored prices object
    }

    function updateOptionalPriceDisplay(selectedPackageCode) {
        const optionalsForPackage = apiPrices.rawOptionals[selectedPackageCode] || {};
        console.log(`Updating optional prices display based on package ${selectedPackageCode}:`, optionalsForPackage);

        // Use the codes exactly as they appear in the API response / rawOptionals keys
        // Provide default 0 if optional doesn't exist for the package
        apiPrices.optionals.winterSports = optionalsForPackage['winterSports'] ?? 0;
        apiPrices.optionals.carHireExcess = optionalsForPackage['carHireExcess'] ?? 0;
        apiPrices.optionals.excessWaiver = optionalsForPackage['excessWaiver'] ?? 0;

        $('#priceWinterSports').text(apiPrices.optionals.winterSports.toFixed(2));
        $('#priceCarHireExcess').text(apiPrices.optionals.carHireExcess.toFixed(2));
        $('#priceExcessWaiver').text(apiPrices.optionals.excessWaiver.toFixed(2));

        // Also ensure carHireExcess display matches disable state
        if ($('#tripZone').val() !== 'ZONE_EUROPE') {
            $('#priceCarHireExcess').text('--'); // Or keep price but make clear it's unavailable
        }


        console.log(`Updated optional display prices: WinterSports=${apiPrices.optionals.winterSports.toFixed(2)}, CarHire=${apiPrices.optionals.carHireExcess.toFixed(2)}, Waiver=${apiPrices.optionals.excessWaiver.toFixed(2)}`);
    }


    function updateTotal() {
        if (!selectedPackage) {
            $('#btnStep3Next').prop('disabled', true);
            return;
        }

        let base = selectedPackage.basePrice;
        let optionalTotal = 0;
        selectedOptionals = {}; // Reset and rebuild

        // Use the stored optional prices for calculation
        if ($('#winterSports').is(':checked')) {
            optionalTotal += apiPrices.optionals.winterSports;
            selectedOptionals.winterSports = { name: 'Winter Sports', price: apiPrices.optionals.winterSports, code: 'winterSports' }; // Add code
        }
        if ($('#carHireExcess').is(':checked') && !$('#carHireExcess').is(':disabled')) {
            optionalTotal += apiPrices.optionals.carHireExcess;
            selectedOptionals.carHireExcess = { name: 'Car Hire Excess', price: apiPrices.optionals.carHireExcess, code: 'carHireExcess' }; // Add code
        }
        if ($('#excessWaiver').is(':checked')) {
            optionalTotal += apiPrices.optionals.excessWaiver;
            selectedOptionals.excessWaiver = { name: 'Excess Waiver', price: apiPrices.optionals.excessWaiver, code: 'excessWaiver' }; // Add code
        }

        let total = base + optionalTotal; // API prices (CIP) already include tax

        // Display total somewhere if needed in step 3, or just enable the button
        // $('#someTotalDisplayInStep3').text(total.toFixed(2));
        $('#btnStep3Next').prop('disabled', false);
    }

    function populateSummary() {
        const zoneText = $('#tripZone option:selected').text();
        const familyText = $('#familyType option:selected').text();
        const startDateText = $('#startDate').val();

        $('#summaryTripZone').text(zoneText);
        $('#summaryFamilyType').text(familyText);
        $('#summaryPolicyholder').text(`${quoteData.policyholder.firstName} ${quoteData.policyholder.lastName} (${quoteData.policyholder.email})`); // Use stored data
        $('#summaryDates').text(`${startDateText}`);
        $('#summaryPackage').text(selectedPackage.name);
        $('#summaryBasePrice').text(selectedPackage.basePrice.toFixed(2));

        // Populate Beneficiaries in Summary
        const $beneficiaryList = $('#summaryBeneficiariesList').empty();
        const beneficiaries = quoteData.beneficiaries || [];
        if (beneficiaries.length > 0) {
            const $p = $('<p><strong>Other Travellers Covered:</strong></p>').appendTo($beneficiaryList);
            const $ul = $('<ul></ul>').appendTo($p);
            beneficiaries.forEach(b => {
                $('<li>').text(`${b.firstName} ${b.lastName} (Born: ${b.birthdate})`).appendTo($ul);
            });
        }


        const $optionalList = $('#summaryOptionalCoverages ul');
        $optionalList.empty();
        let optionalTotal = 0;

        if (Object.keys(selectedOptionals).length > 0) {
            $('#summaryOptionalCoverages').show();
            $.each(selectedOptionals, function(key, item) {
                $('<li>').text(`${item.name} (+ € ${item.price.toFixed(2)})`).appendTo($optionalList);
                optionalTotal += item.price;
            });
        } else {
            $('#summaryOptionalCoverages').hide();
        }

        let total = selectedPackage.basePrice + optionalTotal;
        $('#totalPriceSummary').text(total.toFixed(2));
    }

      // --- Helper Functions for Prefill ---
      function getUrlParameter(name) {
         name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
         var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
         var results = regex.exec(location.search);
         return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
     };

    function getTomorrowDate() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
        const day = String(tomorrow.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function prefillTestData() {
        console.log("Prefilling test data...");
        $('#tripZone').val('ZONE_EUROPE');
        $('#familyType').val('FAMILY_TYPE_INDIVIDUAL');
        $('#startDate').val(getTomorrowDate());
        $('#noMedicalCondition').prop('checked', true);

        $('#phFirstName').val('John');
        $('#phLastName').val('Doe');
        $('#phBirthdate').val('1988-03-31'); // YYYY-MM-DD format
        $('#phEmail').val('harry+test@qover.com');
        $('#phPhone').val('+32486910819');
        $('#phStreet').val('Rue du Commerce');
        $('#phNumber').val('31');
        $('#phZip').val('1000');
        $('#phCity').val('Brussels');
        $('#phCountry').val('BE');

        // Trigger change for family type to ensure beneficiary fields are hidden
        $('#familyType').trigger('change');
        console.log("Test data prefilled.");
    }

    // --- Event Handlers ---

      // Dynamic Beneficiary Fields
      $('#familyType').change(function() {
          const type = $(this).val();
          if (type === 'FAMILY_TYPE_COUPLE') {
              $('#beneficiarySection').show();
              $('#beneficiary1').show().find('legend').text('Partner Details');
              $('#beneficiary2').hide();
               // Clear potential child fields if switching from family
              $('#b2FirstName, #b2LastName, #b2Birthdate').val('');
          } else if (type === 'FAMILY_TYPE_FAMILY') {
               $('#beneficiarySection').show();
               $('#beneficiary1').show().find('legend').text('Partner Details');
               $('#beneficiary2').show();
          } else {
               $('#beneficiarySection').hide();
               $('#beneficiary1').hide();
               $('#beneficiary2').hide();
                // Clear all beneficiary fields if switching to individual
               $('#b1FirstName, #b1LastName, #b1Birthdate, #b2FirstName, #b2LastName, #b2Birthdate').val('');
          }
          clearErrors(); // Clear errors when type changes
      });

    $('#btnStep1Next').click(function() {
        if (validateStep1()) {
            // Store trip data
              quoteData.trip = {
                  tripZone: $('#tripZone').val(),
                  familyType: $('#familyType').val(),
                  startDate: $('#startDate').val(),
                  noMedicalCondition: $('#noMedicalCondition').is(':checked')
              };
            // Trigger change to show/hide beneficiary fields correctly before showing step 2
            $('#familyType').trigger('change');
            navigateToStep(2);
        }
    });

      $('#btnStep2Back').click(function() {
          navigateToStep(1);
      });

       $('#btnStep2Next').click(function() {
        if (validateStep2()) {
            // Store policyholder & beneficiary data just before API call
            quoteData.policyholder = {
                firstName: $('#phFirstName').val(), lastName: $('#phLastName').val(),
                email: $('#phEmail').val(), phone: $('#phPhone').val(),
                birthdate: $('#phBirthdate').val(),
                 // Add entityType here if not added in API call
                entityType: "ENTITY_TYPE_PERSON",
                address: {
                    street: $('#phStreet').val(), number: $('#phNumber').val(),
                    zip: $('#phZip').val(), city: $('#phCity').val(), country: $('#phCountry').val()
                }
            };
            const beneficiaries = [];
            const familyType = $('#familyType').val();
             if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') {
                 beneficiaries.push({
                     firstName: $('#b1FirstName').val(), lastName: $('#b1LastName').val(), birthdate: $('#b1Birthdate').val()
                 });
             }
             if (familyType === 'FAMILY_TYPE_FAMILY') {
                 beneficiaries.push({
                      firstName: $('#b2FirstName').val(), lastName: $('#b2LastName').val(), birthdate: $('#b2Birthdate').val()
                 });
             }
            quoteData.beneficiaries = beneficiaries;

            callPricingAPI(); // Calls the pricing API first
        }
      });


    $('#btnStep3Back').click(function() {
        navigateToStep(2);
    });

    $('.btnSelectPackage').click(function() {
        const packageCode = $(this).data('package');
        const packageName = $(this).data('package-name');
        const price = apiPrices.packages[packageCode] ?? 0;

        $('.btnSelectPackage').prop('disabled', false).text(function() { return `Select ${$(this).data('package-name')}`; });
        $(this).prop('disabled', true).text('Selected');

        selectedPackage = { code: packageCode, name: packageName, basePrice: price };

        // Update optional prices display based on the selected package variant
        updateOptionalPriceDisplay(packageCode);

        // Re-evaluate total whenever package changes (as optional prices depend on it)
        updateTotal();
    });

    $('#winterSports, #carHireExcess, #excessWaiver').change(function() {
       updateTotal();
    });

    $('#btnStep3Next').click(function() {
          if (selectedPackage) {
              populateSummary();
              navigateToStep(4);
          }
    });

    $('#btnStep4Back').click(function() {
        navigateToStep(3);
    });

    // --- NEW: Function to build coverage object for createQuote ---
    function buildCoveragesForQuote(packageCode, selectedOptionalCodes) {
        const coverages = {};
        let variantName = 'basic'; // default
        if (packageCode === 'MULTIPERILPLUS') variantName = 'plus';
        if (packageCode === 'MULTIPERILPREMIUM') variantName = 'premium';

        // 1. Define Base Coverages per Package Level (Based on examples)
        const baseCoverageMap = {
             'MULTIPERILBASIC': ['cancellation', 'assistance', 'medicalExpenses', 'hospitalBenefit', 'personalAccident', 'baggages', 'moneyAndDocuments', 'personalLiability', 'missedDeparture', 'delayedDeparture'],
             'MULTIPERILPLUS': ['cancellation', 'assistance', 'medicalExpenses', 'hospitalBenefit', 'personalAccident', 'baggages', 'moneyAndDocuments', 'personalLiability', 'hijack', 'missedDeparture', 'catastrophe', 'delayedDeparture', 'holidayAbandonment', 'creditCardFraud', 'legalExpenses', 'strike'], // Assumed based on premium list
             'MULTIPERILPREMIUM': ['cancellation', 'assistance', 'medicalExpenses', 'hospitalBenefit', 'personalAccident', 'baggages', 'moneyAndDocuments', 'personalLiability', 'hijack', 'missedDeparture', 'catastrophe', 'delayedDeparture', 'holidayAbandonment', 'creditCardFraud', 'legalExpenses', 'strike']
        };

        // Add base coverages with the correct variant
        if (baseCoverageMap[packageCode]) {
             baseCoverageMap[packageCode].forEach(covCode => {
                 coverages[covCode] = variantName;
             });
        } else {
            console.error("Unknown package code for base coverage mapping:", packageCode);
        }

        // 2. Add Selected Optional Coverages
        selectedOptionalCodes.forEach(optCode => {
             if (optCode === 'excessWaiver') {
                 coverages[optCode] = 'default'; // As per MULTIPERILBASIC example
             } else if (optCode === 'winterSports') {
                 // Determine variant: 'basic', 'plus', 'premium' based on package? Or always 'default'?
                 // The PREMIUM example included 'winterSports: "premium"'. Let's assume it matches the package level.
                 coverages[optCode] = variantName;
             } else if (optCode === 'carHireExcess') {
                 // The PREMIUM example included 'carHireExcess: "premium"'. Let's assume it matches the package level.
                  // Only add if applicable (Europe zone)
                 if ($('#tripZone').val() === 'ZONE_EUROPE'){
                     coverages[optCode] = variantName;
                 }
             }
             // Add other optionals here if needed
        });

        console.log("Built Coverages for Quote:", coverages);
        return coverages;
    }


    // --- MODIFIED: Proceed to Payment Button Handler ---
    $('#btnProceedToPayment').click(function() {
        console.log("Proceed to Payment clicked.");
        clearErrors(); // Clear previous errors
        $('#paymentLoadingIndicator').show(); // Show specific loading message
        $('#btnProceedToPayment').prop('disabled', true); // Disable button
        $('#btnStep4Back').prop('disabled', true); // Disable back button too

        // 1. Gather all data needed for the createQuote payload
        if (!selectedPackage || !quoteData.trip || !quoteData.policyholder) {
            console.error("Missing required data for quote creation.");
            $('#paymentApiError').text("Error: Missing required quote data. Please go back and complete all steps.").show();
            $('#paymentLoadingIndicator').hide();
            $('#btnProceedToPayment').prop('disabled', false);
            $('#btnStep4Back').prop('disabled', false);
            return;
        }

        const selectedOptionalCodes = Object.values(selectedOptionals).map(opt => opt.code);
        const coverages = buildCoveragesForQuote(selectedPackage.code, selectedOptionalCodes);


        // 2. Construct the payload for the Google Apps Script endpoint
        const createQuotePayload = {
            productConfigurationId: "tui-demo-multi",
            partnerId: PARTNER_ID,
            package: {
                name: selectedPackage.code, // e.g., MULTIPERILBASIC
                coverages: coverages         // The object built above
            },
            policyholder: { // Ensure structure matches API requirements
                email: quoteData.policyholder.email,
                entityType: "ENTITY_TYPE_PERSON",
                phone: quoteData.policyholder.phone,
                firstName: quoteData.policyholder.firstName,
                lastName: quoteData.policyholder.lastName,
                birthdate: quoteData.policyholder.birthdate, // YYYY-MM-DD
                address: {
                    street: quoteData.policyholder.address.street,
                    number: quoteData.policyholder.address.number,
                    zip: quoteData.policyholder.address.zip,
                    city: quoteData.policyholder.address.city,
                    country: quoteData.policyholder.address.country // e.g., BE
                }
            },
            country: quoteData.policyholder.address.country, // Country for the policy context
            language: "en", // Or make dynamic if needed
            subject: {
                familyType: quoteData.trip.familyType,
                tripZone: quoteData.trip.tripZone,
                noMedicalCondition: quoteData.trip.noMedicalCondition,
                // Only include extraBeneficiaries if they exist
                ...(quoteData.beneficiaries && quoteData.beneficiaries.length > 0 && {
                    extraBeneficiaries: quoteData.beneficiaries.map(b => ({
                        firstName: b.firstName,
                        lastName: b.lastName,
                        birthdate: b.birthdate // YYYY-MM-DD
                    }))
                })
            },
            contractPeriod: {
                timeZone: "Europe/Brussels", // As per example
                startDate: quoteData.trip.startDate // YYYY-MM-DD
            }
            // Add payment details or other fields if required by the Google Script wrapper
        };

        const requestData = {
            action: "createQuote",
            env: "sbx", // Environment specifier
            payload: createQuotePayload
        };

        console.log("Create Quote API Request Data:", JSON.stringify(requestData, null, 2));

        // 3. Make the AJAX call to the Google Apps Script endpoint
        $.ajax({
            url: CREATE_QUOTE_ENDPOINT,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                console.log("Create Quote API Response:", response);
                $('#paymentLoadingIndicator').hide();

                if (response && response.status === 'success' && response.payUrl) {
                    console.log("Quote created successfully. Redirecting to payment URL:", response.payUrl);
                    // Redirect to the payment page
                    window.location.href = response.payUrl;
                    // No need to re-enable buttons here as we are redirecting
                } else {
                    console.error("Failed to create quote or missing payment URL in response.");
                    let errorMsg = "Failed to finalize quote or retrieve payment link.";
                    if (response && response.message) { // Check if the script provided an error message
                         errorMsg += ` (Details: ${response.message})`;
                    } else if (response && response.error) {
                        errorMsg += ` (Error: ${JSON.stringify(response.error)})`;
                    } else if (!response?.payUrl) {
                         errorMsg += " Payment URL was missing.";
                    }
                    $('#paymentApiError').text(errorMsg).show();
                    // Re-enable buttons on failure
                    $('#btnProceedToPayment').prop('disabled', false);
                    $('#btnStep4Back').prop('disabled', false);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Create Quote API Error:", textStatus, errorThrown, jqXHR.responseText);
                $('#paymentLoadingIndicator').hide();
                let errorMsg = 'Error communicating with the quote finalization service.';
                 if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                     errorMsg = `API Error: ${jqXHR.responseJSON.message}`;
                 } else if (jqXHR.responseText) {
                     try {
                         const errData = JSON.parse(jqXHR.responseText);
                         if (errData.message) {
                             errorMsg = `API Error: ${errData.message}`;
                         } else if (errData.error) {
                             errorMsg = `API Error: ${JSON.stringify(errData.error)}`;
                         }
                     } catch(e) {
                         // Response text is not JSON
                         errorMsg = `API Error: Status ${jqXHR.status} - ${errorThrown}. Check console for raw response.`;
                         console.log("Raw Error Response:", jqXHR.responseText);
                     }
                 } else if (textStatus === 'timeout') {
                     errorMsg = 'The request to finalize the quote timed out. Please try again.';
                 } else if (textStatus === 'error' && jqXHR.status === 0) {
                     errorMsg = 'Network error or CORS issue contacting the quote service. Check browser console.';
                 }
                $('#paymentApiError').text(errorMsg).show();
                // Re-enable buttons on failure
                $('#btnProceedToPayment').prop('disabled', false);
                $('#btnStep4Back').prop('disabled', false);
            }
        });
    });


    // --- Initial Setup ---
    // Set min/max date for date pickers
    const today = new Date().toISOString().split('T')[0];
    $('#phBirthdate, #b1Birthdate, #b2Birthdate').attr('max', today); // Cannot be born in future
    $('#startDate').attr('min', today); // Coverage cannot start in past

    // Check for test parameter on page load
    if (getUrlParameter('test') === 'true') {
        prefillTestData();
    }

    navigateToStep(1); // Ensure only step 1 is visible initially

}); // End document ready
</script>

</body>
</html>