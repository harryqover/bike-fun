<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Insurance Quote</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .step { display: none; border: 1px solid #ccc; padding: 20px; margin-top: 15px; border-radius: 5px; }
        .step.active { display: block; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .input-group { display: flex; gap: 10px; }
        .input-group > div { flex: 1; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; margin-right: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        .error { color: red; font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; min-height: 1em; }
        .package-options { display: flex; justify-content: space-around; margin-top: 20px; flex-wrap: wrap; }
        .package { border: 1px solid #eee; padding: 15px; margin: 10px; border-radius: 5px; text-align: center; width: 28%; min-width: 200px; }
        .package h3 { margin-top: 0; }
        .package .price { font-size: 1.4em; font-weight: bold; margin: 10px 0; }
        .package button { width: 100%; }
        .optional-coverages { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; }
        .optional-coverages label { display: inline-block; margin-right: 15px; font-weight: normal; }
        .summary { background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .summary h3 { margin-top: 0; }
        #totalPriceSummary { font-size: 1.2em; font-weight: bold; }
        #medicalConditionCheck label { display: inline; font-weight: normal; }
        #medicalConditionCheck input { width: auto; margin-right: 5px;}
        .beneficiary-fields { border: 1px dashed #eee; padding: 15px; margin-top: 15px; border-radius: 4px; }
        .beneficiary-fields legend { font-weight: bold; padding: 0 5px; }
        #loadingIndicator { display: none; margin-top: 10px; color: #555; }
        #apiError { display: none; color: red; margin-top: 10px; font-weight: bold;}
    </style>
</head>
<body>

<h1>Get Your Annual Travel Insurance Quote</h1>

<div id="step1" class="step active">
    <h2>Step 1: Tell us about your plan</h2>
    <form id="tripForm">
        <div>
            <label for="tripZone">Primary Travel Zone:</label>
            <select id="tripZone" name="tripZone" required>
                <option value="">-- Select Zone --</option>
                <option value="ZONE_EUROPE">Europe</option>
                <option value="ZONE_WORLD_EXCLUDING_USA">Worldwide (excluding USA/Canada)</option>
                <option value="ZONE_WORLD_INCLUDING_USA">Worldwide (including USA/Canada)</option>
            </select>
             <small>Select the main region you plan to travel to during the year.</small>
            <div class="error" id="tripZoneError"></div>
        </div>
        <div>
            <label for="familyType">Who needs cover?</label>
            <select id="familyType" name="familyType" required>
                <option value="">-- Select Option --</option>
                <option value="FAMILY_TYPE_INDIVIDUAL">Individual (Just Me)</option>
                <option value="FAMILY_TYPE_COUPLE">Couple (Me + 1 Adult)</option>
                <option value="FAMILY_TYPE_FAMILY">Family (Me + 1 Adult + Child/Children)</option>
            </select>
            <div class="error" id="familyTypeError"></div>
        </div>
        <div>
            <label for="startDate">Coverage Start Date:</label>
            <input type="date" id="startDate" name="startDate" required>
             <small>Your policy will be valid for 1 year from this date.</small>
            <div class="error" id="startDateError"></div>
        </div>
        <div id="medicalConditionCheck">
            <label>Medical Condition Declaration:</label>
            <input type="checkbox" id="noMedicalCondition" name="noMedicalCondition" value="true" required>
            <span>I confirm that no traveller has pre-existing medical conditions.</span>
            <div class="error" id="noMedicalConditionError"></div>
        </div>
        <button type="button" id="btnStep1Next">Next: Policyholder Details</button>
    </form>
</div>

<div id="step2" class="step">
    <h2>Step 2: Policyholder Details</h2>
    <form id="policyholderForm">
         <div class="input-group">
            <div>
                <label for="phFirstName">First Name:</label>
                <input type="text" id="phFirstName" name="phFirstName" required>
                <div class="error" id="phFirstNameError"></div>
            </div>
            <div>
                <label for="phLastName">Last Name:</label>
                <input type="text" id="phLastName" name="phLastName" required>
                <div class="error" id="phLastNameError"></div>
            </div>
        </div>
         <div class="input-group">
             <div>
                <label for="phBirthdate">Birthdate:</label>
                <input type="date" id="phBirthdate" name="phBirthdate" required>
                <div class="error" id="phBirthdateError"></div>
            </div>
             <div>
                <label for="phEmail">Email:</label>
                <input type="email" id="phEmail" name="phEmail" required>
                <div class="error" id="phEmailError"></div>
            </div>
        </div>
         <div>
            <label for="phPhone">Phone:</label>
            <input type="tel" id="phPhone" name="phPhone" placeholder="+32..." required>
            <div class="error" id="phPhoneError"></div>
        </div>
        <fieldset>
            <legend>Address</legend>
            <div class="input-group">
                 <div>
                     <label for="phStreet">Street:</label>
                     <input type="text" id="phStreet" name="phStreet" required>
                     <div class="error" id="phStreetError"></div>
                 </div>
                 <div>
                    <label for="phNumber">Number:</label>
                    <input type="text" id="phNumber" name="phNumber" required>
                    <div class="error" id="phNumberError"></div>
                </div>
            </div>
            <div class="input-group">
                 <div>
                     <label for="phZip">Zip Code:</label>
                     <input type="text" id="phZip" name="phZip" required>
                     <div class="error" id="phZipError"></div>
                 </div>
                 <div>
                    <label for="phCity">City:</label>
                    <input type="text" id="phCity" name="phCity" required>
                     <div class="error" id="phCityError"></div>
                </div>
                 <div>
                    <label for="phCountry">Country:</label>
                    <select id="phCountry" name="phCountry" required>
                         <option value="BE">Belgium</option>
                         </select>
                     <div class="error" id="phCountryError"></div>
                </div>
            </div>
        </fieldset>

        <div id="beneficiarySection" style="display: none;">
            <h3>Other Travellers</h3>
            <div id="beneficiary1" class="beneficiary-fields">
                 <legend>Partner Details</legend>
                 <div class="input-group">
                    <div>
                        <label for="b1FirstName">First Name:</label>
                        <input type="text" id="b1FirstName" name="b1FirstName">
                        <div class="error" id="b1FirstNameError"></div>
                    </div>
                    <div>
                        <label for="b1LastName">Last Name:</label>
                        <input type="text" id="b1LastName" name="b1LastName">
                        <div class="error" id="b1LastNameError"></div>
                    </div>
                     <div>
                        <label for="b1Birthdate">Birthdate:</label>
                        <input type="date" id="b1Birthdate" name="b1Birthdate">
                        <div class="error" id="b1BirthdateError"></div>
                    </div>
                </div>
            </div>
             <div id="beneficiary2" class="beneficiary-fields" style="display: none;">
                 <legend>Child Details</legend>
                 <div class="input-group">
                    <div>
                        <label for="b2FirstName">First Name:</label>
                        <input type="text" id="b2FirstName" name="b2FirstName">
                        <div class="error" id="b2FirstNameError"></div>
                    </div>
                    <div>
                        <label for="b2LastName">Last Name:</label>
                        <input type="text" id="b2LastName" name="b2LastName">
                        <div class="error" id="b2LastNameError"></div>
                    </div>
                     <div>
                        <label for="b2Birthdate">Birthdate:</label>
                        <input type="date" id="b2Birthdate" name="b2Birthdate">
                        <div class="error" id="b2BirthdateError"></div>
                    </div>
                </div>
                 </div>
        </div>
         <button type="button" id="btnStep2Back">Back</button>
        <button type="button" id="btnStep2Next">Get Prices</button>
        <div id="loadingIndicator">Fetching prices... <img src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" alt="loading" width="16"></div>
        <div id="apiError"></div>
    </form>
</div>


<div id="step3" class="step">
    <h2>Step 3: Choose your plan</h2>
    <p>Based on your selection: <span id="tripInfoSummaryPrices"></span></p>
    <div class="package-options">
        <div class="package" id="packageBasic">
            <h3>Basic</h3>
            <div class="price">€ <span id="priceBasic">--</span></div>
            <button type="button" class="btnSelectPackage" data-package="MULTIPERILBASIC" data-package-name="Basic">Select Basic</button>
        </div>
        <div class="package" id="packagePlus">
            <h3>Plus</h3>
            <div class="price">€ <span id="pricePlus">--</span></div>
             <button type="button" class="btnSelectPackage" data-package="MULTIPERILPLUS" data-package-name="Plus">Select Plus</button>
        </div>
        <div class="package" id="packagePremium">
            <h3>Premium</h3>
             <div class="price">€ <span id="pricePremium">--</span></div>
             <button type="button" class="btnSelectPackage" data-package="MULTIPERILPREMIUM" data-package-name="Premium">Select Premium</button>
        </div>
    </div>

    <div class="optional-coverages">
        <h3>Optional Coverages</h3>
        <div id="optionWinterSports">
            <input type="checkbox" id="winterSports" name="winterSports">
            <label for="winterSports">Winter Sports (+ € <span id="priceWinterSports">--</span>)</label>
        </div>
         <div id="optionCarHireExcess">
            <input type="checkbox" id="carHireExcess" name="carHireExcess" disabled>
            <label for="carHireExcess">Car Hire Excess (+ € <span id="priceCarHireExcess">--</span>)</label>
            <small id="carHireMsg">(Only available for Europe Zone)</small>
        </div>
        <div id="optionExcessWaiver">
             <input type="checkbox" id="excessWaiver" name="excessWaiver">
             <label for="excessWaiver">Excess Waiver (+ € <span id="priceExcessWaiver">--</span>)</label>
        </div>
    </div>

    <button type="button" id="btnStep3Back">Back</button>
    <button type="button" id="btnStep3Next" disabled>Next: Summary</button>
</div>

<div id="step4" class="step">
    <h2>Step 4: Summary</h2>
    <div class="summary">
        <h3>Your Selection</h3>
        <p><strong>Primary Travel Zone:</strong> <span id="summaryTripZone"></span></p>
        <p><strong>Travellers Covered:</strong> <span id="summaryFamilyType"></span></p>
         <p><strong>Policyholder:</strong> <span id="summaryPolicyholder"></span></p>
         <div id="summaryBeneficiariesList"></div>
        <p><strong>Coverage Start Date:</strong> <span id="summaryDates"></span> (Valid for 1 year)</p> <hr>
        <p><strong>Selected Plan:</strong> <span id="summaryPackage"></span></p>
        <p><strong>Base Price (Annual):</strong> € <span id="summaryBasePrice"></span></p>
        <div id="summaryOptionalCoverages">
            <p><strong>Optional Coverages (Annual):</strong></p>
            <ul>
                </ul>
        </div>
        <hr>
        <p><strong>Total Price (Annual, inc. Taxes):</strong> € <span id="totalPriceSummary">--</span></p>
    </div>
    <button type="button" id="btnStep4Back">Back</button>
    <button type="button" id="btnProceedToPayment">Proceed to Payment</button>
</div>

<script>
$(document).ready(function() {

    // --- Configuration ---
    const API_ENDPOINT = 'https://api.sbx.qover.io/policies/v1/product-configurations/tui-demo-multi/versions/effective/packages';
    // IMPORTANT: Storing API keys client-side is insecure. Use a backend proxy in production.
    const API_KEY = 'sk_B4B9BB9B72E44E264D40';
    const PARTNER_ID = "6810e8b75bc1edd801534d9d"; // From your example

    let currentStep = 1;
    let quoteData = {}; // Will hold trip, policyholder, beneficiaries
    let apiPrices = { // Store prices fetched from API
        packages: {
            'MULTIPERILBASIC': 0,
            'MULTIPERILPLUS': 0,
            'MULTIPERILPREMIUM': 0
        },
        optionals: {
            'winterSports': 0,
            'carHireExcess': 0,
            'excessWaiver': 0
        },
         // Store raw optional data keyed by package name for lookup
         rawOptionals: {}
    };
    let selectedPackage = null; // { code: '', name: '', basePrice: 0 }
    let selectedOptionals = {}; // { winterSports: { name: '', price: 0 }, ... }

    function navigateToStep(step) {
        $('.step').removeClass('active');
        $('#step' + step).addClass('active');
        currentStep = step;
    }

    function clearErrors() {
         $('.error').text('');
         $('#apiError').hide().text('');
    }

     // --- Validation Functions ---
     function validateStep1() {
         let isValid = true;
         clearErrors();
         const tripZone = $('#tripZone').val();
         const familyType = $('#familyType').val();
         const startDate = $('#startDate').val();
         // REMOVED endDate validation
         const noMedical = $('#noMedicalCondition').is(':checked');
         const today = new Date().toISOString().split('T')[0];

         if (!tripZone) { $('#tripZoneError').text('Please select a trip zone.'); isValid = false; }
         if (!familyType) { $('#familyTypeError').text('Please select who needs cover.'); isValid = false; }
         if (!startDate) { $('#startDateError').text('Please select a start date.'); isValid = false; }
         else if (startDate < today) { $('#startDateError').text('Start date cannot be in the past.'); isValid = false; }
         // REMOVED end date check vs start date
         if (!noMedical) { $('#noMedicalConditionError').text('You must confirm no pre-existing medical conditions to proceed.'); isValid = false; }

         return isValid;
     }

    function getAge(birthDateString) {
        if (!birthDateString) return 0;
        try {
            const today = new Date();
            const birthDate = new Date(birthDateString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        } catch (e) {
            return 0; // Handle invalid date format
        }
    }


     function validateStep2() {
         let isValid = true;
         clearErrors();
         const familyType = $('#familyType').val(); // Needed for beneficiary validation

         // Policyholder fields
         if (!$('#phFirstName').val()) { $('#phFirstNameError').text('First name required.'); isValid = false; }
         if (!$('#phLastName').val()) { $('#phLastNameError').text('Last name required.'); isValid = false; }
         if (!$('#phEmail').val()) { $('#phEmailError').text('Email required.'); isValid = false; }
          else if (!/^\S+@\S+\.\S+$/.test($('#phEmail').val())) { $('#phEmailError').text('Invalid email format.'); isValid = false;} // Basic email format check
         if (!$('#phPhone').val()) { $('#phPhoneError').text('Phone number required.'); isValid = false; }
         if (!$('#phBirthdate').val()) {
              $('#phBirthdateError').text('Birthdate required.'); isValid = false;
         } else {
             const age = getAge($('#phBirthdate').val());
             if (age < 18) { $('#phBirthdateError').text('Policyholder must be at least 18 years old.'); isValid = false; }
             if (age >= 76) { $('#phBirthdateError').text('Policyholder must be under 76 years old.'); isValid = false; }
         }
         if (!$('#phStreet').val()) { $('#phStreetError').text('Street required.'); isValid = false; }
         if (!$('#phNumber').val()) { $('#phNumberError').text('Number required.'); isValid = false; }
         if (!$('#phZip').val()) { $('#phZipError').text('Zip code required.'); isValid = false; }
         if (!$('#phCity').val()) { $('#phCityError').text('City required.'); isValid = false; }
         if (!$('#phCountry').val()) { $('#phCountryError').text('Country required.'); isValid = false; }

         // Beneficiary fields (only if applicable)
         if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') {
              if (!$('#b1FirstName').val()) { $('#b1FirstNameError').text('First name required.'); isValid = false; }
              if (!$('#b1LastName').val()) { $('#b1LastNameError').text('Last name required.'); isValid = false; }
              if (!$('#b1Birthdate').val()) { $('#b1BirthdateError').text('Birthdate required.'); isValid = false; }
         }
         if (familyType === 'FAMILY_TYPE_FAMILY') {
             // Assuming only one child for now, matching API example
             if (!$('#b2FirstName').val()) { $('#b2FirstNameError').text('First name required.'); isValid = false; }
             if (!$('#b2LastName').val()) { $('#b2LastNameError').text('Last name required.'); isValid = false; }
             if (!$('#b2Birthdate').val()) { $('#b2BirthdateError').text('Birthdate required.'); isValid = false; }
         }

         return isValid;
     }

     // --- API Call and Price Handling ---
    function callPricingAPI() {
        clearErrors();
        $('#loadingIndicator').show();
        $('#btnStep2Next').prop('disabled', true);

        // 1. Construct Beneficiaries Array
        const extraBeneficiaries = [];
        const familyType = $('#familyType').val();
        if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') {
             extraBeneficiaries.push({
                 firstName: $('#b1FirstName').val(),
                 lastName: $('#b1LastName').val(),
                 birthdate: $('#b1Birthdate').val()
             });
        }
         if (familyType === 'FAMILY_TYPE_FAMILY') {
             extraBeneficiaries.push({
                 firstName: $('#b2FirstName').val(),
                 lastName: $('#b2LastName').val(),
                 birthdate: $('#b2Birthdate').val()
             });
         }

        // 2. Construct Payload
        const startDateValue = $('#startDate').val(); // YYYY-MM-DD
        const startsAtValue = `${startDateValue}T00:00:00.000Z`; // Combine date with time for ISO string

        const payload = {
            partnerId: PARTNER_ID,
            policyholder: {
                email: $('#phEmail').val(),
                entityType: "ENTITY_TYPE_PERSON",
                phone: $('#phPhone').val(),
                firstName: $('#phFirstName').val(),
                lastName: $('#phLastName').val(),
                birthdate: $('#phBirthdate').val(),
                address: {
                    street: $('#phStreet').val(),
                    number: $('#phNumber').val(),
                    zip: $('#phZip').val(),
                    city: $('#phCity').val(),
                    country: $('#phCountry').val()
                }
            },
            country: $('#phCountry').val(), // Typically same as policyholder country
            subject: {
                familyType: familyType,
                tripZone: $('#tripZone').val(),
                noMedicalCondition: $('#noMedicalCondition').is(':checked'),
                 // Only include if there are beneficiaries
                 ...(extraBeneficiaries.length > 0 && { extraBeneficiaries: extraBeneficiaries })
            },
            contractPeriod: {
                 timeZone: "Europe/Brussels", // As per JSON config
                 startDate: startDateValue,
                 startsAt: startsAtValue
            }
             // Removed endDate from payload - API expects only start for annual policies
        };

        console.log("API Payload:", JSON.stringify(payload, null, 2)); // For debugging

         // 3. Make AJAX Call
         $.ajax({
            url: `${API_ENDPOINT}?apikey=${API_KEY}`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                console.log("API Response:", response); // For debugging
                 $('#loadingIndicator').hide();
                 $('#btnStep2Next').prop('disabled', false);

                 if (response && response.packages) {
                     processApiResponse(response.packages);
                     // Update summary text here as inputs are now confirmed
                     $('#tripInfoSummaryPrices').text(`Zone: ${$('#tripZone option:selected').text()}, Travellers: ${$('#familyType option:selected').text()}, Coverage Start: ${$('#startDate').val()}`); // Updated text
                     selectedPackage = null; // Reset package selection
                     $('.btnSelectPackage').prop('disabled', false).text(function() { return $(this).data('package-name') ? `Select ${$(this).data('package-name')}` : 'Select'; }); // Reset button state
                     $('#btnStep3Next').prop('disabled', true); // Disable next until package selected
                     // Uncheck optionals before showing step 3
                    $('#winterSports, #carHireExcess, #excessWaiver').prop('checked', false);
                     navigateToStep(3);
                 } else {
                     $('#apiError').text('Invalid response received from pricing API.').show();
                 }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("API Error:", textStatus, errorThrown, jqXHR.responseText);
                 $('#loadingIndicator').hide();
                 $('#btnStep2Next').prop('disabled', false);
                 let errorMsg = 'Failed to fetch prices. Please try again.';
                 if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                     errorMsg = jqXHR.responseJSON.message; // Use API error if available
                 } else if (jqXHR.responseText) {
                    // Try to parse plain text error
                    try {
                        const errData = JSON.parse(jqXHR.responseText);
                         // Specific check for the schema validation error
                         if(errData.message && errData.message.includes("JSON schema validation failed")){
                            errorMsg = `API Error: ${errData.message} (Details: ${errData.errors?.[0]?.message || 'Unknown validation issue'})`;
                         } else if (errData.message) {
                            errorMsg = `API Error: ${errData.message}`;
                         }
                    } catch(e) { /* ignore parsing error if it's not JSON */ }
                 }
                 $('#apiError').text(errorMsg).show();
            }
        });
    }

    function processApiResponse(packagesData) {
         // Reset stored prices
         apiPrices = { packages: {}, optionals: {}, rawOptionals: {} };

         const packageCodes = ['MULTIPERILBASIC', 'MULTIPERILPLUS', 'MULTIPERILPREMIUM'];

         packageCodes.forEach(code => {
            let totalCip = 0;
            const packageInfo = packagesData[code];
            if (packageInfo && packageInfo.coverages) {
                // Sum CIP for all base coverages in the package
                Object.values(packageInfo.coverages).forEach(coverage => {
                     const variantKey = Object.keys(coverage.variants)[0]; // basic, plus, or premium
                     if (coverage.variants[variantKey]?.premium?.cip) {
                         totalCip += coverage.variants[variantKey].premium.cip;
                     }
                });
                apiPrices.packages[code] = totalCip;

                 // Store optional coverage prices for this package
                if (packageInfo.optionalCoverages) {
                    apiPrices.rawOptionals[code] = {};
                     Object.entries(packageInfo.optionalCoverages).forEach(([optCode, optCoverage]) => {
                         const variantKey = Object.keys(optCoverage.variants)[0]; // basic, plus, premium, or default
                         if(optCoverage.variants[variantKey]?.premium?.cip) {
                              apiPrices.rawOptionals[code][optCode] = optCoverage.variants[variantKey].premium.cip;
                         }
                     });
                }
            }

            // Update display for base package prices
            const displayId = `#price${code.replace('MULTIPERIL', '')}`; // #priceBasic, #pricePlus, #pricePremium
            $(displayId).text(apiPrices.packages[code]?.toFixed(2) ?? '--');
         });

        // Update display for optional prices (will be updated again when package is selected)
        // Display the price for the 'basic' package variant initially
        updateOptionalPriceDisplay('MULTIPERILBASIC');

         // Handle Car Hire Excess availability based on zone
        if ($('#tripZone').val() === 'ZONE_EUROPE') {
            $('#carHireExcess').prop('disabled', false);
            $('#carHireMsg').hide();
        } else {
            $('#carHireExcess').prop('disabled', true).prop('checked', false);
            $('#carHireMsg').show();
        }
    }

     function updateOptionalPriceDisplay(selectedPackageCode) {
         const optionalsForPackage = apiPrices.rawOptionals[selectedPackageCode] || {};

         apiPrices.optionals.winterSports = optionalsForPackage['winterSports'] ?? 0;
         apiPrices.optionals.carHireExcess = optionalsForPackage['carHireExcess'] ?? 0;
         apiPrices.optionals.excessWaiver = optionalsForPackage['excessWaiver'] ?? 0; // Assumes code is 'excessWaiver'

         $('#priceWinterSports').text(apiPrices.optionals.winterSports.toFixed(2));
         $('#priceCarHireExcess').text(apiPrices.optionals.carHireExcess.toFixed(2));
         $('#priceExcessWaiver').text(apiPrices.optionals.excessWaiver.toFixed(2));
     }


    function updateTotal() {
        if (!selectedPackage) {
            $('#btnStep3Next').prop('disabled', true);
            return;
        }

        let base = selectedPackage.basePrice;
        let optionalTotal = 0;
        selectedOptionals = {}; // Reset and rebuild

        if ($('#winterSports').is(':checked')) {
            optionalTotal += apiPrices.optionals.winterSports;
            selectedOptionals.winterSports = { name: 'Winter Sports', price: apiPrices.optionals.winterSports };
        }
        if ($('#carHireExcess').is(':checked') && !$('#carHireExcess').is(':disabled')) {
            optionalTotal += apiPrices.optionals.carHireExcess;
            selectedOptionals.carHireExcess = { name: 'Car Hire Excess', price: apiPrices.optionals.carHireExcess };
        }
         if ($('#excessWaiver').is(':checked')) {
            optionalTotal += apiPrices.optionals.excessWaiver;
            selectedOptionals.excessWaiver = { name: 'Excess Waiver', price: apiPrices.optionals.excessWaiver };
        }

        let total = base + optionalTotal; // API prices (CIP) already include tax

        $('#totalPriceSummary').text(total.toFixed(2));
        $('#btnStep3Next').prop('disabled', false);
    }

    function populateSummary() {
        const zoneText = $('#tripZone option:selected').text();
        const familyText = $('#familyType option:selected').text();
        const startDateText = $('#startDate').val();
        // REMOVED endDateText

        $('#summaryTripZone').text(zoneText);
        $('#summaryFamilyType').text(familyText);
        $('#summaryPolicyholder').text(`${$('#phFirstName').val()} ${$('#phLastName').val()} (${$('#phEmail').val()})`);
        $('#summaryDates').text(`${startDateText}`); // Updated to show only start date
        $('#summaryPackage').text(selectedPackage.name);
        $('#summaryBasePrice').text(selectedPackage.basePrice.toFixed(2));

        // Populate Beneficiaries in Summary
        const $beneficiaryList = $('#summaryBeneficiariesList').empty();
        const beneficiaries = quoteData.beneficiaries || [];
        if (beneficiaries.length > 0) {
            const $ul = $('<ul></ul>').appendTo($('<p><strong>Other Travellers Covered:</strong></p>').appendTo($beneficiaryList));
            beneficiaries.forEach(b => {
                 $('<li>').text(`${b.firstName} ${b.lastName} (${b.birthdate})`).appendTo($ul);
            });
        }


        const $optionalList = $('#summaryOptionalCoverages ul');
        $optionalList.empty();
        let optionalTotal = 0;

        if (Object.keys(selectedOptionals).length > 0) {
             $('#summaryOptionalCoverages').show();
             $.each(selectedOptionals, function(key, item) {
                 $('<li>').text(`${item.name} (+ € ${item.price.toFixed(2)})`).appendTo($optionalList);
                 optionalTotal += item.price;
             });
        } else {
             $('#summaryOptionalCoverages').hide();
        }

        let total = selectedPackage.basePrice + optionalTotal;
        $('#totalPriceSummary').text(total.toFixed(2));
    }

     // --- Event Handlers ---

     // Dynamic Beneficiary Fields
     $('#familyType').change(function() {
         const type = $(this).val();
         if (type === 'FAMILY_TYPE_COUPLE') {
             $('#beneficiarySection').show();
             $('#beneficiary1').show().find('legend').text('Partner Details');
             $('#beneficiary2').hide();
              // Clear potential child fields if switching from family
             $('#b2FirstName, #b2LastName, #b2Birthdate').val('');
         } else if (type === 'FAMILY_TYPE_FAMILY') {
              $('#beneficiarySection').show();
              $('#beneficiary1').show().find('legend').text('Partner Details');
              $('#beneficiary2').show();
         } else {
              $('#beneficiarySection').hide();
              $('#beneficiary1').hide();
              $('#beneficiary2').hide();
               // Clear all beneficiary fields if switching to individual
              $('#b1FirstName, #b1LastName, #b1Birthdate, #b2FirstName, #b2LastName, #b2Birthdate').val('');
         }
         clearErrors(); // Clear errors when type changes
     });

    $('#btnStep1Next').click(function() {
        if (validateStep1()) {
            // Store trip data
             quoteData.trip = {
                 tripZone: $('#tripZone').val(),
                 familyType: $('#familyType').val(),
                 startDate: $('#startDate').val(),
                 // REMOVED endDate
                 noMedicalCondition: $('#noMedicalCondition').is(':checked')
             };
             // Trigger change to show/hide beneficiary fields correctly before showing step 2
             $('#familyType').trigger('change');
            navigateToStep(2);
        }
    });

     $('#btnStep2Back').click(function() {
         navigateToStep(1);
     });

      $('#btnStep2Next').click(function() {
         if (validateStep2()) {
             // Store policyholder & beneficiary data just before API call
             quoteData.policyholder = {
                 firstName: $('#phFirstName').val(), lastName: $('#phLastName').val(),
                 email: $('#phEmail').val(), phone: $('#phPhone').val(),
                 birthdate: $('#phBirthdate').val(),
                 address: {
                     street: $('#phStreet').val(), number: $('#phNumber').val(),
                     zip: $('#phZip').val(), city: $('#phCity').val(), country: $('#phCountry').val()
                 }
             };
             const beneficiaries = [];
             const familyType = $('#familyType').val();
              if (familyType === 'FAMILY_TYPE_COUPLE' || familyType === 'FAMILY_TYPE_FAMILY') {
                  beneficiaries.push({
                      firstName: $('#b1FirstName').val(), lastName: $('#b1LastName').val(), birthdate: $('#b1Birthdate').val()
                  });
              }
              if (familyType === 'FAMILY_TYPE_FAMILY') {
                  beneficiaries.push({
                       firstName: $('#b2FirstName').val(), lastName: $('#b2LastName').val(), birthdate: $('#b2Birthdate').val()
                  });
              }
             quoteData.beneficiaries = beneficiaries;

             callPricingAPI();
         }
     });


    $('#btnStep3Back').click(function() {
        navigateToStep(2);
    });

    $('.btnSelectPackage').click(function() {
        const packageCode = $(this).data('package');
        const packageName = $(this).data('package-name');
        const price = apiPrices.packages[packageCode] ?? 0;

        $('.btnSelectPackage').prop('disabled', false).text(function() { return `Select ${$(this).data('package-name')}`; });
        $(this).prop('disabled', true).text('Selected');

        selectedPackage = { code: packageCode, name: packageName, basePrice: price };

        // Update optional prices display based on the selected package variant
        updateOptionalPriceDisplay(packageCode);

        // Update total
        updateTotal();
    });

    $('#winterSports, #carHireExcess, #excessWaiver').change(function() {
       updateTotal();
    });

    $('#btnStep3Next').click(function() {
         if (selectedPackage) {
             populateSummary();
             navigateToStep(4);
         }
    });

    $('#btnStep4Back').click(function() {
        navigateToStep(3);
    });

    $('#btnProceedToPayment').click(function() {
        const finalQuote = {
            ...quoteData.trip, // Spread trip details
            policyholder: quoteData.policyholder,
            beneficiaries: quoteData.beneficiaries,
            selectedPackage: selectedPackage,
            selectedOptionals: selectedOptionals,
            totalPrice: parseFloat($('#totalPriceSummary').text())
        };

        console.log("Final Quote Data for Submission:", finalQuote);
        alert(`Proceeding to payment (placeholder).\nTotal Price: € ${finalQuote.totalPrice.toFixed(2)}\nCheck console for details.`);
        // Example redirect: window.location.href = '/your-payment-page-url';
    });

    // Initial setup - Set min/max date for date pickers
    const today = new Date().toISOString().split('T')[0];
    $('#phBirthdate, #b1Birthdate, #b2Birthdate').attr('max', today); // Cannot be born in future
    $('#startDate').attr('min', today); // Coverage cannot start in past
     // REMOVED endDate handling

    // Ensure start date updates trigger relevant logic if needed later (currently none specific to removing end date)
    // $('#startDate').change(function() { ... });


});
</script>

</body>
</html>