<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claims Form Flowchart Builder</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Drawflow for flowchart functionality -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        /* Custom styles for the application and Drawflow nodes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .drawflow .drawflow-node {
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        .drawflow .drawflow-node .title-box {
            background-color: #f1f5f9; /* slate-100 */
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
        }
        .drawflow .drawflow-node .box {
            padding: 16px;
        }

        /* Custom Node Styles */
        .drawflow-node.page .title-box { background-color: #dbeafe; border-color: #bfdbfe; color: #1e40af; } /* blue-200 */
        .drawflow-node.question .title-box { background-color: #d1fae5; border-color: #a7f3d0; color: #065f46; } /* green-200 */
        .drawflow-node.condition .title-box { background-color: #fee2e2; border-color: #fecaca; color: #991b1b; } /* red-200 */

        .drawflow-node.condition .drawflow_content_node {
             width: 200px;
             height: 120px;
        }
        .drawflow-node.condition .box {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            background-color: #fef2f2; /* red-50 */
        }
        
        /* Sidebar styling */
        #details-panel {
            transition: transform 0.3s ease-in-out;
        }

        /* Material Symbols styling */
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 p-3 flex items-center justify-between shadow-sm z-20">
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-3xl text-blue-600">schema</span>
            <h1 class="text-xl font-bold text-slate-800">Claims Form Flowchart Builder</h1>
        </div>
        <div class="flex items-center gap-2">
            <label for="import-file" class="cursor-pointer bg-white border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-slate-50 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined">upload_file</span>
                Import
            </label>
            <input type="file" id="import-file" class="hidden" accept=".json">
            <button id="export-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined">download</span>
                Export
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-1 overflow-hidden">
        
        <!-- Left Toolbar -->
        <aside class="w-60 bg-white p-4 border-r border-slate-200 shadow-md flex flex-col gap-4 z-10">
            <h2 class="text-lg font-semibold text-slate-700">Add Blocks</h2>
            <p class="text-sm text-slate-500 -mt-2">Drag and drop blocks onto the canvas.</p>
            
            <div draggable="true" ondragstart="drag(event)" data-node-type="page" class="cursor-grab bg-blue-100 border-2 border-dashed border-blue-300 p-4 rounded-lg text-center text-blue-800 font-semibold hover:bg-blue-200 transition-colors">
                Page / Section
            </div>
            <div draggable="true" ondragstart="drag(event)" data-node-type="question" class="cursor-grab bg-green-100 border-2 border-dashed border-green-300 p-4 rounded-lg text-center text-green-800 font-semibold hover:bg-green-200 transition-colors">
                Question
            </div>
            <div draggable="true" ondragstart="drag(event)" data-node-type="condition" class="cursor-grab bg-red-100 border-2 border-dashed border-red-300 p-4 rounded-lg text-center text-red-800 font-semibold hover:bg-red-200 transition-colors">
                Condition
            </div>

            <div class="mt-auto p-3 bg-slate-100 rounded-lg text-sm text-slate-600">
                <h3 class="font-bold mb-2">How to use:</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>Drag blocks to the canvas.</li>
                    <li>Click a block to edit its details.</li>
                    <li>Connect blocks by dragging from the small circles.</li>
                    <li>Use Import/Export to save and load your work.</li>
                </ul>
            </div>
        </aside>

        <!-- Canvas -->
        <div id="drawflow-container" class="flex-1 relative">
            <div id="drawflow" class="w-full h-full"></div>
        </div>

        <!-- Right Details Panel -->
        <aside id="details-panel" class="w-96 bg-white p-6 border-l border-slate-200 shadow-lg z-10 transform translate-x-full absolute right-0 top-0 h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Edit Details</h2>
                 <button id="close-panel-btn" class="p-1 rounded-full hover:bg-slate-200">
                    <span class="material-symbols-outlined text-slate-600">close</span>
                </button>
            </div>
            <form id="details-form" class="space-y-4">
                <input type="hidden" id="node-id">
                
                <div>
                    <label for="node-title" class="block text-sm font-medium text-slate-700 mb-1">Title / Question Text</label>
                    <input type="text" id="node-title" class="w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="node-description" class="block text-sm font-medium text-slate-700 mb-1">Short Description</label>
                    <textarea id="node-description" rows="3" class="w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div id="question-fields" class="space-y-4 hidden">
                    <div>
                        <label for="node-field-type" class="block text-sm font-medium text-slate-700 mb-1">Field Type</label>
                        <select id="node-field-type" class="w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            <option>Text</option>
                            <option>Number</option>
                            <option>Date</option>
                            <option>Email</option>
                            <option>Dropdown</option>
                            <option>Checkbox</option>
                            <option>Radio Buttons</option>
                            <option>File Upload</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="node-accepted-values" class="block text-sm font-medium text-slate-700 mb-1">Accepted Values (comma-separated)</label>
                        <input type="text" id="node-accepted-values" placeholder="e.g. Yes, No, Maybe" class="w-full border border-slate-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="flex items-center justify-between">
                         <div class="flex items-center gap-2">
                             <input id="node-is-mandatory" type="checkbox" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                             <label for="node-is-mandatory" class="text-sm font-medium text-slate-700">Is Mandatory?</label>
                         </div>
                         <div class="flex items-center gap-2">
                             <input id="node-is-visible" type="checkbox" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                             <label for="node-is-visible" class="text-sm font-medium text-slate-700">Is Visible?</label>
                         </div>
                    </div>
                </div>
                
                <button type="button" id="delete-node-btn" class="w-full mt-4 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">delete</span>
                    Delete Node
                </button>
            </form>
        </aside>
    </main>

<script>
    // --- Drawflow setup and event handling ---
    const container = document.getElementById('drawflow');
    const editor = new Drawflow(container);
    editor.reroute = true;
    editor.start();

    // --- DOM element references ---
    const detailsPanel = document.getElementById('details-panel');
    const detailsForm = document.getElementById('details-form');
    const questionFields = document.getElementById('question-fields');
    const nodeIdInput = document.getElementById('node-id');
    const nodeTitleInput = document.getElementById('node-title');
    const nodeDescriptionInput = document.getElementById('node-description');
    const nodeFieldTypeSelect = document.getElementById('node-field-type');
    const nodeAcceptedValuesInput = document.getElementById('node-accepted-values');
    const nodeIsMandatoryCheckbox = document.getElementById('node-is-mandatory');
    const nodeIsVisibleCheckbox = document.getElementById('node-is-visible');

    // --- Initial data for the flowchart ---
    const initialData = {
        "drawflow": {
            "Home": {
                "data": {
                    "1": { "id": 1, "name": "page", "data": { "title": "Claim Start", "description": "The starting point for all claims submissions." }, "class": "page", "html": "pageNode", "typenode": false, "inputs": {}, "outputs": { "output_1": { "connections": [{ "node": "2", "output": "input_1" }] } }, "pos_x": 100, "pos_y": 150 },
                    "2": { "id": 2, "name": "question", "data": { "title": "Is this a new claim?", "description": "Determine if the user is filing a new claim or updating an existing one.", "fieldType": "Radio Buttons", "acceptedValues": "Yes, No", "isMandatory": true, "isVisible": true }, "class": "question", "html": "questionNode", "typenode": false, "inputs": { "input_1": { "connections": [{ "node": "1", "input": "output_1" }] } }, "outputs": { "output_1": { "connections": [{ "node": "3", "output": "input_1" }] }, "output_2": { "connections": [] } }, "pos_x": 450, "pos_y": 120 },
                    "3": { "id": 3, "name": "condition", "data": { "title": "Check Eligibility", "description": "Based on initial policy checks." }, "class": "condition", "html": "conditionNode", "typenode": false, "inputs": { "input_1": { "connections": [{ "node": "2", "input": "output_1" }] } }, "outputs": { "output_1": { "connections": [] }, "output_2": { "connections": [] } }, "pos_x": 800, "pos_y": 200 }
                }
            }
        }
    };
    editor.import(initialData);


    // --- Node registration ---
    const pageNodeContent = `
        <div>
            <div class="title-box">Page / Section</div>
            <div class="box">
                <p data-df-title>Page Title</p>
                <small data-df-description class="text-slate-500">Description...</small>
            </div>
        </div>`;
    editor.registerNode('pageNode', pageNodeContent, null, null);

    const questionNodeContent = `
        <div>
            <div class="title-box">Question</div>
            <div class="box">
                <p data-df-title class="font-semibold">Question Text...</p>
                <small data-df-description class="text-slate-500">Description...</small>
            </div>
        </div>`;
    editor.registerNode('questionNode', questionNodeContent, null, null);
    
    const conditionNodeContent = `
        <div>
            <div class="title-box !bg-transparent !border-none"></div>
            <div class="box !p-0">
                <p data-df-title class="font-semibold text-sm">Condition...</p>
            </div>
        </div>`;
    editor.registerNode('conditionNode', conditionNodeContent, null, null);


    // --- Functions to update UI ---
    function showDetailsPanel(nodeId) {
        const node = editor.getNodeFromId(nodeId);
        if (!node) return;

        // Populate general fields
        nodeIdInput.value = nodeId;
        nodeTitleInput.value = node.data.title || '';
        nodeDescriptionInput.value = node.data.description || '';

        // Handle specific fields for 'question' nodes
        if (node.name === 'question') {
            questionFields.classList.remove('hidden');
            nodeFieldTypeSelect.value = node.data.fieldType || 'Text';
            nodeAcceptedValuesInput.value = node.data.acceptedValues || '';
            nodeIsMandatoryCheckbox.checked = node.data.isMandatory || false;
            nodeIsVisibleCheckbox.checked = node.data.isVisible || false;
        } else {
            questionFields.classList.add('hidden');
        }

        detailsPanel.classList.remove('translate-x-full');
    }

    function hideDetailsPanel() {
        detailsPanel.classList.add('translate-x-full');
    }

    function updateNodeInEditor(nodeId) {
        const nodeData = {
            title: nodeTitleInput.value,
            description: nodeDescriptionInput.value,
        };

        const node = editor.getNodeFromId(nodeId);
        if (node.name === 'question') {
            nodeData.fieldType = nodeFieldTypeSelect.value;
            nodeData.acceptedValues = nodeAcceptedValuesInput.value;
            nodeData.isMandatory = nodeIsMandatoryCheckbox.checked;
            nodeData.isVisible = nodeIsVisibleCheckbox.checked;
        }

        editor.updateNodeDataFromId(nodeId, nodeData);
    }

    // --- Event listeners ---
    editor.on('nodeSelected', (id) => showDetailsPanel(id));
    editor.on('nodeUnselected', () => hideDetailsPanel());
    
    detailsForm.addEventListener('input', () => {
        if (nodeIdInput.value) {
            updateNodeInEditor(nodeIdInput.value);
        }
    });

    document.getElementById('close-panel-btn').addEventListener('click', () => {
        const selectedNodes = editor.getSelectedNodes();
        if (selectedNodes.length > 0) {
            // A bit of a hack to force unselection
            editor.removeReroutePoint(); // This often clears selection
        }
        hideDetailsPanel();
    });

    document.getElementById('delete-node-btn').addEventListener('click', () => {
        const nodeId = nodeIdInput.value;
        if (nodeId) {
            editor.removeNodeId(`node-${nodeId}`);
            hideDetailsPanel();
        }
    });
    
    // Import/Export functionality
    document.getElementById('export-btn').addEventListener('click', () => {
        const data = JSON.stringify(editor.export(), null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'claims-flow.json';
        a.click();
        URL.revokeObjectURL(url);
    });

    document.getElementById('import-file').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    editor.import(data);
                } catch (error) {
                    console.error("Error parsing JSON file:", error);
                    alert("Invalid JSON file.");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }
    });


    // --- Drag and Drop functionality ---
    let positionX = 0;
    let positionY = 0;

    window.drag = function(ev) {
        ev.dataTransfer.setData("node-type", ev.target.getAttribute('data-node-type'));
    }

    const drop = (ev) => {
        ev.preventDefault();
        const nodeType = ev.dataTransfer.getData("node-type");
        positionX = ev.clientX - (container.getBoundingClientRect().left);
        positionY = ev.clientY - (container.getBoundingClientRect().top);

        switch (nodeType) {
            case 'page':
                editor.addNode('page', 0, 1, positionX, positionY, 'page', { title: 'New Page', description: 'Describe this page or section.' }, 'pageNode', false);
                break;
            case 'question':
                editor.addNode('question', 1, 2, positionX, positionY, 'question', { title: 'New Question?', description: 'A short description of the question.', fieldType: 'Text', acceptedValues: '', isMandatory: true, isVisible: true }, 'questionNode', false);
                break;
            case 'condition':
                editor.addNode('condition', 1, 2, positionX, positionY, 'condition', { title: 'New Condition', description: 'e.g. Amount > 500' }, 'conditionNode', false);
                break;
        }
    }

    const allowDrop = (ev) => {
        ev.preventDefault();
    }


    container.addEventListener('drop', drop);
    container.addEventListener('dragover', allowDrop);

</script>
</body>
</html>
