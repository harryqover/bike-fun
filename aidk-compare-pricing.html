<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Pricing History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 2.375rem;
            top: 4.5rem;
            width: 2px;
            height: calc(100% - 2rem);
            background-color: #e5e7eb;
            transform: translateX(-50%);
        }
        .view-btn-active {
            background-color: #3b82f6;
            color: white;
        }
        .comparison-table th, .comparison-table td {
            padding: 0.75rem 1rem;
            text-align: right;
            white-space: nowrap;
        }
        .comparison-table th:first-child, .comparison-table td:first-child {
            text-align: left;
        }
        .metric-row td:first-child {
            padding-left: 2rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-8">
            <div class="flex flex-col xl:flex-row justify-between xl:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Policy Pricing History</h1>
                    <p id="policy-number" class="text-md text-gray-500 mt-1">Upload a policy JSON to begin.</p>
                     <div id="risk-details-container" class="mt-4 hidden">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
                            <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                <p class="text-gray-500">Vehicle</p>
                                <p id="risk-vehicle" class="font-semibold text-gray-800 truncate"></p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                <p class="text-gray-500">Vehicle Value</p>
                                <p id="risk-value" class="font-semibold text-gray-800"></p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                <p class="text-gray-500">Main Driver</p>
                                <p id="risk-driver" class="font-semibold text-gray-800 truncate"></p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                <p class="text-gray-500">Driver Age</p>
                                <p id="risk-age" class="font-semibold text-gray-800"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-4 self-start xl:self-center">
                     <div>
                        <label for="json-upload" class="cursor-pointer text-sm font-semibold py-2 px-4 rounded-md bg-white border border-gray-300 hover:bg-gray-100 transition-colors duration-200 flex items-center gap-2">
                            <i class="fa-solid fa-upload"></i>
                            Upload New Policy JSON
                        </label>
                        <input type="file" id="json-upload" class="hidden" accept=".json,application/json">
                    </div>
                    <div id="view-toggle" class="flex items-center p-1 bg-gray-200 rounded-lg">
                        <button id="timeline-view-btn" class="view-btn-active w-full sm:w-auto text-sm font-semibold py-2 px-4 rounded-md focus:outline-none transition-colors duration-200">Timeline</button>
                        <button id="comparison-view-btn" class="w-full sm:w-auto text-sm font-semibold py-2 px-4 rounded-md focus:outline-none transition-colors duration-200">Side-by-Side</button>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="hidden">
            <!-- Timeline View -->
            <div id="timeline-view" class="max-w-4xl mx-auto">
                 <div class="flex items-center p-1 bg-gray-200 rounded-lg max-w-xs mb-6">
                    <button id="contract-btn" class="view-btn-active w-full sm:w-auto text-sm font-semibold py-2 px-4 rounded-md focus:outline-none transition-colors duration-200">Contract Term</button>
                    <button id="fullterm-btn" class="w-full sm:w-auto text-sm font-semibold py-2 px-4 rounded-md focus:outline-none transition-colors duration-200">Full Term</button>
                </div>
                <div id="timeline-container"></div>
            </div>
            
            <!-- Comparison View -->
            <div id="comparison-view" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center mb-6">
                    <div>
                        <label for="version1-select" class="block text-sm font-medium text-gray-700">Compare Version</label>
                        <select id="version1-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="version2-select" class="block text-sm font-medium text-gray-700">With Version</label>
                        <select id="version2-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                </div>
                <div id="comparison-container" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"></div>
            </div>
        </main>
    </div>

    <script>
        let policyHistory = [];
        const formatCurrency = (amount, currency = 'DKK') => (amount || 0).toLocaleString('da-DK', { style: 'currency', currency });

        function extractRelevantData(data) {
            const extracted = {
                version: data.version,
                _effectivePeriod: { startDate: data._effectivePeriod?.startDate },
                package: { coverages: {} },
                policyNumber: data.policyNumber,
                currency: data.currency,
                premium: {
                    contract: { cip: data.premium?.contract?.cip, taxes: data.premium?.contract?.taxes },
                    fullTerm: { cip: data.premium?.fullTerm?.cip, taxes: data.premium?.fullTerm?.taxes },
                    delta: { cip: data.premium?.delta?.cip }
                },
                subject: {
                    make: data.subject?.make,
                    model: data.subject?.model,
                    value: data.subject?.value,
                    mainDriver: {
                        firstName: data.subject?.mainDriver?.firstName,
                        lastName: data.subject?.mainDriver?.lastName,
                        birthdate: data.subject?.mainDriver?.birthdate,
                    }
                }
            };
            if (data.package?.coverages) {
                for (const key in data.package.coverages) {
                    const cov = data.package.coverages[key].premium;
                    extracted.package.coverages[key] = {
                        premium: {
                            contract: { cip: cov?.contract?.cip, taxes: cov?.contract?.taxes },
                            fullTerm: { cip: cov?.fullTerm?.cip, taxes: cov?.fullTerm?.taxes },
                            delta: { cip: cov?.delta?.cip }
                        }
                    };
                }
            }
            return extracted;
        }
        
        function renderTimeline(pricingType = 'contract') {
             const container = document.getElementById('timeline-container'); container.innerHTML = ''; const otherPricingType = pricingType === 'contract' ? 'fullTerm' : 'contract'; const otherPricingLabel = pricingType === 'contract' ? 'Full Term' : 'Contract Term'; policyHistory.slice().reverse().forEach(version => { const isFirstVersion = version.version === 1; const delta = version.premium.delta?.cip || 0; const changeType = isFirstVersion ? 'initial' : (delta >= 0 ? 'increase' : 'decrease'); const card = document.createElement('div'); card.className = 'timeline-item relative flex items-start space-x-6 pb-8'; let breakdownHtml = ''; for (const key in version.package.coverages) { const coverage = version.package.coverages[key]; const coverageDelta = coverage.premium.delta?.cip || 0; const coverageChangeType = isFirstVersion ? 'initial' : (coverageDelta >= 0 ? 'increase' : 'decrease'); breakdownHtml += `<div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0"><span class="text-gray-600">${key}</span><div class="text-right"><span class="font-medium">${formatCurrency(coverage.premium[pricingType]?.cip, version.currency)}</span><span class="block text-xs ${coverageChangeType === 'increase' ? 'text-red-500' : 'text-green-500'}">${coverageDelta >= 0 ? '+' : '-'}${formatCurrency(Math.abs(coverageDelta), version.currency)}</span></div></div>`; } card.innerHTML = `<div class="flex-shrink-0"><div class="h-14 w-14 flex items-center justify-center rounded-full bg-white border-2 ${changeType === 'increase' ? 'border-red-500' : 'border-blue-500'}"><i class="fa-solid ${changeType === 'increase' ? 'fa-arrow-trend-up text-red-500' : 'fa-file-invoice-dollar text-blue-500'} text-xl"></i></div></div><div class="flex-1 min-w-0"><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-4 md:p-5 border-b border-gray-200"><div class="flex justify-between items-start"><div><h2 class="text-lg font-bold text-gray-800">Version ${version.version}</h2><p class="text-sm text-gray-500">Effective from: ${new Date(version._effectivePeriod.startDate).toLocaleDateString('en-GB')}</p></div><div class="text-right"><p class="text-2xl font-bold">${formatCurrency(version.premium[pricingType]?.cip, version.currency)}</p><p class="text-sm font-semibold ${changeType === 'increase' ? 'text-red-600' : 'text-green-600'}">${changeType === 'initial' ? 'Initial premium' : (delta >= 0 ? `+${formatCurrency(delta, version.currency)}` : `-${formatCurrency(Math.abs(delta), version.currency)}`)}</p><p class="text-xs text-gray-400 mt-1">${otherPricingLabel}: ${formatCurrency(version.premium[otherPricingType]?.cip, version.currency)}</p></div></div></div><div class="p-4 md:p-5 bg-gray-50/50"><h3 class="text-sm font-semibold mb-2 text-gray-700">Premium Breakdown</h3><div class="space-y-1">${breakdownHtml}</div></div></div></div>`; container.appendChild(card); });
        }
        
        function renderComparisonView() {
            const container = document.getElementById('comparison-container');
            const v1 = policyHistory.find(v => v.version == document.getElementById('version1-select').value);
            const v2 = policyHistory.find(v => v.version == document.getElementById('version2-select').value);
            if (!v1 || !v2) { container.innerHTML = '<p class="text-center text-gray-500">Please select two versions to compare.</p>'; return; }

            const renderDiff = (val1, val2) => {
                const diff = (val2 || 0) - (val1 || 0);
                const color = diff > 0 ? 'text-red-500' : diff < 0 ? 'text-green-500' : 'text-gray-500';
                const sign = diff > 0 ? '+' : '';
                return `<span class="${color}">${sign}${formatCurrency(diff, v1.currency)}</span>`;
            };

            const buildRows = (name, p1, p2) => {
                return `
                <tr class="bg-gray-100 font-bold">
                    <td>${name}</td>
                    <td>${formatCurrency(p1.contract?.cip, v1.currency)}</td>
                    <td>${formatCurrency(p1.fullTerm?.cip, v1.currency)}</td>
                    <td>${formatCurrency(p2.contract?.cip, v2.currency)}</td>
                    <td>${formatCurrency(p2.fullTerm?.cip, v2.currency)}</td>
                    <td>${renderDiff(p1.contract?.cip, p2.contract?.cip)}</td>
                    <td>${renderDiff(p1.fullTerm?.cip, p2.fullTerm?.cip)}</td>
                </tr>
                <tr class="metric-row">
                    <td>IPT</td>
                    <td>${formatCurrency(p1.contract?.taxes?.ipt, v1.currency)}</td>
                    <td>${formatCurrency(p1.fullTerm?.taxes?.ipt, v1.currency)}</td>
                    <td>${formatCurrency(p2.contract?.taxes?.ipt, v2.currency)}</td>
                    <td>${formatCurrency(p2.fullTerm?.taxes?.ipt, v2.currency)}</td>
                    <td>${renderDiff(p1.contract?.taxes?.ipt, p2.contract?.taxes?.ipt)}</td>
                    <td>${renderDiff(p1.fullTerm?.taxes?.ipt, p2.fullTerm?.taxes?.ipt)}</td>
                </tr>
                <tr class="metric-row border-b">
                    <td>Environmental</td>
                    <td>${formatCurrency(p1.contract?.taxes?.environmental, v1.currency)}</td>
                    <td>${formatCurrency(p1.fullTerm?.taxes?.environmental, v1.currency)}</td>
                    <td>${formatCurrency(p2.contract?.taxes?.environmental, v2.currency)}</td>
                    <td>${formatCurrency(p2.fullTerm?.taxes?.environmental, v2.currency)}</td>
                    <td>${renderDiff(p1.contract?.taxes?.environmental, p2.contract?.taxes?.environmental)}</td>
                    <td>${renderDiff(p1.fullTerm?.taxes?.environmental, p2.fullTerm?.taxes?.environmental)}</td>
                </tr>`;
            };

            let tableRows = buildRows('Total Premium', v1.premium, v2.premium);
            Object.keys(v1.package.coverages).forEach(key => {
                tableRows += buildRows(key, v1.package.coverages[key].premium, v2.package.coverages[key].premium);
            });

            container.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-sm comparison-table"><thead><tr class="border-b-2 border-gray-300"><th></th><th colspan="2" class="border-l border-gray-200">Version ${v1.version}</th><th colspan="2" class="border-l border-gray-200">Version ${v2.version}</th><th colspan="2" class="border-l border-gray-200">Difference (v${v2.version} - v${v1.version})</th></tr><tr class="border-b border-gray-200 bg-gray-50"><th class="font-semibold text-gray-600">Coverage / Metric</th><th class="font-semibold text-gray-600 border-l border-gray-200">Contract</th><th class="font-semibold text-gray-600">Full Term</th><th class="font-semibold text-gray-600 border-l border-gray-200">Contract</th><th class="font-semibold text-gray-600">Full Term</th><th class="font-semibold text-gray-600 border-l border-gray-200">Contract</th><th class="font-semibold text-gray-600">Full Term</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
        }

        function setupComparisonView() {
            const v1Select = document.getElementById('version1-select');
            const v2Select = document.getElementById('version2-select');
            v1Select.innerHTML = '';
            v2Select.innerHTML = '';
            policyHistory.forEach(v => {
                v1Select.innerHTML += `<option value="${v.version}">Version ${v.version}</option>`;
                v2Select.innerHTML += `<option value="${v.version}">Version ${v.version}</option>`;
            });
            if (policyHistory.length > 1) {
                v1Select.value = policyHistory[policyHistory.length - 2].version;
                v2Select.value = policyHistory[policyHistory.length - 1].version;
            } else if (policyHistory.length === 1) {
                v1Select.value = policyHistory[0].version;
                v2Select.value = policyHistory[0].version;
            }
            v1Select.addEventListener('change', renderComparisonView);
            v2Select.addEventListener('change', renderComparisonView);
            renderComparisonView();
        }

        function calculateAge(birthdateString) {
            if (!birthdateString) return 'N/A';
            const birthDate = new Date(birthdateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function renderHeaderDetails(data) {
            const container = document.getElementById('risk-details-container');
            if (!data.subject) {
                container.classList.add('hidden');
                return;
            }
            
            document.getElementById('policy-number').textContent = `Policy Number: ${data.policyNumber}`;
            document.getElementById('risk-vehicle').textContent = `${data.subject.make || ''} ${data.subject.model || ''}`.trim() || 'N/A';
            document.getElementById('risk-value').textContent = data.subject.value ? formatCurrency(data.subject.value, data.currency) : 'N/A';
            document.getElementById('risk-driver').textContent = `${data.subject.mainDriver?.firstName || ''} ${data.subject.mainDriver?.lastName || ''}`.trim() || 'N/A';
            document.getElementById('risk-age').textContent = `${calculateAge(data.subject.mainDriver?.birthdate)} years`;

            container.classList.remove('hidden');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Check if data is an array (new format) or an object (old format)
                    if (Array.isArray(data)) {
                        initializeApp(data);
                    } else {
                        // Handle old single-version format by wrapping it in an array
                        initializeApp([data]);
                    }
                } catch (error) {
                    alert('Error parsing JSON file. Please check the file format.');
                    console.error("JSON Parse Error:", error);
                }
            };
            reader.readAsText(file);
        }

        function initializeApp(versionsData) {
            if (!versionsData || versionsData.length === 0) {
                alert('JSON data is empty or invalid.');
                return;
            }
            // Sort by version ascending
            versionsData.sort((a, b) => a.version - b.version);
            
            policyHistory = versionsData.map(v => extractRelevantData(v));
            
            // Use the latest version for header details
            const latestVersionData = policyHistory[policyHistory.length - 1];

            renderHeaderDetails(latestVersionData);
            document.getElementById('main-content').classList.remove('hidden');

            renderTimeline('contract');
            setupComparisonView();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const timelineViewBtn = document.getElementById('timeline-view-btn');
            const comparisonViewBtn = document.getElementById('comparison-view-btn');
            const timelineView = document.getElementById('timeline-view');
            const comparisonView = document.getElementById('comparison-view');
            const contractBtn = document.getElementById('contract-btn');
            const fulltermBtn = document.getElementById('fullterm-btn');
            const jsonUpload = document.getElementById('json-upload');

            jsonUpload.addEventListener('change', handleFileUpload);
            
            timelineViewBtn.addEventListener('click', () => {
                timelineView.style.display = 'block';
                comparisonView.style.display = 'none';
                timelineViewBtn.classList.add('view-btn-active');
                comparisonViewBtn.classList.remove('view-btn-active');
            });
            
            comparisonViewBtn.addEventListener('click', () => {
                timelineView.style.display = 'none';
                comparisonView.style.display = 'block';
                comparisonViewBtn.classList.add('view-btn-active');
                timelineViewBtn.classList.remove('view-btn-active');
            });

            contractBtn.addEventListener('click', () => {
                renderTimeline('contract');
                contractBtn.classList.add('view-btn-active');
                fulltermBtn.classList.remove('view-btn-active');
            });

            fulltermBtn.addEventListener('click', () => {
                renderTimeline('fullTerm');
                fulltermBtn.classList.add('view-btn-active');
                contractBtn.classList.remove('view-btn-active');
            });
        });
    </script>

</body>
</html>

