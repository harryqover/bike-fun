<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Visiteur</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://harryqover.github.io/bike-fun/parking/img/180.png">
    <meta name="theme-color" content="#FFFFFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1E293B" media="(prefers-color-scheme: dark)">

    <style>
        :root {
            --primary-color: #FDB813; --primary-hover: #EAA900;
            --secondary-color: #00AEEF; --secondary-hover: #009AD5;
            --success-color: #8CC63F;
            --light-text-color: #002D42; --light-text-secondary: #5A7A8A;
            --light-bg-color: #F2F2F2; --light-card-bg: #FFFFFF; --light-border-color: #E0E0E0;
            --dark-text-color: #E2E8F0; --dark-text-secondary: #94A3B8;
            --dark-bg-color: #0F172A; --dark-card-bg: #1E293B; --dark-border-color: #334155;
            --font-family: 'Poppins', sans-serif;
        }
        body {
            --text-color: var(--light-text-color); --text-secondary: var(--light-text-secondary);
            --bg-color: var(--light-bg-color); --card-bg: var(--light-card-bg); --border-color: var(--light-border-color);
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px; transition: background-color 0.3s, color 0.3s;
        }
        body.dark-theme {
            --text-color: var(--dark-text-color); --text-secondary: var(--dark-text-secondary);
            --bg-color: var(--dark-bg-color); --card-bg: var(--dark-card-bg); --border-color: var(--dark-border-color);
        }
        .app-container { width: 100%; max-width: 420px; background-color: var(--card-bg); border-radius: 24px; box-shadow: 0 10px 30px rgba(0, 45, 66, 0.1); padding: 24px; transition: background-color 0.3s; }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header-title { display: flex; flex-direction: column; align-items: flex-start; }
        .header-title h1 { font-size: 1.5em; font-weight: 700; }
        .codes-remaining { font-size: 0.9em; font-weight: 500; color: var(--text-secondary); background-color: var(--bg-color); padding: 4px 8px; border-radius: 8px; transition: background-color 0.3s, color 0.3s; }
        .icon-btn { background: none; border: none; font-size: 1.8em; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; }
        .step { display: none; flex-direction: column; align-items: center; text-align: center; animation: fadeIn 0.5s ease-in-out; }
        .step.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        button, a.btn { display: flex; justify-content: center; align-items: center; gap: 8px; width: 100%; border: none; padding: 15px; border-radius: 12px; font-size: 1em; font-weight: 600; font-family: var(--font-family); cursor: pointer; transition: all 0.2s ease; text-decoration: none; }
        .primary-btn { background-color: var(--primary-color); color: var(--light-text-color); }
        .primary-btn:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(253, 184, 19, 0.4); }
        .primary-btn:disabled { background-color: var(--border-color); color: var(--text-secondary); cursor: not-allowed; box-shadow: none; transform: none; }
        .secondary-btn { background-color: var(--card-bg); color: var(--secondary-color); border: 2px solid var(--secondary-color); }
        .secondary-btn:hover { background-color: var(--secondary-color); color: white; }
        .button-group { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-top: 16px; }
        .history-section { margin-top: 32px; width: 100%; }
        .history-section h2 { font-size: 1.1em; font-weight: 600; text-align: left; margin-bottom: 16px; }
        #historyContainer { display: flex; flex-direction: column; gap: 12px; }
        .history-item { display: flex; align-items: center; gap: 16px; background-color: var(--card-bg); padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s; }
        .history-info { flex-grow: 1; min-width: 0; text-align: left; }
        .history-plaque { font-weight: 600; }
        .history-time, .history-code { font-size: 0.85em; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .resend-btn { background-color: var(--secondary-color); color: white !important; padding: 8px 12px; font-size: 1.2em; border-radius: 8px; flex-shrink: 0; width: auto !important; }
        .history-item.active-parking { border-left: 4px solid var(--success-color); }
        .countdown-timer { font-weight: 600; color: var(--success-color); }
        .countdown-timer .bx { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .admin-panel { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg); border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 24px; transform: translateY(100%); transition: transform 0.4s ease-in-out; z-index: 100; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); }
        .admin-panel.active { transform: translateY(0); }
        .admin-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 45, 66, 0.4); opacity: 0; visibility: hidden; transition: opacity 0.4s, visibility 0.4s; z-index: 99; }
        .overlay.active { opacity: 1; visibility: visible; }
        .admin-section { margin-top: 24px; }
        .toggle-switch { display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch label { font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 101; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); padding: 24px; border-radius: 16px; width: 90%; max-width: 380px; text-align: center; }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-content input { margin-bottom: 16px; }
    </style>
</head>
<body class="">

    <div class="app-container">
        <header class="app-header">
            <div class="header-title">
                <h1>Parking Visiteur</h1>
                <span id="codesRemaining" class="codes-remaining"></span>
            </div>
            <button id="adminToggleBtn" class="icon-btn"><i class='bx bx-cog'></i></button>
        </header>

        <main id="main-content">
            <div id="step1" class="step active">
                <button id="getCodeBtn" class="primary-btn">Obtenir un code</button>
                <div class="history-section">
                    <h2>Derniers codes utilisés</h2>
                    <div id="historyContainer"></div>
                </div>
            </div>
            <!-- Autres étapes (2 et 3) ici -->
        </main>
        <p id="statusMessage"></p>
    </div>

    <!-- Panneau Admin -->
    <div id="adminPanel" class="admin-panel">
        <div class="admin-panel-header"><h2>Options</h2><button id="closeAdminBtn" class="icon-btn"><i class='bx bx-x'></i></button></div>
        <div class="admin-panel-content">
            <div class="admin-section">
                <div class="toggle-switch">
                    <label for="dark-mode-toggle">Thème sombre</label>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <hr style="margin: 24px 0; border: 1px solid var(--border-color);">
            <!-- Onglets pour ajouter des codes -->
        </div>
    </div>
    
    <!-- Modal pour Surnom -->
    <div id="nicknameModal" class="modal">
        <div class="modal-content">
            <h2>Ajouter un surnom</h2>
            <p>Voulez-vous donner un surnom à la plaque <strong id="newPlaqueNumber"></strong> ?</p>
            <input type="text" id="nicknameInput" placeholder="Ex: Maman, Ami, etc.">
            <div class="button-group">
                <button id="saveNicknameBtn" class="primary-btn">Enregistrer</button>
                <button id="skipNicknameBtn" class="secondary-btn">Ignorer</button>
            </div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwY1AHmB52TDJTerlryEZkwK7nzDrB5YD0w94QwMY-ioyyMkWsnUG-pS0uDBrhLmDKB/exec";
        const getCodeBtn = document.getElementById('getCodeBtn');
        const statusMessage = document.getElementById('statusMessage');
        const codesRemainingEl = document.getElementById('codesRemaining');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const nicknameModal = document.getElementById('nicknameModal');
        const newPlaqueNumberEl = document.getElementById('newPlaqueNumber');
        const nicknameInput = document.getElementById('nicknameInput');
        const saveNicknameBtn = document.getElementById('saveNicknameBtn');
        const skipNicknameBtn = document.getElementById('skipNicknameBtn');
        let appData = {};
        
        // --- Thème Sombre ---
        const applyTheme = (theme) => {
            document.body.classList.toggle('dark-theme', theme === 'dark');
            darkModeToggle.checked = theme === 'dark';
        };
        darkModeToggle.addEventListener('change', () => {
            const theme = darkModeToggle.checked ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });
        applyTheme(localStorage.getItem('theme'));

        // --- Initialisation ---
        async function initializeApp() {
            statusMessage.textContent = "Chargement...";
            getCodeBtn.disabled = true;
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`Erreur serveur: ${response.status}`);
                appData = await response.json();
                statusMessage.textContent = "";
                
                codesRemainingEl.textContent = `${appData.availableCodesCount} code(s) restant(s)`;
                if (appData.error && !appData.code) {
                    getCodeBtn.textContent = "Aucun code disponible";
                } else {
                    getCodeBtn.disabled = false;
                    getCodeBtn.textContent = "Obtenir un code";
                }
                // Le reste de la logique d'initialisation (historique, etc.) va ici
            } catch (error) {
                statusMessage.textContent = "Erreur de communication.";
            }
        }

        // --- Logique des Surnoms ---
        let pendingPlaqueForNickname = null;
        function promptForNickname(plaque) {
            pendingPlaqueForNickname = plaque;
            newPlaqueNumberEl.textContent = plaque;
            nicknameModal.classList.add('active');
        }
        async function saveNickname() {
            const surnom = nicknameInput.value.trim();
            if (!surnom || !pendingPlaqueForNickname) {
                closeNicknameModal();
                return;
            }
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify({ action: 'updateNickname', plaque: pendingPlaqueForNickname, surnom: surnom }),
                });
            } catch (error) {
                console.error("Erreur saveNickname:", error);
            } finally {
                closeNicknameModal();
            }
        }
        function closeNicknameModal() {
            nicknameModal.classList.remove('active');
            nicknameInput.value = '';
            pendingPlaqueForNickname = null;
        }
        saveNicknameBtn.addEventListener('click', saveNickname);
        skipNicknameBtn.addEventListener('click', closeNicknameModal);

        // --- Logique Principale (assignation de code, etc.) ---
        async function submitParking(plaque) {
            statusMessage.textContent = "Enregistrement...";
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'assignCode', code: appData.code, plaque: plaque }),
                });
                
                const isNewPlaque = !appData.plates.some(p => p.plaque === plaque);
                if (isNewPlaque) {
                    promptForNickname(plaque);
                }
                
                // Mettre à jour l'UI (compteur, etc.)
                appData.availableCodesCount--;
                codesRemainingEl.textContent = `${appData.availableCodesCount} code(s) restant(s)`;
                // Afficher l'étape de succès...
            } catch (error) {
                statusMessage.textContent = "Erreur d'enregistrement.";
            }
        }

        // Le reste de votre logique JS (event listeners, etc.) irait ici...
        initializeApp();
    });
    </script>
</body>
</html>
