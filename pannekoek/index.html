<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>De Pannekoek</title>
    <meta name="theme-color" content="#4FD1C5"/>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Corrected path for Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon and Apple Touch Icon using the hosted logo -->
    <link rel="icon" type="image/png" href="https://harryqover.github.io/bike-fun/pannekoek/img/logo.png">
    <link rel="apple-touch-icon" href="https://harryqover.github.io/bike-fun/pannekoek/img/logo.png">

    <!-- Custom Font & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-logo { font-family: 'Pacifico', cursive; }
        :root {
            --brand-teal: #4FD1C5;
            --brand-beige: #FDF6E3;
            --brand-dark: #334155;
        }
        .bg-brand-beige { background-color: var(--brand-beige); }
        .bg-brand-teal { background-color: var(--brand-teal); }
        .text-brand-teal { color: var(--brand-teal); }
        .text-brand-dark { color: var(--brand-dark); }
        .border-brand-teal { border-color: var(--brand-teal); }
        .nav-item.active { color: var(--brand-teal); border-top-color: var(--brand-teal); }
        #notification-bell.active { color: var(--brand-teal); }
        
        .calendar-day.event-day {
            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }
        .calendar-day.today {
            font-weight: bold;
            border: 2px solid var(--brand-teal);
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-brand-beige text-brand-dark">

    <div id="app" class="pb-20">

        <!-- Header with Notification Bell -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="w-8"></div> <!-- Spacer -->
            <h1 class="font-logo text-3xl text-brand-teal">De Pannekoek</h1>
            <button id="notification-bell" class="text-gray-400 hover:text-brand-teal">
                <i class="fas fa-bell text-2xl"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="p-4">
            <!-- Page: Accueil -->
            <section id="accueil" class="page text-center">
                <img src="https://harryqover.github.io/bike-fun/pannekoek/img/logo.png" alt="Logo De Pannekoek" class="mx-auto w-64 h-64 object-contain mb-6">
                <h2 class="text-2xl font-bold mb-2">Bienvenue !</h2>
                <p>Votre guide pour un séjour parfait à La Panne.</p>
            </section>

            <!-- Page: Calendrier -->
            <section id="calendrier" class="page hidden">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
                    
                    <div class="mt-4 border-t pt-4">
                        <h3 class="font-bold text-lg mb-2 text-center">Réservations du mois</h3>
                        <div id="calendar-event-list" class="space-y-2"></div>
                    </div>

                    <div class="mt-6 text-center">
                        <button id="show-booking-form-btn" class="bg-brand-teal text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                            <i class="fas fa-plus-circle mr-2"></i> Faire une demande de réservation
                        </button>
                    </div>
                    
                    <div id="booking-form-section" class="hidden mt-4 border-t pt-4">
                        <h3 class="font-bold text-lg mb-4 text-center">Nouvelle demande</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="booking-name" class="block text-sm font-medium text-gray-700">Votre nom</label>
                                <input type="text" id="booking-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-teal focus:ring-brand-teal sm:text-sm">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="start-date" class="block text-sm font-medium text-gray-700">Date d'arrivée</label>
                                    <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-teal focus:ring-brand-teal sm:text-sm">
                                </div>
                                <div>
                                    <label for="end-date" class="block text-sm font-medium text-gray-700">Date de départ</label>
                                    <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-teal focus:ring-brand-teal sm:text-sm">
                                </div>
                            </div>
                            <button id="submit-booking" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                <i class="fas fa-paper-plane mr-2"></i> Envoyer la demande
                            </button>
                            <button id="cancel-booking" type="button" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors mt-2">Annuler</button>
                        </div>
                        <div id="booking-status" class="hidden mt-4 text-center p-4 rounded-lg"></div>
                    </div>
                </div>
            </section>

            <!-- Other pages remain the same -->
            <section id="infos" class="page hidden space-y-4"></section>
            <section id="carte" class="page hidden"></section>
            <section id="checkout" class="page hidden space-y-4"></section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg flex justify-around border-t"></nav>
    </div>

    <!-- Modal Structure -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md relative">
            <button id="modal-close" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            <h3 id="modal-title" class="text-xl font-bold text-brand-dark mb-4">Détails</h3>
            <div id="modal-body" class="text-gray-700 whitespace-pre-wrap"></div>
        </div>
    </div>

    <script>
        const VAPID_PUBLIC_KEY = 'BMUU5t9SbXFs0IMaOdEkziiOtTLl1B2nNkolM1Ml90QN_V_m6RYXGivz2xqv4vaW2qxWPwrCsI7Kx2vW4PcptGw';
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyWFPfsy4sJC8oj5_fGgFL1Qv71u6QEM_X-9CaGHR-CN2aznb11fC7gIeR2hTvM2Vky/exec';

        // --- PWA & Push Logic ---
        let swRegistration = null;
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => { swRegistration = reg; console.log('SW registered!'); initializeUI(); })
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
        const notificationBell = document.getElementById('notification-bell');
        function initializeUI() {
            notificationBell.addEventListener('click', () => { notificationBell.disabled = true; subscribeUser(); });
            swRegistration.pushManager.getSubscription().then(sub => {
                if (sub) { notificationBell.classList.add('active'); } 
                else { notificationBell.classList.remove('active'); }
            });
        }
        function subscribeUser() {
            const urlB64ToUint8Array = b64 => {
                const padding = '='.repeat((4 - b64.length % 4) % 4);
                const base64 = (b64 + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
                return outputArray;
            };
            const appServerKey = urlB64ToUint8Array(VAPID_PUBLIC_KEY);
            swRegistration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey })
                .then(sub => { console.log('User is subscribed:', sub); saveSubscription(sub); notificationBell.classList.add('active'); notificationBell.disabled = false; })
                .catch(err => { console.log('Failed to subscribe: ', err); alert("Impossible d'activer les notifications."); notificationBell.disabled = false; });
        }
        async function saveSubscription(sub) {
            try {
                await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'save-subscription', subscription: sub }) });
            } catch (error) { console.error('Error saving subscription:', error); }
        }

        // --- SPA Navigation Logic ---
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        function showPage(pageId) {
            pages.forEach(p => p.classList.toggle('hidden', p.id !== pageId));
            navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            window.scrollTo(0, 0);
        }
        document.querySelector('nav').addEventListener('click', (e) => {
            const target = e.target.closest('.nav-item');
            if (target) showPage(target.dataset.page);
        });
        
        // --- Calendar Logic ---
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearEl = document.getElementById('calendar-month-year');
        const eventListEl = document.getElementById('calendar-event-list');
        const modal = document.getElementById('event-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const bookingFormSection = document.getElementById('booking-form-section');
        const showBookingFormBtn = document.getElementById('show-booking-form-btn');
        const cancelBookingBtn = document.getElementById('cancel-booking');
        const submitBookingBtn = document.getElementById('submit-booking');

        let currentDate = new Date();
        let calendarEvents = [];

        function renderCalendar(date) {
            calendarGrid.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth();
            monthYearEl.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            ['D', 'L', 'M', 'M', 'J', 'V', 'S'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold text-xs text-gray-500';
                calendarGrid.appendChild(dayEl);
            });

            const paddingDays = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            for (let i = 0; i < paddingDays; i++) { calendarGrid.appendChild(document.createElement('div')); }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                const dayDate = new Date(year, month, day);
                dayEl.dataset.date = dayDate.toISOString().slice(0, 10);
                dayEl.className = 'calendar-day p-2';

                if (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                    dayEl.classList.add('today');
                }
                calendarGrid.appendChild(dayEl);
            }
            applyEventsToCalendar();
            renderEventList(date);
        }
        
        // Helper function to determine if a color is light or dark
        function getTextColorForBackground(hexColor) {
            if (!hexColor) return '#000000'; // Default to black
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#FFFFFF';
        }

        function applyEventsToCalendar() {
            document.querySelectorAll('.event-day').forEach(el => {
                el.classList.remove('event-day');
                el.style.backgroundColor = '';
                el.style.color = '';
                el.removeEventListener('click', handleDayClick);
            });

            if (calendarEvents.length === 0) return;
            
            calendarEvents.forEach(event => {
                let current = new Date(event.start + 'T00:00:00');
                let end = new Date(event.end + 'T00:00:00');
                
                while (current < end) {
                    const dateString = current.toISOString().slice(0, 10);
                    const dayEl = calendarGrid.querySelector(`[data-date="${dateString}"]`);
                    if (dayEl) {
                        dayEl.classList.add('event-day');
                        dayEl.style.backgroundColor = event.color || '#FEB2B2'; // Default to red if no color
                        dayEl.style.color = getTextColorForBackground(event.color || '#FEB2B2');
                        dayEl.dataset.eventId = event.id;
                        dayEl.addEventListener('click', handleDayClick);
                    }
                    current.setDate(current.getDate() + 1);
                }
            });
        }
        
        function handleDayClick(e) {
            const eventId = e.currentTarget.dataset.eventId;
            if (!eventId) return;
            const event = calendarEvents.find(ev => ev.id === eventId);
            if (event) showEventModal(event);
        }

        function showEventModal(event) {
            modalTitle.textContent = event.title;
            modalBody.textContent = event.description || "Aucune description pour cet événement.";
            modal.classList.remove('hidden');
        }

        function renderEventList(date) {
            const currentMonth = date.getMonth();
            const currentYear = date.getFullYear();

            const eventsThisMonth = calendarEvents.filter(event => {
                const start = new Date(event.start + 'T00:00:00');
                return start.getMonth() === currentMonth && start.getFullYear() === currentYear;
            }).sort((a,b) => new Date(a.start) - new Date(b.start));

            if (eventsThisMonth.length === 0) {
                eventListEl.innerHTML = '<p class="text-center text-gray-500">Aucune réservation pour ce mois.</p>';
                return;
            }

            eventListEl.innerHTML = eventsThisMonth.map(event => {
                const start = new Date(event.start + 'T00:00:00');
                const end = new Date(event.end + 'T00:00:00');
                const options = { day: 'numeric', month: 'long' };
                end.setDate(end.getDate() - 1);
                const dateString = start.getTime() === end.getTime() 
                    ? `le ${start.toLocaleDateString('fr-FR', options)}`
                    : `du ${start.toLocaleDateString('fr-FR', options)} au ${end.toLocaleDateString('fr-FR', options)}`;
                const color = event.color || '#A0AEC0';

                return `<div class="p-3 border-l-4 rounded" style="border-color: ${color}; background-color: ${color}20;">
                            <p class="font-semibold text-brand-dark">${event.title}</p>
                            <p class="text-sm text-gray-600">${dateString}</p>
                        </div>`;
            }).join('');
        }

        function fetchCalendarEvents() {
            const script = document.getElementById('jsonp-calendar-script');
            if(script) script.remove();
            const newScript = document.createElement('script');
            newScript.id = 'jsonp-calendar-script';
            newScript.src = `${GAS_WEB_APP_URL}?action=getEvents&callback=handleCalendarEventsResponse`;
            document.body.appendChild(newScript);
        }

        function handleCalendarEventsResponse(data) {
            if (data.error) { console.error("Calendar Error:", data.error); return; }
            calendarEvents = data.events;
            renderCalendar(currentDate);
        }
        
        modalClose.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

        document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); });
        document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); });

        // --- Booking Form Logic ---
        showBookingFormBtn.addEventListener('click', () => {
            bookingFormSection.classList.remove('hidden');
            showBookingFormBtn.classList.add('hidden');
        });
        cancelBookingBtn.addEventListener('click', () => {
            bookingFormSection.classList.add('hidden');
            showBookingFormBtn.classList.remove('hidden');
        });
        submitBookingBtn.addEventListener('click', async () => {
            const name = document.getElementById('booking-name').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const statusEl = document.getElementById('booking-status');

            if (!name || !startDate || !endDate) {
                alert('Veuillez remplir tous les champs.');
                return;
            }
            if (new Date(startDate) >= new Date(endDate)) {
                alert("La date de départ doit être après la date d'arrivée.");
                return;
            }

            submitBookingBtn.disabled = true;
            submitBookingBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi...';

            const payload = { action: 'createEvent', name, startDate, endDate };
            try {
                await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                statusEl.innerHTML = 'Demande envoyée avec succès ! Elle apparaîtra après validation.';
                statusEl.className = 'mt-4 text-center p-4 rounded-lg bg-green-100 text-green-800';
                statusEl.classList.remove('hidden');
                
                setTimeout(() => {
                    bookingFormSection.classList.add('hidden');
                    showBookingFormBtn.classList.remove('hidden');
                    statusEl.classList.add('hidden');
                    fetchCalendarEvents(); // Refresh calendar to show pending event
                }, 3000);

            } catch (e) {
                statusEl.innerHTML = "Une erreur est survenue.";
                statusEl.className = 'mt-4 text-center p-4 rounded-lg bg-red-100 text-red-800';
                statusEl.classList.remove('hidden');
            } finally {
                submitBookingBtn.disabled = false;
                submitBookingBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Envoyer la demande';
            }
        });

        // --- Checkout Logic ---
        // (This section is now generated dynamically, so no direct JS needed here)

        // --- Initial Load ---
        showPage('accueil');
        renderCalendar(currentDate);
        fetchCalendarEvents();
        // fetchMissingItems(); // This is called on checkout page view
    </script>
</body>
</html>