<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>De Pannekoek</title>
    <meta name="theme-color" content="#4FD1C5"/>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Corrected path for Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon and Apple Touch Icon using the hosted logo -->
    <link rel="icon" type="image/png" href="https://harryqover.github.io/bike-fun/pannekoek/img/logo.png">
    <link rel="apple-touch-icon" href="https://harryqover.github.io/bike-fun/pannekoek/img/logo.png">

    <!-- Custom Font & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-logo { font-family: 'Pacifico', cursive; }
        :root {
            --brand-teal: #4FD1C5;
            --brand-beige: #FDF6E3;
            --brand-dark: #334155;
        }
        .bg-brand-beige { background-color: var(--brand-beige); }
        .bg-brand-teal { background-color: var(--brand-teal); }
        .text-brand-teal { color: var(--brand-teal); }
        .text-brand-dark { color: var(--brand-dark); }
        .border-brand-teal { border-color: var(--brand-teal); }
        .nav-item.active { color: var(--brand-teal); border-top-color: var(--brand-teal); }
        #notification-bell.active { color: var(--brand-teal); }
        
        /* Custom Calendar Styles */
        .calendar-day.reserved {
            background-color: #FEB2B2; /* red-300 */
            color: #9B2C2C; /* red-800 */
            border-radius: 50%;
            position: relative;
        }
        .calendar-day.today {
            font-weight: bold;
            border: 2px solid var(--brand-teal);
            border-radius: 50%;
        }
        .calendar-day.other-month {
            color: #A0AEC0; /* gray-500 */
        }
    </style>
</head>
<body class="bg-brand-beige text-brand-dark">

    <div id="app" class="pb-20">

        <!-- Header with Notification Bell -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="w-8"></div> <!-- Spacer -->
            <h1 class="font-logo text-3xl text-brand-teal">De Pannekoek</h1>
            <button id="notification-bell" class="text-gray-400 hover:text-brand-teal">
                <i class="fas fa-bell text-2xl"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="p-4">
            <!-- Page: Accueil -->
            <section id="accueil" class="page text-center">
                <img src="https://harryqover.github.io/bike-fun/pannekoek/img/logo.png" alt="Logo De Pannekoek" class="mx-auto w-64 h-64 object-contain mb-6">
                <h2 class="text-2xl font-bold mb-2">Bienvenue !</h2>
                <p>Votre guide pour un séjour parfait à La Panne.</p>
            </section>

            <!-- Page: Calendrier -->
            <section id="calendrier" class="page hidden">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
                        <!-- Calendar will be rendered here -->
                    </div>
                    <div class="mt-4 text-center text-sm text-gray-600">
                        <span class="inline-block w-4 h-4 rounded-full bg-red-300 align-middle mr-2"></span> Jours réservés
                    </div>
                </div>
            </section>

            <!-- Page: Infos Pratiques -->
            <section id="infos" class="page hidden space-y-4">
                <h2 class="text-2xl font-bold mb-4 text-center">Infos Pratiques</h2>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg mb-2"><i class="fas fa-wifi text-brand-teal mr-2"></i>WiFi</h3>
                    <p><strong>Réseau :</strong> Telenet-490A2</p>
                    <p><strong>Mot de passe :</strong> pannekoek2024</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg mb-2"><i class="fas fa-trash-alt text-brand-teal mr-2"></i>Poubelles</h3>
                    <p>Achetez une carte "Drop&Go" (disponible au Delhaize) pour les points de tri. Le tri du plastique (bleu), carton (jaune) et verre est gratuit.</p>
                    <a href="https://www.depanne.be/fr/vos-dechets-dans-les-points-de-tri-dropgo" target="_blank" class="text-brand-teal hover:underline">Plus d'infos ici</a>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg mb-2"><i class="fas fa-thermometer-half text-brand-teal mr-2"></i>Thermostat</h3>
                    <p>À l'arrivée, mettez sur "horloge" (env. 22°C). Au départ, mettez sur "hors gel" (flocon de neige ❄️).</p>
                </div>
                 <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg mb-2"><i class="fas fa-parking text-brand-teal mr-2"></i>Parking</h3>
                    <p>Le parking est au -2 (entrée de gauche). Les 4 emplacements du fond sont pour vous.</p>
                </div>
                 <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg mb-2"><i class="fas fa-key text-brand-teal mr-2"></i>Clés & Porte</h3>
                    <p>L'appartement est au 2ème étage, n°203. <strong class="text-red-500">Attention, la porte se verrouille automatiquement !</strong> Gardez toujours une clé sur vous.</p>
                </div>
            </section>

            <!-- Page: Carte -->
            <section id="carte" class="page hidden">
                 <h2 class="text-2xl font-bold mb-4 text-center">Points d'intérêt</h2>
                 <div class="aspect-w-16 aspect-h-9 bg-white rounded-lg shadow-md overflow-hidden">
                    <iframe 
                        width="100%" 
                        height="600" 
                        frameborder="0" 
                        scrolling="no" 
                        marginheight="0" 
                        marginwidth="0" 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2508.816912384666!2d2.58662231575276!3d51.07917997956708!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x47dc8c102934a171%3A0x33449b5bf52f05e9!2sResidentie%20Aurora!5e0!3m2!1sfr!2sbe!4v1662470011234!5m2!1sfr!2sbe">
                    </iframe>
                 </div>
                 <div class="mt-4 bg-white p-4 rounded-lg shadow-md">
                     <h3 class="font-bold text-lg mb-2">Nos Recommandations</h3>
                     <ul>
                         <li class="mb-2"><i class="fas fa-utensils text-brand-teal mr-2"></i><strong>Restaurants:</strong> Le Léopold, Chez Soi</li>
                         <li><i class="fas fa-cookie-bite text-brand-teal mr-2"></i><strong>Boulangerie:</strong> Bakkerij De Westhoek</li>
                     </ul>
                 </div>
            </section>

            <!-- Page: Checkout -->
            <section id="checkout" class="page hidden space-y-4">
                <h2 class="text-2xl font-bold mb-4 text-center">Checklist de Départ</h2>
                
                <div id="checkout-form" class="bg-white p-4 rounded-lg shadow-md space-y-4">
                    <div class="space-y-3" id="checklist-items">
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Vider les poubelles et sacs de tri">Vider les poubelles et sacs de tri</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Vider et nettoyer le frigo">Vider et nettoyer le frigo</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Passer l'aspirateur">Passer l'aspirateur</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Nettoyer les surfaces">Nettoyer les surfaces</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Descendre tous les stores">Descendre tous les stores</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Vérifier pare-soleil replié">Vérifier que le pare-soleil est replié</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Fermer toutes les fenêtres">Fermer toutes les fenêtres</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Éteindre les lumières">Éteindre les lumières et appareils</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Thermostat en mode hors gel">Mettre le thermostat en mode "hors gel"</label>
                        <label class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-brand-teal focus:ring-brand-teal mr-3" data-task="Ranger le double des clés">Ranger le double des clés</label>
                    </div>
                    <hr>
                    <div>
                        <label for="checkout-name" class="block text-sm font-medium text-gray-700">Checkout fait par :</label>
                        <input type="text" id="checkout-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-teal focus:ring-brand-teal sm:text-sm" placeholder="Votre nom">
                    </div>
                    <div>
                        <label for="missing-items" class="block text-sm font-medium text-gray-700">Signaler un problème ou un article manquant ?</label>
                        <textarea id="missing-items" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-teal focus:ring-brand-teal sm:text-sm" placeholder="Ex: Il n'y a plus de papier toilette, une ampoule est grillée..."></textarea>
                    </div>
                    <button id="submit-checkout" class="w-full bg-brand-teal text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors flex items-center justify-center">
                        <i class="fas fa-check-circle mr-2"></i> Envoyer le Checkout
                    </button>
                </div>

                <div id="checkout-status" class="hidden text-center p-4 bg-green-100 text-green-800 rounded-lg"></div>

                <div class="bg-white p-4 rounded-lg shadow-md">
                     <h3 class="font-bold text-lg mb-2"><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Problèmes signalés récemment</h3>
                     <div id="missing-items-list" class="text-sm text-gray-600">
                        <p>Chargement...</p>
                     </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg flex justify-around border-t">
            <button data-page="accueil" class="nav-item w-full pt-2 pb-1 text-center text-gray-500 border-t-2 border-transparent active">
                <i class="fas fa-home text-xl"></i><span class="block text-xs">Accueil</span>
            </button>
            <button data-page="calendrier" class="nav-item w-full pt-2 pb-1 text-center text-gray-500 border-t-2 border-transparent">
                <i class="fas fa-calendar-alt text-xl"></i><span class="block text-xs">Dispos</span>
            </button>
            <button data-page="infos" class="nav-item w-full pt-2 pb-1 text-center text-gray-500 border-t-2 border-transparent">
                <i class="fas fa-info-circle text-xl"></i><span class="block text-xs">Infos</span>
            </button>
            <button data-page="carte" class="nav-item w-full pt-2 pb-1 text-center text-gray-500 border-t-2 border-transparent">
                <i class="fas fa-map-marked-alt text-xl"></i><span class="block text-xs">Carte</span>
            </button>
             <button data-page="checkout" class="nav-item w-full pt-2 pb-1 text-center text-gray-500 border-t-2 border-transparent">
                <i class="fas fa-clipboard-check text-xl"></i><span class="block text-xs">Checkout</span>
            </button>
        </nav>
    </div>

    <script>
        const VAPID_PUBLIC_KEY = 'BMUU5t9SbXFs0IMaOdEkziiOtTLl1B2nNkolM1Ml90QN_V_m6RYXGivz2xqv4vaW2qxWPwrCsI7Kx2vW4PcptGw';
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyWFPfsy4sJC8oj5_fGgFL1Qv71u6QEM_X-9CaGHR-CN2aznb11fC7gIeR2hTvM2Vky/exec';

        // --- PWA & Push Logic ---
        let swRegistration = null;

        if ('serviceWorker' in navigator && 'PushManager' in window) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        swRegistration = registration;
                        console.log('Service Worker registered!');
                        initializeUI();
                    })
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }

        const notificationBell = document.getElementById('notification-bell');
        
        function initializeUI() {
            notificationBell.addEventListener('click', () => {
                notificationBell.disabled = true;
                subscribeUser();
            });

            swRegistration.pushManager.getSubscription()
                .then(subscription => {
                    const isSubscribed = !(subscription === null);
                    if (isSubscribed) {
                        notificationBell.classList.add('active');
                    } else {
                        notificationBell.classList.remove('active');
                    }
                });
        }

        function subscribeUser() {
            const urlB64ToUint8Array = base64String => {
                const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            };

            const applicationServerKey = urlB64ToUint8Array(VAPID_PUBLIC_KEY);
            swRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: applicationServerKey
            })
            .then(subscription => {
                console.log('User is subscribed:', subscription);
                saveSubscription(subscription);
                notificationBell.classList.add('active');
                notificationBell.disabled = false;
            })
            .catch(err => {
                console.log('Failed to subscribe the user: ', err);
                alert("Impossible d'activer les notifications. Avez-vous bloqué les permissions pour ce site ?");
                notificationBell.disabled = false;
            });
        }

        async function saveSubscription(subscription) {
            const payload = {
                action: 'save-subscription',
                subscription: subscription
            };
            try {
                await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                console.log('Subscription saved on backend.');
            } catch (error) {
                console.error('Error saving subscription:', error);
            }
        }

        // --- SPA Navigation Logic ---
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');

        function showPage(pageId) {
            pages.forEach(page => page.classList.toggle('hidden', page.id !== pageId));
            navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            window.scrollTo(0, 0);
        }

        navItems.forEach(item => item.addEventListener('click', () => showPage(item.dataset.page)));
        
        // --- Calendar Logic ---
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearEl = document.getElementById('calendar-month-year');
        let currentDate = new Date();
        let calendarEvents = [];

        function renderCalendar(date) {
            calendarGrid.innerHTML = ''; // Clear previous month
            const year = date.getFullYear();
            const month = date.getMonth();

            monthYearEl.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            ['D', 'L', 'M', 'M', 'J', 'V', 'S'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'font-bold text-xs text-gray-500';
                calendarGrid.appendChild(dayEl);
            });

            const paddingDays = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            for (let i = 0; i < paddingDays; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                const dayDate = new Date(year, month, day);
                dayEl.dataset.date = dayDate.toISOString().slice(0, 10);
                dayEl.className = 'calendar-day p-2 cursor-default';

                if (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                    dayEl.classList.add('today');
                }
                calendarGrid.appendChild(dayEl);
            }
            
            applyEventsToCalendar();
        }

        function applyEventsToCalendar() {
            if (calendarEvents.length === 0) return;
            
            calendarEvents.forEach(event => {
                let current = new Date(event.start + 'T00:00:00');
                let end = new Date(event.end + 'T00:00:00');

                while (current < end) {
                    const dateString = current.toISOString().slice(0, 10);
                    const dayEl = calendarGrid.querySelector(`[data-date="${dateString}"]`);
                    if (dayEl) {
                        dayEl.classList.add('reserved');
                    }
                    current.setDate(current.getDate() + 1);
                }
            });
        }

        function fetchCalendarEvents() {
            const script = document.createElement('script');
            script.id = 'jsonp-calendar-script';
            script.src = `${GAS_WEB_APP_URL}?action=getEvents&callback=handleCalendarEventsResponse`;
            document.body.appendChild(script);
        }

        function handleCalendarEventsResponse(data) {
            if (data.error) {
                console.error("Calendar Error:", data.error);
                return;
            }
            calendarEvents = data.events;
            applyEventsToCalendar();
        }

        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });

        // --- Checkout Logic ---
        const submitButton = document.getElementById('submit-checkout');
        const checkoutName = document.getElementById('checkout-name');
        const missingItemsText = document.getElementById('missing-items');
        const checklistItems = document.querySelectorAll('#checklist-items input[type=checkbox]');
        const statusDiv = document.getElementById('checkout-status');
        const missingItemsListDiv = document.getElementById('missing-items-list');

        function handleMissingItemsResponse(data) {
            if (data.error) {
                console.error("Error from Google Script:", data.error);
                missingItemsListDiv.innerHTML = '<p class="text-red-500">Erreur lors du chargement des problèmes signalés.</p>';
                return;
            }

            if (data.items && data.items.length > 0) {
                let html = '<div class="space-y-3">';
                data.items.forEach(item => {
                    html += `
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="font-semibold text-gray-800">${item.issue}</p>
                            <p class="text-xs text-gray-500 mt-1">Signalé par ${item.name || 'Anonyme'} le ${item.date}</p>
                        </div>
                    `;
                });
                html += '</div>';
                missingItemsListDiv.innerHTML = html;
            } else {
                missingItemsListDiv.innerHTML = '<p class="text-green-700">Aucun problème signalé récemment. Tout est en ordre !</p>';
            }
        }

        function fetchMissingItems() {
            const oldScript = document.getElementById('jsonp-script');
            if (oldScript) oldScript.remove();
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = `${GAS_WEB_APP_URL}?callback=handleMissingItemsResponse`;
            document.body.appendChild(script);
        }

        submitButton.addEventListener('click', async () => {
            if (checkoutName.value.trim() === '') {
                alert('Veuillez indiquer votre nom.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi en cours...';

            const checklistData = {};
            checklistItems.forEach(item => {
                checklistData[item.dataset.task] = item.checked;
            });

            const payload = {
                name: checkoutName.value.trim(),
                missingItem: missingItemsText.value.trim(),
                checklist: checklistData
            };

            try {
                await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                statusDiv.innerHTML = 'Merci ! Votre checklist a bien été enregistrée.';
                statusDiv.classList.remove('hidden');
                document.getElementById('checkout-form').classList.add('hidden');
                
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                    document.getElementById('checkout-form').classList.remove('hidden');
                    checkoutName.value = '';
                    missingItemsText.value = '';
                    checklistItems.forEach(item => item.checked = false);
                    fetchMissingItems();
                }, 4000);

            } catch (error) {
                console.error('Error submitting checkout:', error);
                alert('Une erreur est survenue. Veuillez réessayer.');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Envoyer le Checkout';
            }
        });

        // --- Initial Load ---
        showPage('accueil');
        renderCalendar(currentDate);
        fetchCalendarEvents();
        fetchMissingItems();
        document.querySelector('button[data-page="checkout"]').addEventListener('click', fetchMissingItems);
    </script>
</body>
</html>
